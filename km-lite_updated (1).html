<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>km-lite â€” RECAP 20ê°œêµ­ + TF-IDF ìš”ì•½ + HDP% + C1~C15 ë¶„ë¥˜</title>
<style>
:root{--bg:#0b0f14;--fg:#e6eef8;--mut:#8aa0bb;--line:#253245}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:16px}
h2{margin:0 0 12px}
textarea,input,button{border-radius:8px;padding:.45rem .6rem;font-size:14px;border:1px solid var(--line);background:#0f1620;color:var(--fg)}
button{cursor:pointer}
.small{color:var(--mut);font-size:12px}
.mono{font-family:ui-monospace,Consolas,Menlo,monospace}
.err{color:#ffb4b4}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.card{border:1px solid var(--line);border-radius:8px;padding:8px;margin-bottom:8px}
#rw-results{margin-top:12px;max-height:60vh;overflow:auto;border:1px solid var(--line);padding:.6rem;border-radius:8px}
table{border-collapse:collapse;width:100%;font-size:13px}
td,th{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.stickybar{position:sticky;top:8px;z-index:5;background:var(--bg);border:1px solid var(--line);border-radius:10px;padding:8px;margin:10px 0}
.badge{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:var(--mut);margin-right:4px;margin-bottom:2px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;align-items:center;justify-content:center}
.modal>div{background:var(--bg);color:var(--fg);border:1px solid var(--line);border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.5)}
#summary-box{width:80%;max-width:720px;max-height:80%;overflow:auto;padding:20px}
#country-box{width:min(780px,92vw);max-height:80%;overflow:auto;padding:16px}
.country-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-top:8px}
.hbar{height:8px;border-radius:4px;background:#142030;overflow:hidden}
.hbar>span{display:block;height:100%}
.hcol-H{background:#3aa3ff}.hcol-D{background:#61d661}.hcol-P{background:#f2b45a}
</style>
</head>
<body>
<h2>RECAP ê²½ëŸ‰ ì§€ì‹ê´€ë¦¬ì²´ê³„ (20ê°œêµ­ ìë™ìˆ˜ì§‘ Â· TF-IDF ìš”ì•½ Â· HDP% Â· C1~C15)</h2>
<p class="small">ë¡œì»¬ ì„œë²„ì—ì„œ ì—¬ì„¸ìš”(ì˜ˆ: <span class="mono">py -m http.server 8000</span>). ì €ì¥ ì‹œ ìš”ì•½Â·HDPÂ·ë¶„ë¥˜(C1~C15)ê°€ <span class="mono">localStorage</span>ì— ì €ì¥ë©ë‹ˆë‹¤.</p>

<label>ëŒ€ìƒêµ­(ì°¸ê³ ìš©)</label><br/>
<textarea rows="3" style="width:100%" readonly>
Burundi, Central African Republic, Comoros, Guinea, Kenya, Mali, Sao Tome and Principe, Somalia, South Sudan, Zimbabwe, Armenia, Iran, Jordan, Lebanon, Palestine, Syria, Yemen, Papua New Guinea, Solomon Islands, Timor-Leste
</textarea>
<br/><br/>

<div class="flex">
  <label>ìµœê·¼ ì¼ìˆ˜</label><input id="rw-days" type="number" value="365" style="width:100px"/>
  <label>ìµœëŒ€ ê°œìˆ˜</label><input id="rw-limit" type="number" value="300" style="width:100px"/>
  <button id="open-country" title="êµ­ê°€ í•„í„°">êµ­ê°€ í•„í„°</button>
  <span id="country-chip" class="badge">ì „ì²´ 20ê°œêµ­</span>
  <button id="rw-fetch">ê°€ì ¸ì˜¤ê¸°</button>
  <span id="rw-status" class="small"></span>
</div>

<div id="savebar" class="stickybar flex" style="justify-content:space-between">
  <div class="small">ì²´í¬ í›„ ì €ì¥í•˜ë©´ í•˜ë‹¨ íŒ¨ë„ì— ëˆ„ì ë©ë‹ˆë‹¤.</div>
  <div><button id="rw-to-notes">ì„ íƒ í•­ëª© ë…¸íŠ¸ë¡œ ì €ì¥(ìš”ì•½ í¬í•¨)</button></div>
</div>

<div id="rw-results"></div>

<hr/>
<div id="notes-panel">
  <div class="flex">
    <strong>ì €ì¥ëœ ë…¸íŠ¸/ìš”ì•½</strong>
    <input id="notes-q" placeholder="ê²€ìƒ‰(ì œëª©Â·ìš”ì•½Â·êµ­ê°€Â·ë¶„ë¥˜ì½”ë“œ)" style="flex:1;min-width:180px"/>
    <button id="notes-refresh">ìƒˆë¡œê³ ì¹¨</button>
    <button id="notes-clear" title="ëª¨ë“  ë…¸íŠ¸ ì‚­ì œ">ì „ì²´ì‚­ì œ</button>
  </div>
  <div id="notes-list" class="small" style="margin-top:8px"></div>
</div>

<!-- ìš”ì•½ ëª¨ë‹¬ -->
<div id="summary-modal" class="modal">
  <div id="summary-box">
    <div id="summary-title" style="font-weight:bold;font-size:18px;margin-bottom:12px;"></div>
    <div class="small" id="summary-meta" style="margin-bottom:6px"></div>
    <div id="summary-hdp" style="margin:8px 0"></div>
    <div id="summary-content" style="font-size:14px;line-height:1.6;"></div>
    <div style="margin-top:16px;text-align:right"><button id="summary-close">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- êµ­ê°€ ëª¨ë‹¬ -->
<div id="country-modal" class="modal">
  <div id="country-box">
    <div class="flex" style="justify-content:space-between">
      <strong>êµ­ê°€ í•„í„° ì„ íƒ (ë‹¤ì¤‘)</strong>
      <div class="small">ì²´í¬ í›„ ì ìš© â†’ ê°€ì ¸ì˜¤ê¸°</div>
    </div>
    <div class="country-grid" id="country-grid"></div>
    <div class="flex" style="justify-content:flex-end;margin-top:10px">
      <button id="country-clear">ì´ˆê¸°í™”</button>
      <button id="country-apply">ì ìš©</button>
      <button id="country-close">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
// ì „ì—­ ì˜¤ë¥˜ â†’ ìƒíƒœì°½
window.addEventListener('error', function(e){
  var st=document.getElementById('rw-status');
  if(st) st.textContent='ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: '+e.message;
});

// ìƒìˆ˜
var RECAP_NAMES=['Burundi','Central African Republic','Comoros','Guinea','Kenya','Mali','Sao Tome and Principe','Somalia','South Sudan','Zimbabwe','Armenia','Iran','Jordan','Lebanon','Palestine','Syria','Yemen','Papua New Guinea','Solomon Islands','Timor-Leste'];
var RECAP_ISO3 =['BDI','CAF','COM','GIN','KEN','MLI','STP','SOM','SSD','ZWE','ARM','IRN','JOR','LBN','PSE','SYR','YEM','PNG','SLB','TLS'];
var RECAP_MAP  =RECAP_NAMES.map(function(n,i){return {name:n,iso3:RECAP_ISO3[i]};});
var DB_KEY='km-lite-db';

// êµ­ê°€ íŒì—…
var pickedISO3=[];
function openCountryModal(){
  var grid=document.getElementById('country-grid');
  var html='';
  for(var i=0;i<RECAP_MAP.length;i++){
    var d=RECAP_MAP[i];
    html+= '<label style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:8px;padding:6px 8px">'
         +   '<input type="checkbox" value="'+d.iso3+'" '+(pickedISO3.indexOf(d.iso3)>=0?'checked':'')+'>'
         +   '<span>'+d.name+' <span class="badge">'+d.iso3+'</span></span>'
         + '</label>';
  }
  grid.innerHTML=html;
  document.getElementById('country-modal').style.display='flex';
}
function closeCountryModal(){ document.getElementById('country-modal').style.display='none'; }
document.getElementById('open-country').onclick=openCountryModal;
document.getElementById('country-close').onclick=closeCountryModal;
document.getElementById('country-clear').onclick=function(){
  pickedISO3=[]; document.getElementById('country-chip').textContent='ì „ì²´ 20ê°œêµ­'; closeCountryModal();
};
document.getElementById('country-apply').onclick=function(){
  var boxes=document.querySelectorAll('#country-grid input:checked');
  pickedISO3=[].map.call(boxes,function(x){return x.value;});
  document.getElementById('country-chip').textContent=pickedISO3.length? (pickedISO3.length+'ê°œêµ­ ì„ íƒ') : 'ì „ì²´ 20ê°œêµ­';
  closeCountryModal();
};

// ìš”ì•½(TF-IDF)
function summarizeText(text,maxSentences){
  maxSentences = maxSentences||5;
  if(!text) return '';
  var sents=text.split(/(?<=[.!?ã€‚ï¼ï¼Ÿ])\s+|[\r\n]{2,}/).map(function(s){return s.trim();}).filter(function(s){return s.length>20;});
  if(sents.length===0) return '';
  if(sents.length<=maxSentences) return sents.join(' ');
  function tokenize(s){return s.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,' ').split(/\s+/).filter(Boolean);}
  var stop=new Set(['the','and','for','with','that','this','from','are','was','were','have','has','had','of','in','to','on','by','as','is','be','or','at','an','a','it','its','their','our','we','you','they','into','over','under','between','within','through','about','after','before','during','against','among','per','ë°','ê·¸ë¦¬ê³ ','ê·¸ëŸ¬ë‚˜','ë˜ëŠ”','ì—ì„œ','ìœ¼ë¡œ','ì—ëŠ”','ì—','ë¥¼','ì„','ì´','ê°€','ì€','ëŠ”','ì™€','ê³¼','í•˜ë‹¤','í–ˆë‹¤','ëŒ€í•œ','ìœ„í•œ']);
  var tf={},df={},sentTokens=[];
  for(var i=0;i<sents.length;i++){
    var ws=tokenize(sents[i]).filter(function(w){return !stop.has(w);});
    sentTokens.push(ws);
    var seen={};
    for(var j=0;j<ws.length;j++){
      var w=ws[j]; tf[w]=(tf[w]||0)+1; if(!seen[w]){df[w]=(df[w]||0)+1; seen[w]=1;}
    }
  }
  var N=sents.length;
  var scored=[];
  for(var k=0;k<sents.length;k++){
    var sc=0, ws2=sentTokens[k];
    for(var j2=0;j2<ws2.length;j2++){
      var ww=ws2[j2];
      var idf=Math.log((N+1)/((df[ww]||1)+1));
      sc+=(tf[ww]||0)*idf;
    }
    var len=sents[k].length; var lenAdj=(len<40?0.85:(len>300?0.9:1));
    scored.push({i:k,score:sc*lenAdj});
  }
  scored.sort(function(a,b){return b.score-a.score;});
  scored=scored.slice(0,maxSentences).sort(function(a,b){return a.i-b.i;});
  return scored.map(function(x){return sents[x.i];}).join(' ');
}

// HDP ì ìˆ˜
var HDP_DICT={
  H:['emergency','relief','response','humanitarian','displacement','refugee','cholera','outbreak','famine','flood','earthquake','evacuation','cash assistance','wash cluster','rapid'],
  D:['development','infrastructure','education','school','clinic','health system','primary care','livelihoods','capacity building','policy','programme','investment','training','supply chain','renewable','solar','water supply','monitoring','m&e'],
  P:['peace','cohesion','conflict','mediation','grievance','inclusive','social contract','community committee','youth','women participation','accountability','complaints','do no harm']
};

function hdpFlags(text){
  var T=(text||'').toLowerCase();
  function hit(arr){return arr.some(w=>T.includes(w));}
  var H=hit(HDP_DICT.H);
  var D=hit(HDP_DICT.D);
  var P=hit(HDP_DICT.P);
  var nexus=(H && D) || (H && D && P);
  return {H:H?'H':'',D:D?'D':'',P:P?'P':'',nexus:nexus?'Y':'N'};
}
 return s;}
  var H=hit(HDP_DICT.H), D=hit(HDP_DICT.D), P=hit(HDP_DICT.P);
  if(H+D+P===0) return {H:0,D:100,P:0,label:'D 100%'};
  var sum=H+D+P; H=Math.round(H/sum*100); D=Math.round(D/sum*100); P=100-H-D;
  return {H:H,D:D,P:P,label:'H '+H+'% / D '+D+'% / P '+P+'%'};
}
function hbarHTML(score){
  var s=(score&&typeof score==='object'&&isFinite(score.H)&&isFinite(score.D)&&isFinite(score.P))?score:{H:0,D:100,P:0,label:(score&&score.label)?score.label:'D 100%'};
  var H=Math.max(0,Math.min(100,s.H));
  var D=Math.max(0,Math.min(100,s.D));
  var P=Math.max(0,Math.min(100,s.P));
  var label=s.label||('H '+s.H+'% / D '+s.D+'% / P '+s.P+'%');
  return ''+
    '<div class="hbar">'+
      '<span class="hcol-H" style="width:'+H+'%;"></span>'+
      '<span class="hcol-D" style="width:'+D+'%;"></span>'+
      '<span class="hcol-P" style="width:'+P+'%;"></span>'+
    '</div>'+
    '<div class="small">'+label+'</div>';
}

// C1~C15 ê·œì¹™ ë¶„ë¥˜
var CODES={
  C1:{name:'ì‚¬ì—…Â·í”„ë¡œì íŠ¸ ê°œìš” & ë°°ê²½',kw:['background','context','objective','overview','rationale','fragile','fcv','situation analysis','needs assessment','ë°°ê²½','ëª©í‘œ','ë§¥ë½','í˜„í™©']},
  C2:{name:'ì´í•´ê´€ê³„ì ë¶„ì„',kw:['stakeholder','beneficiary','local government','ngo','civil society','private sector','partner','coordination','ê±°ë²„ë„ŒìŠ¤','ìˆ˜í˜œì','ì°¸ì—¬ê¸°ê´€']},
  C3:{name:'ë…¼ë¦¬ëª¨í˜• & ì„±ê³¼ê²½ë¡œ (ToC)',kw:['theory of change','results chain','logic model','inputs','outputs','outcomes','impact pathway','ì„±ê³¼ê²½ë¡œ','ë…¼ë¦¬ëª¨í˜•']},
  C4:{name:'ì‹¤í–‰ ë° ìš´ì˜ê´€ë¦¬',kw:['implementation','operations','workplan','sop','risk management','procurement','governance structure','í˜„ì¥ ê´€ë¦¬','ìš´ì˜','ì§‘í–‰']},
  C5:{name:'ëª¨ë‹ˆí„°ë§ & í‰ê°€ ì²´ê³„',kw:['monitoring','evaluation','m&e','indicator','baseline','midterm','final evaluation','ë°ì´í„° ìˆ˜ì§‘','ì§€í‘œ','í‰ê°€']},
  C6:{name:'ì„±ê³¼ (Outputs & Outcomes)',kw:['output','deliverable','milestone','outcome','result','ì„±ê³¼','ì‚°ì¶œ']},
  C7:{name:'ì˜í–¥ (Impact)',kw:['impact','long-term change','institutional change','ì§€ì†ì  ë³€í™”','ì œë„ ë³€í™”','ì¥ê¸° íš¨ê³¼']},
  C8:{name:'ì§€ì†ê°€ëŠ¥ì„± & í™•ì‚° ê°€ëŠ¥ì„±',kw:['sustainability','scalability','institutionalization','handover','exit strategy','ì§€ì†ê°€ëŠ¥ì„±','í™•ì‚°']},
  C9:{name:'ë¹„ìš©íš¨ìœ¨ì„± & ìì›íˆ¬ì…',kw:['cost-effectiveness','efficiency','value for money','budget','resource allocation','ë¹„ìš©','ì˜ˆì‚°','ìì›ë°°ë¶„']},
  C10:{name:'ë¦¬ìŠ¤í¬ & ì ì‘ì„±',kw:['risk','mitigation','contingency','adaptation','pivot','conflict sensitivity','ë¦¬ìŠ¤í¬','ì ì‘']},
  C11:{name:'ì  ë” / ë‚˜ì´ / í¬ìš©ì„±',kw:['gender','women','girl','youth','elderly','disability','inclusion','gbv','ì„±í‰ë“±','í¬ìš©']},
  C12:{name:'ê±°ë²„ë„ŒìŠ¤ / ì±…ì„ì„± / íˆ¬ëª…ì„±',kw:['governance','accountability','transparency','complaints','grm','participatory','ì±…ì„ì„±','íˆ¬ëª…ì„±']},
  C13:{name:'í™˜ê²½ ë° ê¸°í›„ ë¯¼ê°ì„±',kw:['climate','environment','adaptation','mitigation','resilience','emission','ê¸°í›„','í™˜ê²½']},
  C14:{name:'êµí›ˆ & í™•ì‚° ê°€ëŠ¥í•œ ëª¨í˜•',kw:['lesson learned','lessons learned','good practice','case study','replication','scaling','êµí›ˆ','ìš°ìˆ˜ì‚¬ë¡€']},
  C15:{name:'í•œê³„ ë° ê¶Œê³ ì‚¬í•­',kw:['limitation','constraint','challenge','recommendation','policy recommendation','í•œê³„','ê¶Œê³ ']}
};
function classifyC15(text,topN){
  topN=topN||3;
  var T=(text||'').toLowerCase();
  var score={}, ranked=[], k, cfg;
  for(k in CODES){
    cfg=CODES[k];
    var s=0; for(var i=0;i<cfg.kw.length;i++){ if(T.indexOf(cfg.kw[i].toLowerCase())>=0) s++; }
    score[k]=s;
  }
  for(k in score){ if(score[k]>0) ranked.push({code:k,name:CODES[k].name,s:score[k]}); }
  ranked.sort(function(a,b){return b.s-a.s;});
  return ranked.slice(0,topN);
}
function renderC15Badges(arr){
  if(!arr||!arr.length) return '<span class="small" style="color:#8698b0">â€”</span>';
  return arr.map(function(x){return '<span class="badge" title="'+x.name+'">'+x.code+'</span>';}).join(' ');
}

// DB/ë…¸íŠ¸
function getDB(){return JSON.parse(localStorage.getItem(DB_KEY)||'{"notes":[]}');}
function setDB(db){localStorage.setItem(DB_KEY,JSON.stringify(db));}
function migrateNotesIfNeeded(){
  try{
    var db=getDB(), changed=false;
    db.notes=(db.notes||[]).map(function(n){
      if(!n.hdp||!isFinite(n.hdp&&n.hdp.H)){
        var t=[n.title,n.summary,n.body].filter(Boolean).join(' ');
        var sc=hdpScore(t); n.hdp=sc; n.hdpLabel=sc.label; changed=true;
      }
      if(!n.hdpLabel){ n.hdpLabel='H '+n.hdp.H+'% / D '+n.hdp.D+'% / P '+n.hdp.P+'%'; changed=true; }
      if(!n.c15||!n.c15.length){
        var t2=[n.title,n.summary,n.body].filter(Boolean).join(' ');
        n.c15=classifyC15(t2,3); changed=true;
      }
      return n;
    });
    if(changed) setDB(db);
  }catch(e){ console.warn('migrateNotesIfNeeded failed:',e); }
}
function renderNotes(filter){
  filter=(filter||'').toLowerCase();
  var box=document.getElementById('notes-list');
  var db=getDB();
  if(!db.notes.length){ box.innerHTML='<div class="small">ì €ì¥ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  var html='';
  db.notes.forEach(function(n){
    var hay=[n.title,n.summary,n.country,n.hdpLabel].concat((n.c15||[]).map(function(x){return x.code+' '+x.name;})).join(' ').toLowerCase();
    if(filter && hay.indexOf(filter)<0) return;
    html+= '<div class="card">'
         +   '<div class="flex" style="justify-content:space-between">'
         +     '<div><strong>'+n.title+'</strong></div>'
         +     '<div class="small mono">'+new Date(n.created).toISOString().slice(0,10)+'</div>'
         +   '</div>'
         +   '<div class="small" style="margin:6px 0"><em>'+(n.country||'')+'</em> Â· <span class="badge">'+(n.hdpLabel||'')+'</span></div>'
         +   '<div style="margin:6px 0">'+hbarHTML(n.hdp)+'</div>'
         +   '<div class="small" style="margin:4px 0">'+renderC15Badges(n.c15)+'</div>'
         +   '<div>'+(n.summary||'<span class="small">ìš”ì•½ ì—†ìŒ</span>')+'</div>'
         +   '<div class="flex" style="margin-top:6px">'
         +     (n.url?'<a href="'+n.url+'" target="_blank" rel="noopener">ì›ë¬¸ ë§í¬</a>':'')
         +     '<button data-id="'+n.id+'" class="btn-del small">ì‚­ì œ</button>'
         +   '</div>'
         + '</div>';
  });
  box.innerHTML=html;
  [].forEach.call(box.querySelectorAll('.btn-del'), function(b){
    b.onclick=function(){
      var id=b.getAttribute('data-id'); var db2=getDB();
      db2.notes=db2.notes.filter(function(x){return x.id!==id;});
      setDB(db2); renderNotes(filter);
    };
  });
}

// ReliefWeb í´ë°± fetch
async function tryFetchBodies(url,bodies){
  var errors=[];
  for(var i=0;i<bodies.length;i++){
    try{
      var res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(bodies[i])});
      if(res.ok){ return {ok:true,data:await res.json(),attempted:bodies[i],log:errors}; }
      var txt=await res.text().catch(function(){return String(res.status);});
      errors.push('HTTP '+res.status+' â€” '+txt.slice(0,200));
    }catch(e){ errors.push('EXC '+e.message); }
  }
  return {ok:false,log:errors};
}

async function rwFetch(){
  var out=document.getElementById('rw-results');
  var st=document.getElementById('rw-status');
  if(st) st.textContent='ìš”ì²­ ì‹œì‘â€¦'; if(out) out.innerHTML='';

  var daySpan=Number(document.getElementById('rw-days').value||365);
  var limit=Math.min(Number(document.getElementById('rw-limit').value||300),1000);

  var url='https://api.reliefweb.int/v1/reports?appname=HyunKim+recap_km_lite+a5Ttg7U8km-lite';
  var sinceISO=new Date(Date.now()-daySpan*86400000).toISOString().slice(0,10);
  var names=pickedISO3.length? RECAP_MAP.filter(function(d){return pickedISO3.indexOf(d.iso3)>=0;}).map(function(d){return d.name;}) : RECAP_NAMES;
  var iso3 =pickedISO3.length? pickedISO3 : RECAP_ISO3;

  var fields={include:['id','title','url','body','body-html','country','source','theme','disaster_type','date.created']};
  var sort=["date.created:desc"];
  var bodies=[
    {limit:limit,offset:0,filter:{operator:'AND',conditions:[{field:'country.iso3',value:iso3},{field:'date.created',value:{from:sinceISO}}]},fields:fields,sort:sort},
    {limit:limit,offset:0,filter:{operator:'AND',conditions:[{field:'country',value:names},{field:'date.created',value:{from:sinceISO}}]},fields:fields,sort:sort},
    {limit:limit,offset:0,filter:{operator:'AND',conditions:[{field:'country',value:names},{field:'date.created',range:{from:sinceISO}}]},fields:fields,sort:sort},
    {limit:limit,offset:0,filter:{operator:'AND',conditions:[{field:'country',value:names},{field:'date.created',operator:">=",value:sinceISO}]},fields:fields,sort:sort}
  ];
  var result=await tryFetchBodies(url,bodies);
  if(!result.ok){
    if(st) st.textContent='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
    out.innerHTML='<div class="small err">'+result.log.map(function(e){return 'â€¢ '+e;}).join('<br/>')+'</div>';
    console.error('ReliefWeb ìš”ì²­ ì‹¤íŒ¨ ë¡œê·¸:', result.log);
    return;
  }
  if(st) st.textContent='ì™„ë£Œ ('+new Date().toLocaleTimeString()+')';

  var data=result.data;
  var items=(data&&data.data?data.data:[]).map(function(r){
    var f=r.fields||{};
    var raw=(f['body-html']||'').replace(/<style[\s\S]*?<\/style>/gi,' ').replace(/<[^>]+>/g,' ');
    var body=(f.body&&String(f.body).trim().length>0)?f.body:raw;
    var metaTxt=[f.title,(f.theme||[]).map(function(t){return t.name;}).join(', '),
      (f.disaster_type||[]).map(function(d){return d.name;}).join(', '),
      (f.source||[]).map(function(s){return s.name;}).join(', '),
      (f.country||[]).map(function(c){return c.name;}).join(', ')].join(' | ');
    var hdp=hdpScore(metaTxt+' '+body);
    var c15=classifyC15(metaTxt+' '+body,3);
    return {
      id:r.id,title:f.title||'',url:f.url||'',created:f['date.created']||'',
      country:(f.country||[]).map(function(c){return c.name;}).join(', '),
      source:(f.source||[]).map(function(s){return s.name;}).join(', '),
      theme:(f.theme||[]).map(function(t){return t.name;}).join(', '),
      type:(f.disaster_type||[]).map(function(d){return d.name;}).join(', '),
      body:body, hdp:hdp, c15:c15
    };
  });

  var rows='';
  for(var i=0;i<items.length;i++){
    var it=items[i];
    rows+= '<tr>'
         +   '<td><input type="checkbox" class="rw-check" data-i="'+i+'"></td>'
         +   '<td class="title-cell" style="cursor:pointer;text-decoration:underline">'+it.title+'</td>'
         +   '<td>'+it.country+'</td>'
         +   '<td>'+it.source+'</td>'
         +   '<td>'+hbarHTML(it.hdp)+'</td>'
         +   '<td>'+renderC15Badges(it.c15)+'</td>'
         +   '<td><a href="'+it.url+'" target="_blank" rel="noopener">ë§í¬</a></td>'
         + '</tr>';
  }
  out.innerHTML=
    '<table>'+
      '<thead><tr><th></th><th>ì œëª©</th><th>êµ­ê°€</th><th>ì¶œì²˜</th><th>HDP%</th><th>ë¶„ë¥˜(C1~C15)</th><th>URL</th></tr></thead>'+
      '<tbody>'+rows+'</tbody>'+
    '</table>'+
    '<details style="margin-top:8px"><summary class="small">ì‚¬ìš©ëœ í•„í„° ë°”ë””(ì°¸ê³ )</summary><pre class="small mono" style="white-space:pre-wrap">'+
    (JSON.stringify(result.attempted,null,2))+
    '</pre></details>';

  // ì œëª© í´ë¦­ â†’ ëª¨ë‹¬
  [].forEach.call(document.querySelectorAll('#rw-results tbody .title-cell'), function(td,idx){
    td.onclick=function(){
      var it=items[idx];
      var text=[it.title,it.theme,it.type,it.source,it.country,it.body].filter(Boolean).join(' | ');
      var sumTxt=summarizeText(text,5)||'ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      document.getElementById('summary-title').textContent=it.title;
      document.getElementById('summary-meta').textContent=it.country+' Â· '+it.source;
      document.getElementById('summary-hdp').innerHTML=
        hbarHTML(it.hdp) + (it.c15&&it.c15.length?('<div class="small" style="margin-top:6px">'+renderC15Badges(it.c15)+'</div>'):'');
      document.getElementById('summary-content').innerHTML='<p>'+sumTxt+'</p><hr/><p><a href="'+it.url+'" target="_blank" rel="noopener">ì›ë¬¸ ë³´ê¸°</a></p>';
      document.getElementById('summary-modal').style.display='flex';
    };
  });
}

// ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('summary-close').onclick=function(){document.getElementById('summary-modal').style.display='none';};
document.getElementById('summary-modal').onclick=function(e){ if(e.target.id==='summary-modal') e.currentTarget.style.display='none'; };
window.addEventListener('keydown',function(e){ if(e.key==='Escape'){document.getElementById('summary-modal').style.display='none';document.getElementById('country-modal').style.display='none';}});

// ì €ì¥(ë©”íƒ€ ê¸°ë°˜ ìš”ì•½/HDP/ë¶„ë¥˜ í•¨ê»˜ ì €ì¥)
document.getElementById('rw-to-notes').onclick=function(){
  var checks=[].filter.call(document.querySelectorAll('.rw-check'), function(cb){return cb.checked;});
  if(!checks.length){ alert('ì €ì¥í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  var rows=[].slice.call(document.querySelectorAll('#rw-results tbody tr'));
  var db=getDB(); var now=Date.now();
  checks.forEach(function(cb){
    var i=Number(cb.dataset.i); var tr=rows[i];
    var title=tr.children[1].textContent.trim();
    var country=tr.children[2].textContent.trim();
    var source=tr.children[3].textContent.trim();
    var url=tr.children[6].querySelector('a')?tr.children[6].querySelector('a').href:'';
    var meta=[title,country,source].join(' | ');
    var summary=summarizeText(meta,3)||meta;
    var sc=hdpScore(meta);
    var c15=classifyC15(meta,3);
    var id='rw-'+i+'-'+title.slice(0,20).replace(/\W+/g,'_');
    if(db.notes.some(function(n){return n.id===id;})) return;
    db.notes.unshift({id:id,title:title,body:'',country:country,source:source,url:url,created:now,summary:summary,hdp:sc,hdpLabel:sc.label,c15:c15});
  });
  setDB(db); renderNotes();
  var st=document.getElementById('rw-status'); if(st) st.textContent=checks.length+'ê°œ ë…¸íŠ¸ ì €ì¥ ì™„ë£Œ';
};

// ì´ˆê¸° ë Œë”/ë°”ì¸ë”©
migrateNotesIfNeeded();
renderNotes();

document.addEventListener('DOMContentLoaded', function(){
  var btn=document.getElementById('rw-fetch'); if(btn) btn.addEventListener('click', rwFetch);
  document.getElementById('notes-refresh').onclick=function(){ renderNotes(document.getElementById('notes-q').value); };
  document.getElementById('notes-clear').onclick=function(){ if(!confirm('ëª¨ë“  ë…¸íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) return; setDB({notes:[]}); renderNotes(''); };
  document.getElementById('notes-q').addEventListener('input', function(e){ renderNotes(e.target.value); });
});
</script>

<!-- Dashboard Section -->
<section id="dashboard" style="margin-top:20px;">
  <h2>ğŸ“Š HDP & C1â€“C15 Dashboard</h2>
  <div style="display:flex;gap:20px;flex-wrap:wrap;">
    <div style="flex:1;min-width:300px;">
      <canvas id="hdpChart"></canvas>
    </div>
    <div style="flex:1;min-width:300px;">
      <canvas id="c15Chart"></canvas>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function renderDashboard(data){
  if(!data.length) return;
  const h=data.filter(d=>d.hdp.H==='H').length;
  const d=data.filter(d=>d.hdp.D==='D').length;
  const p=data.filter(d=>d.hdp.P==='P').length;
  const n=data.filter(d=>d.hdp.nexus==='Y').length;

  const hdpCtx=document.getElementById('hdpChart').getContext('2d');
  new Chart(hdpCtx,{type:'doughnut',
    data:{labels:['H','D','P','Nexus(Y)'],datasets:[{data:[h,d,p,n]}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  const cStats={};
  data.forEach(d=>(d.c15||[]).forEach(c=>cStats[c]=(cStats[c]||0)+1));
  const labels=Object.keys(cStats);
  const values=Object.values(cStats);
  const c15Ctx=document.getElementById('c15Chart').getContext('2d');
  new Chart(c15Ctx,{type:'bar',
    data:{labels,datasets:[{data:values}]},
    options:{indexAxis:'y',plugins:{legend:{display:false}}}
  });
}
</script>

</body>
</html>
