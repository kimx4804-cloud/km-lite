<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KOICA 취약국 성과관리 v3.0 — HDP Nexus & Resilience</title>

<style>
:root {
  --bg: #0b0f14; --fg: #e6eef8; --mut: #8aa0bb; --line: #253245;
  --h-col: #ff6b6b; --d-col: #4dabf7; --p-col: #51cf66; --res-col: #fcc419;
  --risk-high: #ff5c5c; --risk-med: #f2b45a; --risk-low: #43c174;
}
* { box-sizing: border-box; }
body { 
  font-family: 'Pretendard', system-ui, -apple-system, sans-serif; 
  background: var(--bg); color: var(--fg); margin: 0; padding: 16px; line-height: 1.5;
}
h2 { margin: 0 0 5px; color: #fff; font-size: 1.5rem; }
.sub-title { color: var(--mut); margin-bottom: 20px; font-size: 12px; }

/* UI Elements */
.panel { border: 1px solid var(--line); border-radius: 12px; padding: 15px; background: rgba(25, 33, 45, 0.4); margin-bottom: 12px; }
.flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
input, select, button {
  border-radius: 8px; padding: 8px 12px; font-size: 13px;
  border: 1px solid var(--line); background: #161d27; color: var(--fg); outline: none;
}
button { cursor: pointer; background: #253245; border: none; font-weight: 600; }
button:hover { background: #35455d; }
.btn-primary { background: var(--d-col); color: #000; }

/* Dashboard Tiles */
.dash-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
.dash-tile { padding: 15px; border: 1px solid var(--line); border-radius: 12px; background: rgba(30, 40, 55, 0.4); }
.dash-val { font-size: 24px; font-weight: 900; margin-top: 5px; }
.mini-bar { height: 4px; background: #253245; border-radius: 2px; margin-top: 8px; overflow: hidden; }
.mini-bar div { height: 100%; background: var(--d-col); transition: width 0.5s; }

/* Results */
.card { border: 1px solid var(--line); border-radius: 10px; padding: 15px; background: rgba(15, 22, 32, 0.5); margin-bottom: 12px; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; color: #000; }
.bg-h { background: var(--h-col); } .bg-d { background: var(--d-col); } .bg-p { background: var(--p-col); } .bg-res { background: var(--res-col); }
.bg-off { background: var(--line); color: var(--mut); }
.tag-c { font-size: 10px; padding: 1px 5px; border-radius: 3px; border: 1px solid var(--d-col); color: var(--d-col); margin-right: 4px; }

#results-list { max-height: 600px; overflow-y: auto; padding-right: 5px; }
a { color: var(--d-col); text-decoration: none; font-size: 12px; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--line); border-radius: 10px; }
</style>
</head>

<body>
<h2>KOICA 취약국 성과관리 v3.0</h2>
<div class="sub-title">이화여대 산학협력단 기술지원 프로젝트용 KM-Lite (HDP Nexus & Resilience 분석)</div>


<div class="panel">
  <div class="flex" style="justify-content:space-between">
    <div class="flex">
      <strong style="margin-right:10px;">Data Integrator:</strong>
      <label class="flex"><input type="checkbox" checked disabled> ReliefWeb</label>
      <label class="flex"><input type="checkbox" id="check-acled"> ACLED (Conflict)</label>
      <label class="flex"><input type="checkbox" id="check-wb"> WorldBank (WDI)</label>
    </div>
    <div class="flex">
      <input id="fetch-days" type="number" value="90" style="width:70px" title="검색 기간(일)"/>
      <button id="btn-update" class="btn-primary">데이터 업데이트</button>
    </div>
  </div>
</div>

<div class="dash-grid" id="dash-board">
  <div class="dash-tile"><div class="small">분석 대상</div><div class="dash-val" id="stat-total">0</div></div>
  <div class="dash-tile">
    <div class="small">HDP-H (긴급구호)</div>
    <div class="dash-val" style="color:var(--h-col)" id="stat-h">0</div>
    <div class="mini-bar"><div id="bar-h" style="width:0%"></div></div>
  </div>
  <div class="dash-tile">
    <div class="small">회복력(Resilience)</div>
    <div class="dash-val" style="color:var(--res-col)" id="stat-res">0</div>
    <div class="mini-bar"><div id="bar-res" style="width:0%"></div></div>
  </div>
  <div class="dash-tile">
    <div class="small">교전/리스크 강도</div>
    <div class="dash-val" style="color:var(--risk-high)" id="stat-risk">0</div>
  </div>
</div>

<div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
  <div class="panel">
    <div class="flex" style="margin-bottom:15px;">
      <input id="search-input" placeholder="국가명, 키워드, C-code 검색..." style="flex:1"/>
      <select id="nexus-filter">
        <option value="">모든 Nexus</option>
        <option value="H">Humanitarian</option>
        <option value="D">Development</option>
        <option value="P">Peace</option>
        <option value="RES">Resilience Focus</option>
      </select>
    </div>
    <div id="results-list">
      <div style="text-align:center; padding:50px; color:var(--mut);">데이터 업데이트 버튼을 눌러 분석을 시작하세요.</div>
    </div>
  </div>

  <div class="panel">
    <div style="font-weight:bold; margin-bottom:10px; color:var(--d-col);">KOICA 성과코드 가이드</div>
    <div id="code-guide" style="font-size:12px; color:var(--mut);">
      <div><strong>C3:</strong> 논리모형/TOC</div>
      <div><strong>C8:</strong> 지속가능성</div>
      <div><strong>C10:</strong> 리스크/적응관리</div>
      <div><strong>C13:</strong> 환경/기후 회복력</div>
      <hr style="border:0; border-top:1px solid var(--line); margin:10px 0;">
      <div style="color:var(--fg);">분석된 문서의 코드를 클릭하여 성과관리 인사이트를 확보하세요.</div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   데이터 분석 엔진 (HDP & C1~C15)
   ============================================================ */
const ANALYZER_DICT = {
  H: ['relief', 'emergency', 'displacement', 'humanitarian', 'refugee', 'famine', 'outbreak'],
  D: ['sustainability', 'livelihood', 'infrastructure', 'capacity building', 'development', 'investment'],
  P: ['peacebuilding', 'mediation', 'governance', 'cohesion', 'conflict resolution', 'justice'],
  RES: ['resilience', 'adaptive', 'absorptive', 'transformative', 'disaster risk', 'climate smart'],
  RISK: ['clash', 'attack', 'killed', 'violence', 'explosion', 'ambush', 'protest'],
  CODES: {
    C3: ['theory of change', 'logic model', 'results chain', 'outcome mapping'],
    C8: ['exit strategy', 'ownership', 'sustainability plan', 'handover'],
    C10: ['risk mitigation', 'adaptive management', 'contingency', 'flexibility'],
    C13: ['climate resilience', 'adaptation', 'environmental impact'],
    C14: ['lessons learned', 'good practice', 'knowledge sharing', 'success story']
  }
};

let analysisStore = [];

function runAnalysis(title) {
  const t = title.toLowerCase();
  const nexus = { H: false, D: false, P: false, RES: false };
  const codes = [];
  
  if (ANALYZER_DICT.H.some(w => t.includes(w))) nexus.H = true;
  if (ANALYZER_DICT.D.some(w => t.includes(w))) nexus.D = true;
  if (ANALYZER_DICT.P.some(w => t.includes(w))) nexus.P = true;
  if (ANALYZER_DICT.RES.some(w => t.includes(w))) nexus.RES = true;

  for (let c in ANALYZER_DICT.CODES) {
    if (ANALYZER_DICT.CODES[c].some(w => t.includes(w))) codes.push(c);
  }

  const riskScore = ANALYZER_DICT.RISK.reduce((acc, w) => acc + (t.split(w).length - 1), 0);

  return { nexus, codes, riskScore };
}

/* ============================================================
   데이터 호출 및 처리 (ReliefWeb API)
   ============================================================ */
async function updateSystem() {
  const days = document.getElementById('fetch-days').value;
  const dateLimit = new Date();
  dateLimit.setDate(dateLimit.getDate() - days);
  const dateISO = dateLimit.toISOString().split('T')[0];

  const url = `https://api.reliefweb.int/v1/reports?appname=KOICA_KM_LITE&limit=100&filter[field]=date.created&filter[value][from]=${dateISO}T00:00:00Z&profile=full`;
  
  const listEl = document.getElementById('results-list');
  listEl.innerHTML = '<div style="text-align:center; padding:50px;">실시간 HDP Nexus 분석 중...</div>';

  try {
    const res = await fetch(url);
    const json = await res.json();
    
    analysisStore = json.data.map(item => ({
      id: item.id,
      title: item.fields.title,
      url: item.fields.url,
      date: item.fields.date.created.split('T')[0],
      source: item.fields.source[0].shortname || item.fields.source[0].name,
      analysis: runAnalysis(item.fields.title)
    }));

    renderAll();
  } catch (err) {
    listEl.innerHTML = '<div style="color:var(--risk-high); text-align:center; padding:50px;">데이터를 가져오지 못했습니다. (API 제한 또는 네트워크 오류)</div>';
  }
}

/* ============================================================
   UI 렌더링 로직
   ============================================================ */
function renderAll() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const filter = document.getElementById('nexus-filter').value;

  const filtered = analysisStore.filter(d => {
    const matchQ = d.title.toLowerCase().includes(q) || d.source.toLowerCase().includes(q);
    const matchF = !filter || (filter === 'RES' ? d.analysis.nexus.RES : d.analysis.nexus[filter]);
    return matchQ && matchF;
  });

  // 대시보드 업데이트
  const stats = {
    total: filtered.length,
    h: filtered.filter(d => d.analysis.nexus.H).length,
    res: filtered.filter(d => d.analysis.nexus.RES).length,
    risk: filtered.reduce((acc, d) => acc + d.analysis.riskScore, 0)
  };

  document.getElementById('stat-total').innerText = stats.total;
  document.getElementById('stat-h').innerText = stats.h;
  document.getElementById('stat-res').innerText = stats.res;
  document.getElementById('stat-risk').innerText = stats.risk;
  document.getElementById('bar-h').style.width = stats.total ? `${(stats.h/stats.total)*100}%` : '0%';
  document.getElementById('bar-res').style.width = stats.total ? `${(stats.res/stats.total)*100}%` : '0%';

  // 리스트 업데이트
  const listEl = document.getElementById('results-list');
  if (filtered.length === 0) {
    listEl.innerHTML = '<div style="text-align:center; padding:50px; color:var(--mut);">조건에 맞는 데이터가 없습니다.</div>';
    return;
  }

  listEl.innerHTML = filtered.map(d => `
    <div class="card">
      <div class="flex" style="justify-content:space-between; align-items:flex-start;">
        <div style="font-weight:bold; flex:1; margin-right:15px; color:#fff;">${d.title}</div>
        <div style="white-space:nowrap; text-align:right;">
          <div class="small" style="color:var(--mut);">${d.date}</div>
          <div class="small" style="color:var(--d-col); font-weight:bold;">${d.source}</div>
        </div>
      </div>
      <div style="margin:10px 0;">
        ${d.analysis.nexus.H ? '<span class="badge bg-h">H</span>' : '<span class="badge bg-off">H</span>'}
        ${d.analysis.nexus.D ? '<span class="badge bg-d">D</span>' : '<span class="badge bg-off">D</span>'}
        ${d.analysis.nexus.P ? '<span class="badge bg-p">P</span>' : '<span class="badge bg-off">P</span>'}
        ${d.analysis.nexus.RES ? '<span class="badge bg-res">RESILIENCE</span>' : ''}
      </div>
      <div class="flex" style="justify-content:space-between;">
        <div>
          ${d.analysis.codes.map(c => `<span class="tag-c">${c}</span>`).join('')}
          <span class="small" style="color:var(--mut);">Risk: ${d.analysis.riskScore}</span>
        </div>
        <a href="${d.url}" target="_blank">View Original ↗</a>
      </div>
    </div>
  `).join('');
}

/* 이벤트 바인딩 */
document.getElementById('btn-update').onclick = updateSystem;
document.getElementById('search-input').oninput = renderAll;
document.getElementById('nexus-filter').onchange = renderAll;
</script>
</body>
</html>
