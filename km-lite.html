<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>km-lite v2.6 — ReliefWeb + ACLED · Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
:root{
  --bg:#0b0f14;
  --panel:#0f1620;
  --panel2:rgba(15,22,32,.55);
  --fg:#e6eef8;
  --mut:#8aa0bb;
  --line:rgba(255,255,255,.10);
  --line2:rgba(255,255,255,.16);

  --h:#3aa3ff;
  --d:#61d661;
  --p:#f2b45a;
  --off:#364254;

  --low:#43c174;
  --med:#f2b45a;
  --high:#ff5c5c;

  --shadow: 0 10px 24px rgba(0,0,0,.30);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  padding:16px;
  background:var(--bg);
  color:var(--fg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
  letter-spacing:.1px;
  font-size:13px;
}

.container{max-width:1280px;margin:0 auto}
h1{font-size:15px;margin:0 0 10px;font-weight:700}
.small{font-size:12px;color:var(--mut);line-height:1.5}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
a{color:#9bd0ff;text-decoration:none}
a:hover{text-decoration:underline}

input, button, select, textarea{
  background:var(--panel);
  color:var(--fg);
  border:1px solid var(--line);
  border-radius:10px;
  padding:.46rem .58rem;
  font-size:13px;
  outline:none;
}
button{cursor:pointer}
button:hover{border-color:var(--line2)}
textarea{width:100%}
hr{border:none;border-top:1px solid var(--line); margin:12px 0}

.card{
  border:1px solid var(--line);
  background:var(--panel2);
  border-radius:16px;
  padding:12px;
  box-shadow: var(--shadow);
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.spread{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

.pill{
  display:inline-flex;align-items:center;gap:6px;
  border:1px solid var(--line);
  border-radius:999px;
  padding:3px 10px;
  font-size:11px;
  color:var(--mut);
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border:1px solid var(--line);
  border-radius:999px;
  font-size:11px;
  color:var(--mut);
}

.section-title{
  font-weight:650;
  font-size:12px;
  margin:0 0 8px;
  color:#dfeaff;
  letter-spacing:.2px;
  text-transform:uppercase;
}

/* KPI tiles */
.kpi-grid{
  display:grid;
  grid-template-columns: repeat(12, minmax(0,1fr));
  gap:10px;
}
.kpi{
  border:1px solid var(--line);
  background: rgba(15,22,32,.55);
  border-radius:16px;
  padding:12px;
}
.kpi .k{font-size:11px;color:var(--mut);display:flex;gap:8px;align-items:center}
.kpi .v{font-size:18px;font-weight:700;margin-top:8px}
.kpi .s{font-size:11px;color:#9fb2c8;margin-top:6px;line-height:1.35}
.kpi .mini{
  height:8px;border-radius:999px;
  background: rgba(255,255,255,.06);
  overflow:hidden;margin-top:10px;
  border:1px solid rgba(255,255,255,.10);
}
.kpi .mini > div{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(58,163,255,.80), rgba(97,214,97,.75));
}
.kpi.clickable{cursor:pointer}
.kpi.clickable:hover{border-color:var(--line2); transform: translateY(-1px); transition: transform .08s ease}

/* layout */
.main-grid{
  display:grid;
  grid-template-columns: 1fr 420px;
  gap:12px;
  align-items:start;
}
@media (max-width:1120px){ .main-grid{grid-template-columns:1fr;} }

/* map */
#map{
  height:74vh; /* taller */
  width:100%;
  border-radius:16px;
  border:1px solid var(--line);
  overflow:hidden;
  background:#0c121a;
}
@media (max-width:860px){ #map{height:66vh;} }

/* list */
table{border-collapse:collapse;width:100%;font-size:13px}
th,td{border:1px solid var(--line);padding:8px;vertical-align:top;text-align:left}
th{background:#0f1620;position:sticky;top:0;z-index:1}
tbody tr:hover{background:rgba(255,255,255,.03)}
.title-cell{cursor:pointer;text-decoration:underline}

/* indicators badges */
.hdp-badge{
  display:inline-block;
  padding:2px 7px;
  border-radius:8px;
  font-size:11px;
  font-weight:700;
  margin-right:4px;
  color:#000;
}
.hdp-off{ background:var(--off); color:#8da0b5; }
.hdp-H{ background:var(--h); }
.hdp-D{ background:var(--d); }
.hdp-P{ background:var(--p); }

.risk-badge, .conf-badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:750;
  color:#000;
}
.risk-low{background:var(--low)}
.risk-med{background:var(--med)}
.risk-high{background:var(--high)}
.conf-low{background:var(--low)}
.conf-med{background:var(--med)}
.conf-high{background:var(--high)}

.policy-flag{
  display:inline-block;
  padding:1px 7px;
  border-radius:999px;
  font-size:10px;
  border:1px solid var(--med);
  color:var(--med);
  margin-left:6px;
}

.legend{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  padding:10px; border:1px solid var(--line); border-radius:14px; background:rgba(15,22,32,.40)
}
.dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
.err{color:#ffb4b4}
#status{min-height:16px}

/* modal */
.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.62);
  z-index:1000;
  align-items:center;justify-content:center;
  padding:16px;
}
.modal > div{
  width:min(920px, 92vw);
  max-height:84vh;
  overflow:auto;
  background:var(--bg);
  border:1px solid var(--line2);
  border-radius:16px;
  padding:16px;
  box-shadow:0 0 22px rgba(0,0,0,.55);
}
.modal h3{margin:0 0 8px;font-size:15px;font-weight:700}
.modal .meta{margin:0 0 10px;color:var(--mut);font-size:12px}
pre.wrap{white-space:pre-wrap;margin:0;font-size:13px;line-height:1.6;color:#dce8f7}
</style>
</head>

<body>
<div class="container">
  <h1>recap km-lite v2.6</h1>

  <div class="card">
    <div class="spread">
      <div class="row">
        <span class="pill">Data</span>
        <select id="src-mode" title="Data Source">
          <option value="reliefweb">ReliefWeb Reports</option>
          <option value="acled">ACLED Events (Key Required)</option>
          <option value="both">Both</option>
        </select>

        <span class="pill">Window</span>
        <label class="small">Recent Days</label>
        <input id="days" type="number" value="3650" style="width:98px" title="Default: 10 Years"/>

        <span class="badge" id="limit-chip" title="Maximum Items (Fixed)">Max</span>

        <button id="btn-country" title="Collection Target Countries">Country Set</button>
        <span id="country-chip" class="badge">All 20</span>

        <span class="pill">Filters</span>
        <label class="small">Country</label>
        <select id="filter-country" style="min-width:210px">
          <option value="">All</option>
        </select>

        <label class="small">Partner</label>
        <select id="filter-partner" style="min-width:220px">
          <option value="">All</option>
        </select>

        <button id="btn-clear-filters" title="Clear Filters">Clear</button>
      </div>

      <div class="row">
        <button id="fetch">Fetch</button>
        <span id="status" class="small"></span>
      </div>
    </div>

    <div id="acled-key-row" class="row" style="margin-top:10px; display:none;">
      <span class="pill">ACLED</span>
      <label class="small">Api Key</label>
      <input id="acled-key" placeholder="ACLED_API_KEY" style="min-width:240px; flex:1"/>
      <label class="small">Email</label>
      <input id="acled-email" placeholder="you@example.com" style="min-width:220px; flex:1"/>
    </div>
  </div>

  <hr/>

  <div class="card">
    <div class="spread" style="margin-bottom:8px;">
      <div class="section-title">Dashboard</div>
      <div class="row">
        <span class="badge" id="dash-scope">Scope: —</span>
        <span class="badge" id="dash-window">Window: —</span>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi" style="grid-column: span 3;">
        <div class="k">Items</div>
        <div class="v" id="kpi-items">—</div>
        <div class="s">Reports + Events</div>
      </div>

      <div class="kpi" style="grid-column: span 3;">
        <div class="k">ReliefWeb Reports</div>
        <div class="v" id="kpi-reports">—</div>
      </div>

      <div class="kpi" style="grid-column: span 3;">
        <div class="k">ACLED Events</div>
        <div class="v" id="kpi-events">—</div>
      </div>

      <div class="kpi clickable" id="kpi-high-tile" style="grid-column: span 3;" title="Toggle High Risk Filter">
        <div class="k">High Risk</div>
        <div class="v" id="kpi-high">—</div>
        <div class="mini"><div id="kpi-high-bar"></div></div>
      </div>

      <div class="kpi clickable" id="kpi-c4-tile" style="grid-column: span 4;" title="Toggle Heat ≥ 4 Filter">
        <div class="k">Conflict Heat ≥ 4</div>
        <div class="v" id="kpi-c4">—</div>
        <div class="mini"><div id="kpi-c4-bar"></div></div>
      </div>

      <div class="kpi" style="grid-column: span 4;">
        <div class="k">HDP Signals</div>
        <div class="v" id="kpi-hdp">—</div>
        <div class="s">Share Of Items Tagged H / D / P</div>
      </div>

      <div class="kpi" style="grid-column: span 4;">
        <div class="k">Top C-Codes</div>
        <div class="v" id="kpi-codes">—</div>
        <div class="s" id="kpi-codes-s">Top 3</div>
      </div>

      <div class="kpi" style="grid-column: span 12;">
        <div class="legend">
          <span class="small"><b>Risk</b></span>
          <span class="small"><span class="dot" style="background:var(--low)"></span>Low</span>
          <span class="small"><span class="dot" style="background:var(--med)"></span>Med</span>
          <span class="small"><span class="dot" style="background:var(--high)"></span>High</span>
          <span class="small" style="margin-left:12px"><b>Conflict</b></span>
          <span class="small"><span class="dot" style="background:var(--low)"></span>1–2</span>
          <span class="small"><span class="dot" style="background:var(--med)"></span>3–4</span>
          <span class="small"><span class="dot" style="background:var(--high)"></span>5</span>
          <span class="small" style="margin-left:12px"><b>HDP</b></span>
          <span class="small"><span class="dot" style="background:var(--h)"></span>H</span>
          <span class="small"><span class="dot" style="background:var(--d)"></span>D</span>
          <span class="small"><span class="dot" style="background:var(--p)"></span>P</span>
        </div>
      </div>
    </div>
  </div>

  <hr/>

  <div class="main-grid">
    <div class="card">
      <div class="spread" style="margin-bottom:8px;">
        <div class="section-title">Map</div>
        <div class="row">
          <select id="map-layer" title="Map Layer">
            <option value="auto">Auto</option>
            <option value="country">Country Aggregates</option>
            <option value="acled">ACLED Points</option>
            <option value="both">Both</option>
          </select>
          <select id="map-metric" title="Country Metric">
            <option value="conflictIndex">Country: Conflict Heat</option>
            <option value="riskScore">Country: Risk Score</option>
          </select>
          <select id="map-agg" title="Aggregation">
            <option value="max">Max</option>
            <option value="mean">Mean</option>
          </select>
          <button id="map-refresh">Refresh</button>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div class="card">
      <div class="section-title">Insights</div>

      <div class="kpi" style="margin-bottom:10px">
        <div class="k">Top Countries</div>
        <div class="v" id="side-countries">—</div>
        <div class="s">Top 5</div>
      </div>

      <div class="kpi" style="margin-bottom:10px">
        <div class="k">Top Partners</div>
        <div class="v" id="side-partners">—</div>
        <div class="s">Top 5 (Reports Only)</div>
      </div>

      <div class="kpi">
        <div class="k">Latest Date</div>
        <div class="v" id="side-recent">—</div>
      </div>
    </div>
  </div>

  <hr/>

  <div class="card">
    <div class="section-title">Items</div>
    <div id="results" class="small">Fetch를 실행하세요.</div>
  </div>
</div>

<!-- Summary Modal -->
<div id="modal" class="modal">
  <div>
    <div class="spread">
      <div>
        <h3 id="m-title"></h3>
        <div id="m-meta" class="meta"></div>
      </div>
      <button id="m-close">Close</button>
    </div>
    <div id="m-badges" style="margin:10px 0"></div>
    <pre id="m-sum" class="wrap"></pre>
    <div style="margin-top:12px">
      <a id="m-link" href="#" target="_blank" rel="noopener">Open Source</a>
    </div>
  </div>
</div>

<!-- Country Set Modal -->
<div id="country-modal" class="modal">
  <div>
    <div class="spread">
      <div>
        <h3>Country Set</h3>
        <div class="small">체크 후 적용</div>
      </div>
      <button id="c-close">Close</button>
    </div>
    <div id="c-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-top:10px"></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="c-clear">Reset</button>
      <button id="c-apply">Apply</button>
    </div>
  </div>
</div>

<script>
/* =============================
   Config
============================= */
const APPNAME = "HyunKim+recap_km_lite+a5Ttg7U8";
const MAX_ITEMS = 1500; // "Max" (safety cap for browser & API)

/* =============================
   Utils
============================= */
function escapeHTML(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

/* =============================
   Countries
============================= */
const RECAP_NAMES = [
  'Burundi','Central African Republic','Comoros','Guinea','Kenya','Mali',
  'Sao Tome and Principe','Somalia','South Sudan','Zimbabwe',
  'Armenia','Iran','Jordan','Lebanon','Palestine','Syria','Yemen',
  'Papua New Guinea','Solomon Islands','Timor-Leste'
];
const RECAP_ISO3 = [
  'BDI','CAF','COM','GIN','KEN','MLI',
  'STP','SOM','SSD','ZWE',
  'ARM','IRN','JOR','LBN','PSE','SYR','YEM',
  'PNG','SLB','TLS'
];
const RECAP_MAP = RECAP_NAMES.map((n,i)=>({name:n,iso3:RECAP_ISO3[i]}));

const COUNTRY_CENTROIDS = {
  BDI:[-3.3731,29.9189], CAF:[ 6.6111,20.9394], COM:[-11.6455,43.3333],
  GIN:[10.4362,-10.9407], KEN:[ 0.0236,37.9062], MLI:[17.5707,-3.9962],
  STP:[ 0.1864, 6.6131], SOM:[ 5.1521,46.1996], SSD:[ 6.8770,31.3070],
  ZWE:[-19.0154,29.1549], ARM:[40.0691,45.0382], IRN:[32.4279,53.6880],
  JOR:[30.5852,36.2384], LBN:[33.8547,35.8623], PSE:[31.9522,35.2332],
  SYR:[34.8021,38.9968], YEM:[15.5527,48.5164], PNG:[-6.3140,143.9555],
  SLB:[-9.6457,160.1562], TLS:[-8.8742,125.7275]
};

let pickedISO3 = [];
let currentItems = [];
let selectedISO3 = "";
let selectedPartner = "";
let listSpecialMode = "";

/* =============================
   Indicators: HDP
============================= */
const HDP_DICT = {
  H:['emergency','relief','response','humanitarian','displacement','refugee','cholera','outbreak','famine','flood','earthquake','evacuation','cash assistance','wash cluster','rapid'],
  D:['development','infrastructure','education','school','clinic','health system','primary care','livelihoods','capacity building','policy','programme','investment','training','supply chain','renewable','solar','water supply','monitoring','m&e'],
  P:['peace','cohesion','conflict','mediation','grievance','inclusive','social contract','community committee','youth','women participation','accountability','complaints','do no harm']
};
function hdpScore(text){
  const T = (text || '').toLowerCase();
  const anyHit = arr => arr.some(w => T.includes(w)) ? "yes" : "no";
  const H = anyHit(HDP_DICT.H);
  const D = anyHit(HDP_DICT.D);
  const P = anyHit(HDP_DICT.P);
  return { H, D, P, label:`H:${H} / D:${D} / P:${P}` };
}
function hbarHTML(score){
  if(!score) return '';
  const hx = score.H === "yes" ? `<span class="hdp-badge hdp-H">H</span>` : `<span class="hdp-badge hdp-off">H</span>`;
  const dx = score.D === "yes" ? `<span class="hdp-badge hdp-D">D</span>` : `<span class="hdp-badge hdp-off">D</span>`;
  const px = score.P === "yes" ? `<span class="hdp-badge hdp-P">P</span>` : `<span class="hdp-badge hdp-off">P</span>`;
  return `<div>${hx}${dx}${px}</div>`;
}

/* =============================
   Summarization
============================= */
function summarizeText(text,maxSentences){
  maxSentences = maxSentences || 5;
  if(!text) return '';
  let sents = text
    .split(/(?<=[.!?。！？])\s+|[\r\n]{2,}/)
    .map(s=>s.trim())
    .filter(s=>s.length>20);
  if(!sents.length) return '';
  if(sents.length<=maxSentences) return sents.join(' ');

  function tokenize(s){
    return s.toLowerCase()
      .replace(/[^a-z0-9가-힣\s]/g,' ')
      .split(/\s+/).filter(Boolean);
  }
  const stop = new Set([
    'the','and','for','with','that','this','from','are','was','were',
    'have','has','had','of','in','to','on','by','as','is','be','or',
    'at','an','a','it','its','their','our','we','you','they','into',
    'over','under','between','within','through','about','after','before',
    'during','against','among','per','및','그리고','그러나','또는','에서',
    '으로','에는','에','를','을','이','가','은','는','와','과','하다',
    '했다','대한','위한'
  ]);

  const tf={},df={},sentTokens=[];
  sents.forEach((s,i)=>{
    const ws = tokenize(s).filter(w=>!stop.has(w));
    sentTokens[i]=ws;
    const seen={};
    ws.forEach(w=>{
      tf[w]=(tf[w]||0)+1;
      if(!seen[w]){ df[w]=(df[w]||0)+1; seen[w]=1; }
    });
  });

  const N=sents.length;
  const scored=sents.map((s,i)=>{
    let sc=0;
    sentTokens[i].forEach(w=>{
      const idf=Math.log((N+1)/((df[w]||1)+1));
      sc += (tf[w]||0)*idf;
    });
    const len=s.length;
    const lenAdj=(len<40?0.85:(len>300?0.9:1));
    return {i,score:sc*lenAdj};
  });
  scored.sort((a,b)=>b.score-a.score);
  scored.splice(maxSentences);
  scored.sort((a,b)=>a.i-b.i);
  return scored.map(x=>sents[x.i]).join(' ');
}

/* =============================
  Risk / Conflict / Policy
============================= */
const RISK_DICT = {
  security: [
    'security incident','armed group','militia','attack','shelling','airstrike','kidnapping',
    'detention','harassment','checkpoint','intimidation','armed clashes','violence','threat'
  ],
  access: [
    'access constraint','access restriction','movement restriction','road closure',
    'inaccessible','denied access','limited access','suspension of operations','evacuation of staff'
  ],
  political: [
    'coup','political crisis','election violence','crackdown','state of emergency',
    'martial law','sanctions','diplomatic tension'
  ],
  logistics: [
    'supply disruption','pipeline break','stockout','shortage of supplies',
    'transport disruption','logistical challenge','import restriction'
  ],
  climate: [
    'flood','drought','cyclone','typhoon','landslide','storm surge','heatwave',
    'climate shock','extreme weather'
  ],
  partner: [
    'governance issue','mismanagement','corruption','fraud','misprocurement',
    'partner capacity gap','weak management'
  ]
};
const POLICY_TERMS = [
  'new regulation','regulation change','policy revision','policy change',
  'government decree','government directive','ministerial order','new law',
  'legislation','suspension order','ban on','prohibited','visa restriction','border closure'
];
const CONFLICT_TERMS = [
  'armed clashes','clashes','fighting','battle','frontline','shelling','airstrike',
  'armed group','militia','non-state armed','violence','attack','ambush','raid',
  'displacement due to conflict','conflict-affected','hostilities'
];

function analyzeRiskAndConflict(text){
  const T = (text || '').toLowerCase();
  let rawScore = 0;
  const tags = [];

  const countHits = (arr, weight, tagName) => {
    let cnt = 0;
    arr.forEach(term=>{
      const t = term.toLowerCase();
      if(!t) return;
      const re = new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
      const m = T.match(re);
      if(m && m.length) cnt += m.length;
    });
    if(cnt>0){
      rawScore += cnt * weight;
      tags.push(tagName + '('+cnt+')');
    }
  };

  countHits(RISK_DICT.security, 3, 'security');
  countHits(RISK_DICT.access,   2.5,'access');
  countHits(RISK_DICT.political,2.5,'political');
  countHits(RISK_DICT.logistics,2,  'logistics');
  countHits(RISK_DICT.climate,  2,  'climate');
  countHits(RISK_DICT.partner,  2,  'partner');

  let level = 'low';
  if(rawScore >= 18) level = 'high';
  else if(rawScore >= 8) level = 'med';

  let conflictScore = 0;
  CONFLICT_TERMS.forEach(term=>{
    const re = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
    const m = T.match(re);
    if(m && m.length) conflictScore += m.length;
  });
  let conflictIndex = 1;
  if(conflictScore >= 8) conflictIndex = 5;
  else if(conflictScore >= 4) conflictIndex = 4;
  else if(conflictScore >= 2) conflictIndex = 3;
  else if(conflictScore >= 1) conflictIndex = 2;

  let policy = false;
  POLICY_TERMS.forEach(term=>{ if(T.includes(term.toLowerCase())) policy = true; });

  return { riskScore: rawScore, riskLevel: level, riskTags: tags, conflictIndex, policyFlag: policy };
}

function renderRiskBadge(r){
  if(!r) return '';
  const txt = r.riskLevel === 'high' ? 'High' : r.riskLevel === 'med' ? 'Med' : 'Low';
  const cls = r.riskLevel === 'high' ? 'risk-high' : r.riskLevel === 'med' ? 'risk-med' : 'risk-low';
  const policy = r.policyFlag ? `<span class="policy-flag">Policy</span>` : '';
  return `<span class="risk-badge ${cls}">${txt}</span>${policy}`;
}
function renderConflictBadge(idx){
  if(!idx) idx = 1;
  let cls='conf-low';
  if(idx<=2) cls='conf-low';
  else if(idx<=4) cls='conf-med';
  else cls='conf-high';
  return `<span class="conf-badge ${cls}">Heat ${idx}</span>`;
}

/* =============================
  c1~c15
============================= */
const CODES = {
  C1:{name:'사업·프로젝트 개요 & 배경',core:['background','project overview','context analysis','needs assessment','맥락','배경'],related:['objective','goal','목표'],ref:['overview']},
  C2:{name:'이해관계자 분석',core:['stakeholder analysis','actor mapping','이해관계자'],related:['partner','community'],ref:['coordination']},
  C3:{name:'논리모형 & 성과경로',core:['theory of change','logic model','results chain','논리모형'],related:['outcome','impact','assumption'],ref:['logframe']},
  C4:{name:'실행 및 운영관리',core:['implementation plan','operational plan','운영 계획'],related:['workplan','sop'],ref:['project management']},
  C5:{name:'모니터링 & 평가',core:['monitoring and evaluation','m&e system','indicator framework','평가 계획'],related:['baseline','endline','data quality'],ref:['reporting']},
  C6:{name:'성과(산출/성과)',core:['outputs achieved','output','deliverable'],related:['beneficiaries reached','coverage','training','workshop'],ref:['result']},
  C7:{name:'영향(impact)',core:['impact evaluation','long-term impact','제도적 변화'],related:['behaviour change','policy change'],ref:['impact']},
  C8:{name:'지속가능성',core:['sustainability plan','exit strategy','지속가능성'],related:['scaling','handover'],ref:['continuity']},
  C9:{name:'비용효율성',core:['cost-effectiveness','value for money','비용 효과성'],related:['unit cost','budget'],ref:['financial']},
  C10:{name:'리스크 & 적응성',core:['risk analysis','risk mitigation','contingency','리스크'],related:['adaptive management'],ref:['constraint']},
  C11:{name:'젠더/포용',core:['gender analysis','psea','젠더'],related:['inclusion','disability'],ref:['leave no one behind']},
  C12:{name:'거버넌스/책임성',core:['accountability','complaints mechanism','grievance'],related:['transparency'],ref:['governance']},
  C13:{name:'환경/기후',core:['climate risk assessment','environmental impact','기후 위험'],related:['drr','resilience'],ref:['climate']},
  C14:{name:'교훈/확산',core:['lessons learned','good practices','교훈'],related:['case study','innovation'],ref:['takeaways']},
  C15:{name:'한계/권고',core:['limitations','recommendations','권고'],related:['bottlenecks','constraints'],ref:['way forward']}
};
function classifyC15(text, topN){
  topN = topN || 3;
  if(!text) return [];
  const T = text.toLowerCase();
  const words = T.split(/[^a-z0-9가-힣]+/).filter(Boolean);
  const wordCount = words.length || 1;
  const results = [];

  for(const code in CODES){
    const cfg=CODES[code];
    let score=0;
    const addHits=(list,w)=>{
      (list||[]).forEach(term=>{
        const t=term.toLowerCase();
        const re=new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
        const m=T.match(re);
        if(m&&m.length) score+=w*m.length;
      });
    };
    addHits(cfg.core,3); addHits(cfg.related,2); addHits(cfg.ref,1);
    const norm=score/(1+Math.log(wordCount));
    if(norm>0) results.push({code,name:cfg.name,s:norm});
  }
  results.sort((a,b)=>b.s-a.s);
  return results.slice(0,topN);
}
function renderC15Badges(arr){
  if(!arr || !arr.length) return '<span class="small" style="color:#8698b0">—</span>';
  return arr.map(x=>`<span class="badge" title="${escapeAttr(x.name)}">${escapeHTML(x.code)}</span>`).join(' ');
}

/* =============================
   Source UI
============================= */
const srcModeEl = document.getElementById('src-mode');
const acledRow = document.getElementById('acled-key-row');
function syncSourceUI(){
  const mode = srcModeEl.value;
  acledRow.style.display = (mode==='acled' || mode==='both') ? 'flex' : 'none';
}
srcModeEl.onchange = syncSourceUI;
syncSourceUI();

/* =============================
   Filters
============================= */
function iso3ForQuery(){ return pickedISO3.length ? pickedISO3 : RECAP_ISO3; }
function itemMatchesPartner(it, partner){
  if(!partner) return true;
  const s = (it.source||'').toLowerCase();
  const p = partner.toLowerCase();
  return s.includes(p);
}
function applyFilters(items){
  let out = (items||[]).slice();
  if(selectedISO3) out = out.filter(it => String(it.iso3||'') === String(selectedISO3));
  if(selectedPartner) out = out.filter(it => it.sourceType !== 'acled' && itemMatchesPartner(it, selectedPartner));
  if(listSpecialMode==='high') out = out.filter(it => it.risk && it.risk.riskLevel==='high');
  else if(listSpecialMode==='c4') out = out.filter(it => (it.conflictIndex||0) >= 4);
  return out;
}
document.getElementById('filter-country').onchange = (e)=>{ selectedISO3 = e.target.value||""; applyFiltersAndRender(); };
document.getElementById('filter-partner').onchange = (e)=>{ selectedPartner = e.target.value||""; applyFiltersAndRender(); };
document.getElementById('btn-clear-filters').onclick = ()=>{
  selectedISO3=""; selectedPartner=""; listSpecialMode="";
  document.getElementById('filter-country').value="";
  document.getElementById('filter-partner').value="";
  applyFiltersAndRender();
};
document.getElementById('kpi-high-tile').onclick = ()=>{ listSpecialMode = (listSpecialMode==='high')?'':'high'; applyFiltersAndRender(); };
document.getElementById('kpi-c4-tile').onclick   = ()=>{ listSpecialMode = (listSpecialMode==='c4')?'':'c4'; applyFiltersAndRender(); };

/* =============================
   Partner dropdown
============================= */
const DEFAULT_PARTNERS = ['UNDP','UNICEF','WFP','UNHCR','IOM','WHO','FAO','UNFPA','UN Women','OCHA'];
function normalizePartnerName(x){ return String(x||'').trim(); }
function parsePartnersFromSourceField(sourceStr){
  return String(sourceStr||'').split(',').map(s=>normalizePartnerName(s)).filter(Boolean);
}
function buildPartnerOptions(items){
  const set = new Set();
  DEFAULT_PARTNERS.forEach(p=>set.add(p));
  items.forEach(it=>{
    if(it.sourceType!=='reliefweb') return;
    parsePartnersFromSourceField(it.source).forEach(p=>set.add(p));
  });
  const arr = Array.from(set).filter(Boolean);
  arr.sort((a,b)=>a.localeCompare(b));
  return arr;
}
function renderPartnerDropdown(items){
  const sel = document.getElementById('filter-partner');
  const opts = buildPartnerOptions(items);
  const current = selectedPartner || "";
  sel.innerHTML = `<option value="">All</option>` + opts.map(p=>`<option value="${escapeAttr(p)}">${escapeHTML(p)}</option>`).join('');
  sel.value = current;
}
function renderCountryDropdown(){
  const sel = document.getElementById('filter-country');
  const current = selectedISO3 || "";
  sel.innerHTML =
    `<option value="">All</option>` +
    RECAP_MAP.map(d=>`<option value="${escapeAttr(d.iso3)}">${escapeHTML(d.name)} (${escapeHTML(d.iso3)})</option>`).join('');
  sel.value = current;
}
renderCountryDropdown();

/* =============================
   Country set modal
============================= */
const countryModal = document.getElementById('country-modal');
document.getElementById('btn-country').onclick = () => {
  const grid = document.getElementById('c-grid');
  grid.innerHTML = RECAP_MAP.map(d=>{
    const checked = pickedISO3.includes(d.iso3) ? 'checked' : '';
    return `
      <label style="display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(15,22,32,.25)">
        <input type="checkbox" value="${d.iso3}" ${checked}>
        <span>${escapeHTML(d.name)} <span class="badge">${escapeHTML(d.iso3)}</span></span>
      </label>`;
  }).join('');
  countryModal.style.display='flex';
};
document.getElementById('c-close').onclick = ()=> countryModal.style.display='none';
document.getElementById('c-clear').onclick = ()=>{
  pickedISO3 = [];
  document.getElementById('country-chip').textContent = 'All 20';
  countryModal.style.display='none';
};
document.getElementById('c-apply').onclick = ()=>{
  const boxes = document.querySelectorAll('#c-grid input:checked');
  pickedISO3 = Array.from(boxes).map(b=>b.value);
  document.getElementById('country-chip').textContent = pickedISO3.length ? ('Selected '+pickedISO3.length) : 'All 20';
  countryModal.style.display='none';
};
countryModal.onclick = (e)=>{ if(e.target.id==='country-modal') countryModal.style.display='none'; };

/* =============================
   Summary modal
============================= */
const modal = document.getElementById('modal');
document.getElementById('m-close').onclick = ()=> modal.style.display='none';
modal.onclick = (e)=>{ if(e.target.id==='modal') modal.style.display='none'; };
window.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    modal.style.display='none';
    countryModal.style.display='none';
  }
});

/* =============================
   Map (Leaflet)
============================= */
const map = L.map('map', { zoomControl:true, preferCanvas:true }).setView([15, 20], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 10,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let countryLayer = L.layerGroup().addTo(map);
let acledLayer = L.layerGroup().addTo(map);

function getWindowedItems24m(items){
  const now = Date.now();
  const since = now - 730*86400000;
  return (items||[]).filter(it=>{
    const t = Date.parse(it.created);
    return isNaN(t) ? true : (t>=since);
  });
}
function aggregateByCountry(items, metric, agg){
  const buckets = {};
  items.forEach(it=>{
    if(!it.iso3) return;
    if(it.sourceType==='acled') return;
    const v = (metric==='conflictIndex') ? it.conflictIndex : it.riskScore;
    if(v==null || !isFinite(v)) return;
    if(!buckets[it.iso3]) buckets[it.iso3]=[];
    buckets[it.iso3].push(Number(v));
  });

  const iso3s = (pickedISO3.length ? pickedISO3.slice() : RECAP_ISO3.slice());
  return iso3s.map(iso3=>{
    const arr=buckets[iso3]||[];
    let value=null;
    if(arr.length){
      value = (agg==='max') ? Math.max(...arr) : (arr.reduce((a,b)=>a+b,0)/arr.length);
    }
    return { iso3, value, n: arr.length };
  });
}
function colorByValue(v, metric){
  if(v==null) return '#6b7b90';
  if(metric==='conflictIndex'){
    if(v>=4.5) return '#ff5c5c';
    if(v>=3.0) return '#f2b45a';
    return '#43c174';
  }else{
    if(v>=18) return '#ff5c5c';
    if(v>=8) return '#f2b45a';
    return '#43c174';
  }
}
function acledStyleFromFatalities(f){
  const fat = Number(f||0);
  const radius = clamp(3 + Math.sqrt(Math.max(0,fat))*1.2, 3, 14);
  let color = '#43c174';
  if(fat>=10) color = '#ff5c5c';
  else if(fat>=1) color = '#f2b45a';
  return {radius, color};
}

function setCountryFilter(iso3){
  selectedISO3 = iso3 || "";
  document.getElementById('filter-country').value = selectedISO3;
  applyFiltersAndRender();
}

function renderMap(){
  countryLayer.clearLayers();
  acledLayer.clearLayers();
  if(!currentItems.length) return;

  const filtered = applyFilters(currentItems);

  const mode = document.getElementById('src-mode').value;
  const layerMode = document.getElementById('map-layer').value;
  const effective = (layerMode==='auto') ? (mode==='both'?'both':mode) : layerMode;

  if(effective==='country' || effective==='both' || effective==='reliefweb'){
    const metric = document.getElementById('map-metric').value;
    const agg = document.getElementById('map-agg').value;
    const items24 = getWindowedItems24m(filtered);
    const rows = aggregateByCountry(items24, metric, agg);
    rows.forEach(r=>{
      const ll = COUNTRY_CENTROIDS[r.iso3];
      if(!ll) return;
      const color = colorByValue(r.value, metric);
      const radius = 10 + clamp(r.n, 0, 40) * 0.45;
      const name = (RECAP_MAP.find(x=>x.iso3===r.iso3)||{}).name || r.iso3;
      const vtxt = (r.value==null) ? '—' : (Math.round(r.value*10)/10);
      const label = metric==='conflictIndex' ? 'Heat' : 'Risk';

      const circle = L.circleMarker(ll,{
        radius, color, weight:2, fillColor:color, fillOpacity:.35
      });

      circle.bindPopup(`
        <div style="font-family:system-ui; font-size:13px;">
          <div style="font-weight:700;margin-bottom:6px;">${escapeHTML(name)} <span style="opacity:.8">(${escapeHTML(r.iso3)})</span></div>
          <div>${escapeHTML(label)} (${escapeHTML(agg)}): <b>${escapeHTML(String(vtxt))}</b></div>
          <div style="margin-top:4px; color:#8aa0bb;">N (24M Reports): ${escapeHTML(String(r.n))}</div>
        </div>
      `);
      circle.on('click', ()=> setCountryFilter(r.iso3));
      circle.addTo(countryLayer);
    });
  }

  if(effective==='acled' || effective==='both'){
    const acledEvents = filtered.filter(it=>it.sourceType==='acled' && it.lat!=null && it.lon!=null);
    const maxPts = 1500;
    const pts = acledEvents.slice(0, maxPts);

    pts.forEach(ev=>{
      const {radius, color} = acledStyleFromFatalities(ev.fatalities);
      const m = L.circleMarker([ev.lat, ev.lon],{
        radius, color, weight:1.5, fillColor: color, fillOpacity: .55
      });

      const when = String(ev.created||'').slice(0,10);
      const name = (RECAP_MAP.find(x=>x.iso3===ev.iso3)||{}).name || ev.iso3 || '';
      const title = ev.title || 'ACLED Event';
      const loc = [ev.location, ev.admin1].filter(Boolean).join(', ');
      const et = [ev.event_type, ev.sub_event_type].filter(Boolean).join(' / ');
      const fat = (ev.fatalities!=null) ? String(ev.fatalities) : '0';

      m.bindPopup(`
        <div style="font-family:system-ui; font-size:13px; line-height:1.35">
          <div style="font-weight:700;margin-bottom:6px;">${escapeHTML(title)}</div>
          <div style="color:#8aa0bb">${escapeHTML(when)} · ${escapeHTML(name)} (${escapeHTML(ev.iso3||'')})</div>
          <div style="margin-top:6px">${escapeHTML(et)}</div>
          <div style="margin-top:4px">${escapeHTML(loc)} · Fatalities: <b>${escapeHTML(fat)}</b></div>
        </div>
      `);

      m.on('click', ()=>{ if(ev.iso3) setCountryFilter(ev.iso3); });
      m.addTo(acledLayer);
    });
  }
}
document.getElementById('map-refresh').onclick = renderMap;
document.getElementById('map-layer').onchange = renderMap;
document.getElementById('map-metric').onchange = renderMap;
document.getElementById('map-agg').onchange = renderMap;

/* =============================
   Fetch: ReliefWeb / ACLED
============================= */
async function fetchReliefWeb(daySpan, limit){
  const url = 'https://api.reliefweb.int/v1/reports?appname=' + encodeURIComponent(APPNAME);
  const body = {
    limit: Math.min(limit, 1000),  // ReliefWeb practical cap per request
    offset: 0,
    filter:{ operator:'AND', conditions:[ {field:'country.iso3', value: iso3ForQuery()} ] },
    fields:{ include:['id','title','url','body','body-html','country','source','theme','disaster_type','date.created'] },
    sort:['date.created:desc']
  };

  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error('ReliefWeb HTTP '+res.status+' :: '+t.slice(0,220));
  }
  const json = await res.json();
  const data = json.data || [];
  const sinceMillis = Date.now() - daySpan*86400000;

  const items = data.map(r=>{
    const f=r.fields||{};
    const rawHtml=(f['body-html']||'').replace(/<style[\s\S]*?<\/style>/gi,' ').replace(/<[^>]+>/g,' ');
    const bodyText=(f.body && String(f.body).trim().length>0) ? f.body : rawHtml;

    const countryArr = (f.country||[]);
    const iso3 = countryArr.length ? (countryArr[0].iso3 || '') : '';

    const metaTxt = [
      f.title||'',
      (f.theme||[]).map(t=>t.name).join(', '),
      (f.disaster_type||[]).map(d=>d.name).join(', '),
      (f.source||[]).map(s=>s.name).join(', '),
      countryArr.map(c=>c.name).join(', ')
    ].join(' | ');

    const baseText = metaTxt + ' ' + bodyText;
    const hdp = hdpScore(baseText);
    const c15 = classifyC15(baseText,3);
    const risk = analyzeRiskAndConflict(baseText);

    return {
      id: 'rw-'+r.id,
      sourceType: 'reliefweb',
      title: f.title||'(Untitled)',
      url: f.url||'',
      created: f['date.created']||'',
      country: countryArr.map(c=>c.name).join(', '),
      iso3: iso3,
      source: (f.source||[]).map(s=>s.name).join(', '),
      theme: (f.theme||[]).map(t=>t.name).join(', '),
      type: (f.disaster_type||[]).map(d=>d.name).join(', '),
      body: bodyText,
      hdp, c15,
      risk,
      riskScore: risk.riskScore,
      conflictIndex: risk.conflictIndex
    };
  }).filter(it=>{
    const t = Date.parse(it.created);
    return isNaN(t) ? true : (t>=sinceMillis);
  });

  return items;
}

async function fetchACLED(daySpan, totalLimit){
  const key = (document.getElementById('acled-key').value||'').trim();
  const email = (document.getElementById('acled-email').value||'').trim();
  if(!key || !email) return [];

  const iso3s = iso3ForQuery();
  const since = new Date(Date.now() - daySpan*86400000);
  const sinceStr = since.toISOString().slice(0,10);

  const hardMax = Math.min(Math.max(200, totalLimit), 2000);
  const out = [];

  for(const iso3 of iso3s){
    if(out.length >= hardMax) break;

    const per = Math.min(500, hardMax - out.length);
    const url = new URL('https://api.acleddata.com/acled/read');
    url.searchParams.set('key', key);
    url.searchParams.set('email', email);
    url.searchParams.set('iso', iso3);
    url.searchParams.set('event_date', sinceStr + '|');
    url.searchParams.set('limit', String(per));
    url.searchParams.set('sort', 'event_date:desc');

    const res = await fetch(url.toString());
    if(!res.ok){
      const t = await res.text().catch(()=> '');
      throw new Error('ACLED HTTP '+res.status+' ('+iso3+') :: '+t.slice(0,220));
    }
    const json = await res.json();
    const events = (json.data || []);

    events.forEach(e=>{
      if(out.length >= hardMax) return;

      const lat = (e.latitude!=null) ? Number(e.latitude) : null;
      const lon = (e.longitude!=null) ? Number(e.longitude) : null;
      if(!(isFinite(lat) && isFinite(lon))) return;

      const name = (RECAP_MAP.find(x=>x.iso3===iso3)||{}).name || iso3;
      const title = `${e.event_type || 'Event'}${e.sub_event_type ? ' · '+e.sub_event_type : ''}`;
      const when = e.event_date || '';
      const loc = [e.location, e.admin1].filter(Boolean).join(', ');
      const fat = (e.fatalities!=null) ? Number(e.fatalities) : 0;

      const baseText = [
        'ACLED', name, iso3,
        e.event_type||'', e.sub_event_type||'',
        e.actor1||'', e.actor2||'',
        e.notes||'',
        'fatalities '+fat
      ].join(' | ');

      const hdp = hdpScore(baseText);
      const c15 = classifyC15(baseText,3);
      const risk = analyzeRiskAndConflict(baseText);

      let heat = 1;
      if(fat>=10) heat=5;
      else if(fat>=3) heat=4;
      else if(fat>=1) heat=3;
      else heat=2;
      risk.conflictIndex = Math.max(risk.conflictIndex||1, heat);

      out.push({
        id: 'acled-'+(e.event_id || (iso3+'-'+when+'-'+Math.random().toString(16).slice(2))),
        sourceType: 'acled',
        title: `ACLED · ${title}`,
        url: 'https://acleddata.com',
        created: when || new Date().toISOString(),
        country: name,
        iso3: iso3,
        source: 'ACLED',
        theme: 'Conflict & Security',
        type: 'Event',
        body: `Date: ${when}\nLocation: ${loc}\nActors: ${(e.actor1||'')}${(e.actor2?(' vs '+e.actor2):'')}\nNotes: ${(e.notes||'')}\nFatalities: ${fat}`,
        hdp, c15,
        risk,
        riskScore: risk.riskScore,
        conflictIndex: risk.conflictIndex,
        lat, lon,
        fatalities: fat,
        event_type: e.event_type || '',
        sub_event_type: e.sub_event_type || '',
        location: e.location || '',
        admin1: e.admin1 || ''
      });
    });
  }

  out.sort((a,b)=> (Date.parse(b.created)||0) - (Date.parse(a.created)||0));
  return out.slice(0, hardMax);
}

/* =============================
   Rendering
============================= */
function openSummary(it){
  const meta = [it.country, it.iso3?('('+it.iso3+')'):'', it.source, it.theme, it.type, it.sourceType].filter(Boolean).join(' · ');
  const sum = summarizeText(it.body, 6) || summarizeText([it.title, meta].join(' '), 3) || '(No Summary)';

  document.getElementById('m-title').textContent = it.title;
  document.getElementById('m-meta').textContent = meta;
  document.getElementById('m-badges').innerHTML =
    `${renderRiskBadge(it.risk)} ${renderConflictBadge(it.conflictIndex)} `+
    `<span style="margin-left:10px">${hbarHTML(it.hdp)}</span> `+
    `<span style="margin-left:10px">${renderC15Badges(it.c15)}</span>`;
  document.getElementById('m-sum').textContent = sum;
  document.getElementById('m-link').href = it.url || '#';
  modal.style.display='flex';
}

function renderTable(items){
  const box = document.getElementById('results');
  if(!items.length){
    box.innerHTML = '<div class="small">No Items.</div>';
    return;
  }

  const rows = items.map((it,i)=>`
    <tr>
      <td>${escapeHTML(String(it.created||'').slice(0,10))}</td>
      <td class="title-cell" data-i="${i}">${escapeHTML(it.title)}</td>
      <td>${escapeHTML(it.country||'')}</td>
      <td>${escapeHTML(it.source||'')}</td>
      <td>${renderRiskBadge(it.risk)}</td>
      <td>${renderConflictBadge(it.conflictIndex)}</td>
      <td>${hbarHTML(it.hdp)}</td>
      <td>${renderC15Badges(it.c15)}</td>
      <td>${it.url?`<a href="${escapeAttr(it.url)}" target="_blank" rel="noopener">Link</a>`:''}</td>
    </tr>
  `).join('');

  box.innerHTML = `
    <div style="max-height:58vh; overflow:auto; border:1px solid var(--line); border-radius:16px">
      <table>
        <thead>
          <tr>
            <th style="width:96px">Date</th>
            <th>Title</th>
            <th style="width:180px">Country</th>
            <th style="width:170px">Source</th>
            <th style="width:90px">Risk</th>
            <th style="width:110px">Conflict</th>
            <th style="width:90px">HDP</th>
            <th style="width:120px">C-Codes</th>
            <th style="width:70px">Url</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  box.querySelectorAll('.title-cell').forEach(td=>{
    td.onclick = ()=>{
      const idx = Number(td.dataset.i);
      const it = items[idx];
      if(it) openSummary(it);
    };
  });
}

function pctBar(el, numerator, denom){
  const p = denom>0 ? (numerator/denom)*100 : 0;
  el.style.width = clamp(p, 0, 100).toFixed(1) + '%';
}
function formatTopList(arr){
  if(!arr.length) return '—';
  return arr.map(x=>x.label).join(' · ');
}

function updateDashboard(filtered){
  const total = filtered.length;
  const reports = filtered.filter(x=>x.sourceType==='reliefweb').length;
  const events = filtered.filter(x=>x.sourceType==='acled').length;

  const high = filtered.filter(x=>x.risk && x.risk.riskLevel==='high').length;
  const c4 = filtered.filter(x=>(x.conflictIndex||0)>=4).length;

  const h = filtered.filter(x=>x.hdp && x.hdp.H==='yes').length;
  const d = filtered.filter(x=>x.hdp && x.hdp.D==='yes').length;
  const p = filtered.filter(x=>x.hdp && x.hdp.P==='yes').length;

  const codeCount = {};
  filtered.forEach(it=>{
    (it.c15||[]).forEach(c=>{
      codeCount[c.code] = (codeCount[c.code]||0) + 1;
    });
  });
  const topCodes = Object.entries(codeCount)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(([code,n])=>({label:`${code}(${n})`, code, n}));

  const byC = {};
  filtered.forEach(it=>{
    const iso = it.iso3 || 'UNK';
    byC[iso] = (byC[iso]||0) + 1;
  });
  const topCountries = Object.entries(byC)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)
    .map(([iso,n])=>{
      const nm = (RECAP_MAP.find(x=>x.iso3===iso)||{}).name || iso;
      return {label:`${nm}(${n})`, iso, n};
    });

  const byP = {};
  filtered.forEach(it=>{
    if(it.sourceType!=='reliefweb') return;
    parsePartnersFromSourceField(it.source).forEach(org=>{
      if(!org) return;
      byP[org] = (byP[org]||0) + 1;
    });
  });
  const topPartners = Object.entries(byP)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)
    .map(([org,n])=>({label:`${org}(${n})`, org, n}));

  const latest = filtered
    .map(it=>Date.parse(it.created))
    .filter(t=>!isNaN(t))
    .sort((a,b)=>b-a)[0];
  const latestStr = latest ? new Date(latest).toISOString().slice(0,10) : '—';

  document.getElementById('kpi-items').textContent = String(total);
  document.getElementById('kpi-reports').textContent = String(reports);
  document.getElementById('kpi-events').textContent = String(events);

  document.getElementById('kpi-high').textContent = String(high);
  pctBar(document.getElementById('kpi-high-bar'), high, total);

  document.getElementById('kpi-c4').textContent = String(c4);
  pctBar(document.getElementById('kpi-c4-bar'), c4, total);

  document.getElementById('kpi-hdp').textContent =
    (total? `${Math.round((h/total)*100)}% H · ${Math.round((d/total)*100)}% D · ${Math.round((p/total)*100)}% P` : '—');

  document.getElementById('kpi-codes').textContent = formatTopList(topCodes);
  document.getElementById('kpi-codes-s').textContent = topCodes.length ? topCodes.map(x=>{
    const nm = (CODES[x.code]||{}).name || '';
    return `${x.code}: ${nm}`;
  }).join(' · ') : 'Top 3';

  document.getElementById('side-countries').textContent = formatTopList(topCountries);
  document.getElementById('side-partners').textContent = formatTopList(topPartners);
  document.getElementById('side-recent').textContent = latestStr;

  const scopeParts = [];
  if(selectedISO3) scopeParts.push('Country='+selectedISO3);
  if(selectedPartner) scopeParts.push('Partner='+selectedPartner);
  if(listSpecialMode) scopeParts.push('Mode='+listSpecialMode);
  document.getElementById('dash-scope').textContent = 'Scope: ' + (scopeParts.length ? scopeParts.join(', ') : 'All');
  document.getElementById('dash-window').textContent =
    'Window: ' + String(document.getElementById('days').value||'') + ' Days';
}

/* =============================
   Apply filters + render all
============================= */
function applyFiltersAndRender(){
  const filtered = applyFilters(currentItems);
  updateDashboard(filtered);
  renderTable(filtered);
  renderMap();
}

/* =============================
   Fetch orchestration
============================= */
async function runFetch(){
  const status = document.getElementById('status');
  const mode = document.getElementById('src-mode').value;

  const daySpan = Number(document.getElementById('days').value || 3650);
  const limit = MAX_ITEMS;

  status.textContent = 'Fetching...';
  status.className = 'small';

  try{
    let all = [];

    if(mode==='reliefweb' || mode==='both'){
      const rw = await fetchReliefWeb(daySpan, limit);
      all = all.concat(rw);
    }
    if(mode==='acled' || mode==='both'){
      const a = await fetchACLED(daySpan, limit);
      all = all.concat(a);
    }

    all.sort((a,b)=> (Date.parse(b.created)||0) - (Date.parse(a.created)||0));
    if(all.length > limit) all = all.slice(0, limit);

    currentItems = all;

    renderPartnerDropdown(currentItems);
    document.getElementById('filter-country').value = selectedISO3 || "";
    document.getElementById('filter-partner').value = selectedPartner || "";

    status.textContent = `Done · ${currentItems.length} Items`;
    applyFiltersAndRender();
  }catch(e){
    status.textContent = 'Error';
    status.className = 'small err';
    document.getElementById('results').innerHTML = `<div class="small err">${escapeHTML(e.message || String(e))}</div>`;
    countryLayer.clearLayers();
    acledLayer.clearLayers();
  }
}
document.getElementById('fetch').onclick = runFetch;

/* =============================
   Map controls
============================= */
document.getElementById('map-refresh').onclick = renderMap;
document.getElementById('map-layer').onchange = renderMap;
document.getElementById('map-metric').onchange = renderMap;
document.getElementById('map-agg').onchange = renderMap;

/* =============================
   Map render (requires layers & helpers above)
============================= */
function renderCountryDropdownValue(){
  document.getElementById('filter-country').value = selectedISO3 || "";
}
function renderPartnerDropdownValue(){
  document.getElementById('filter-partner').value = selectedPartner || "";
}

/* Map mode uses existing renderMap() above */

/* =============================
   Init
============================= */
document.getElementById('country-chip').textContent = 'All 20';
document.getElementById('limit-chip').textContent = 'Max';
updateDashboard([]);
renderMap();
</script>
</body>
</html>
