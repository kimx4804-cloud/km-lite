<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>km-lite v2.5 — reliefweb + acled · hdp(binary) · risk · conflict heat · c1~c15</title>

<!-- leaflet (지도) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
:root{
  --bg:#0b0f14;
  --panel:#0f1620;
  --panel2:rgba(15,22,32,.45);
  --fg:#e6eef8;
  --mut:#8aa0bb;
  --line:rgba(255,255,255,.10);
  --line2:rgba(255,255,255,.14);

  --h:#3aa3ff;
  --d:#61d661;
  --p:#f2b45a;
  --off:#364254;

  --low:#43c174;
  --med:#f2b45a;
  --high:#ff5c5c;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  padding:18px;
  background:var(--bg);
  color:var(--fg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
  letter-spacing: .1px;
}

h1{
  font-size:18px;
  margin:0 0 10px;
  font-weight:900;
}
.small{font-size:12px;color:var(--mut);line-height:1.5}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
a{color:#9bd0ff;text-decoration:none}
a:hover{text-decoration:underline}

input, button, select, textarea{
  background:var(--panel);
  color:var(--fg);
  border:1px solid var(--line);
  border-radius:10px;
  padding:.48rem .62rem;
  font-size:13px;
  outline:none;
}
button{cursor:pointer}
button:hover{border-color:var(--line2)}
textarea{width:100%}

hr{border:none;border-top:1px solid var(--line); margin:14px 0}

.container{max-width:1220px;margin:0 auto}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.spread{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.card{
  border:1px solid var(--line);
  background:var(--panel2);
  border-radius:14px;
  padding:12px;
}
.section-title{
  font-weight:900;
  font-size:13px;
  margin:0 0 8px;
  color:#dfeaff;
}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  border:1px solid var(--line);
  border-radius:999px;
  padding:3px 10px;
  font-size:11px;
  color:var(--mut);
}

.badge{
  display:inline-block;
  padding:2px 8px;
  border:1px solid var(--line);
  border-radius:999px;
  font-size:11px;
  color:var(--mut);
}

.hdp-badge{
  display:inline-block;
  padding:2px 7px;
  border-radius:8px;
  font-size:11px;
  font-weight:900;
  margin-right:4px;
  color:#000;
}
.hdp-off{ background:var(--off); color:#8da0b5; }
.hdp-H{ background:var(--h); }
.hdp-D{ background:var(--d); }
.hdp-P{ background:var(--p); }

.risk-badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:950;
  color:#000;
}
.risk-low{background:var(--low)}
.risk-med{background:var(--med)}
.risk-high{background:var(--high)}

.conf-badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:950;
  color:#000;
}
.conf-low{background:var(--low)}
.conf-med{background:var(--med)}
.conf-high{background:var(--high)}

.policy-flag{
  display:inline-block;
  padding:1px 7px;
  border-radius:999px;
  font-size:10px;
  border:1px solid var(--med);
  color:var(--med);
  margin-left:6px;
}

.err{color:#ffb4b4}
#status{min-height:16px}

#map{
  height:76vh; /* 지도 세로 확장 */
  width:100%;
  border-radius:14px;
  border:1px solid var(--line);
  overflow:hidden;
  background:#0c121a;
}
@media (max-width:860px){
  #map{height:66vh;}
}

/* 테이블 */
table{border-collapse:collapse;width:100%;font-size:13px}
th,td{border:1px solid var(--line);padding:8px;vertical-align:top;text-align:left}
th{background:#0f1620;position:sticky;top:0;z-index:1}
tbody tr:hover{background:rgba(255,255,255,.03)}
.title-cell{cursor:pointer;text-decoration:underline}

/* 모달 */
.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.62);
  z-index:1000;
  align-items:center;justify-content:center;
  padding:16px;
}
.modal > div{
  width:min(920px, 92vw);
  max-height:84vh;
  overflow:auto;
  background:var(--bg);
  border:1px solid var(--line2);
  border-radius:14px;
  padding:16px;
  box-shadow:0 0 22px rgba(0,0,0,.55);
}
.modal h3{margin:0 0 8px;font-size:16px;font-weight:950}
.modal .meta{margin:0 0 10px;color:var(--mut);font-size:12px}
pre.wrap{white-space:pre-wrap;margin:0;font-size:13px;line-height:1.6;color:#dce8f7}
</style>
</head>

<body>
<div class="container">
  <h1>recap km-lite v2.5</h1>
  <div class="small">
    · 로컬 실행 권장: <span class="mono">py -m http.server 8000</span><br/>
    · <b>사용자 제공 정량자료가 필요한 지표(PQI 등)는 제거</b>. 현재는 <b>문서/이벤트 기반</b> 지표만 계산합니다.<br/>
    · 지도에서 <b>국가(원) 또는 ACLED 이벤트(점)</b>를 클릭하면 해당 국가로 <b>리스트가 필터링</b>됩니다.
  </div>

  <hr/>

  <!-- 컨트롤 -->
  <div class="card">
    <div class="spread">
      <div class="row">
        <span class="pill">data</span>
        <select id="src-mode" title="데이터 소스">
          <option value="reliefweb">reliefweb reports</option>
          <option value="acled">acled events (requires key)</option>
          <option value="both">both</option>
        </select>

        <span class="pill">window</span>
        <label class="small">최근 일수</label>
        <input id="days" type="number" value="365" style="width:92px"/>

        <label class="small">최대 개수</label>
        <input id="limit" type="number" value="300" style="width:92px"/>

        <button id="btn-country">국가 필터</button>
        <span id="country-chip" class="badge">전체 20개국</span>

        <span class="pill">filters</span>
        <label class="small">country</label>
        <select id="filter-country" style="min-width:190px">
          <option value="">all</option>
        </select>

        <label class="small">partner</label>
        <select id="filter-partner" style="min-width:210px">
          <option value="">all</option>
        </select>

        <button id="btn-clear-filters" title="country/partner 필터 해제">필터 해제</button>
      </div>

      <div class="row">
        <button id="fetch">가져오기</button>
        <span id="status" class="small"></span>
      </div>
    </div>

    <div id="acled-key-row" class="row" style="margin-top:10px; display:none;">
      <span class="pill">acled</span>
      <label class="small">api key</label>
      <input id="acled-key" placeholder="ACLED_API_KEY" style="min-width:240px; flex:1"/>
      <label class="small">email</label>
      <input id="acled-email" placeholder="you@example.com" style="min-width:220px; flex:1"/>
      <span class="small">· acled은 개인키가 있어야 호출됩니다(없으면 스킵).</span>
    </div>
  </div>

  <hr/>

  <!-- 지도 -->
  <div class="card">
    <div class="spread" style="margin-bottom:8px;">
      <div class="section-title">map view</div>
      <div class="row">
        <select id="map-metric" title="지도 지표(국가 집계용)">
          <option value="conflictIndex">country aggregate: conflict heat</option>
          <option value="riskScore">country aggregate: risk score</option>
        </select>
        <select id="map-agg" title="집계 방식">
          <option value="max">max</option>
          <option value="mean">mean</option>
        </select>
        <select id="map-layer" title="지도 레이어">
          <option value="auto">auto</option>
          <option value="country">country aggregates</option>
          <option value="acled">acled points</option>
          <option value="both">both</option>
        </select>
        <button id="map-refresh">지도 갱신</button>
      </div>
    </div>
    <div class="small" style="margin-bottom:10px">
      · 국가 집계는 “최근 24개월” 윈도우 기준(대략 730일).<br/>
      · ACLED는 이벤트를 <b>좌표 점</b>으로 표시합니다(치명도/사망자수 기반 크기).
    </div>
    <div id="map"></div>
  </div>

  <hr/>

  <!-- 결과 -->
  <div class="card">
    <div class="section-title">items</div>
    <div id="results" class="small">가져오기를 실행하세요.</div>
  </div>
</div>

<!-- 요약 모달 -->
<div id="modal" class="modal">
  <div>
    <div class="spread">
      <div>
        <h3 id="m-title"></h3>
        <div id="m-meta" class="meta"></div>
      </div>
      <button id="m-close">닫기</button>
    </div>
    <div id="m-badges" style="margin:10px 0"></div>
    <pre id="m-sum" class="wrap"></pre>
    <div style="margin-top:12px">
      <a id="m-link" href="#" target="_blank" rel="noopener">원문 보기</a>
    </div>
  </div>
</div>

<!-- 국가 필터 모달 -->
<div id="country-modal" class="modal">
  <div>
    <div class="spread">
      <div>
        <h3>국가 필터</h3>
        <div class="small">체크 후 적용 (가져오기에 반영)</div>
      </div>
      <button id="c-close">닫기</button>
    </div>
    <div id="c-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-top:10px"></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="c-clear">초기화</button>
      <button id="c-apply">적용</button>
    </div>
  </div>
</div>

<script>
/* =============================
   유틸
============================= */
function escapeHTML(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

/* =============================
   상수 & 국가
============================= */
const APPNAME = "HyunKim+recap_km_lite+a5Ttg7U8"; // ReliefWeb appname

const RECAP_NAMES = [
  'Burundi','Central African Republic','Comoros','Guinea','Kenya','Mali',
  'Sao Tome and Principe','Somalia','South Sudan','Zimbabwe',
  'Armenia','Iran','Jordan','Lebanon','Palestine','Syria','Yemen',
  'Papua New Guinea','Solomon Islands','Timor-Leste'
];
const RECAP_ISO3 = [
  'BDI','CAF','COM','GIN','KEN','MLI',
  'STP','SOM','SSD','ZWE',
  'ARM','IRN','JOR','LBN','PSE','SYR','YEM',
  'PNG','SLB','TLS'
];
const RECAP_MAP = RECAP_NAMES.map((n,i)=>({name:n,iso3:RECAP_ISO3[i]}));

/* 국가 대략 중심 좌표(국가 집계 표시용) */
const COUNTRY_CENTROIDS = {
  BDI:[-3.3731,29.9189],
  CAF:[ 6.6111,20.9394],
  COM:[-11.6455,43.3333],
  GIN:[10.4362,-10.9407],
  KEN:[ 0.0236,37.9062],
  MLI:[17.5707,-3.9962],
  STP:[ 0.1864, 6.6131],
  SOM:[ 5.1521,46.1996],
  SSD:[ 6.8770,31.3070],
  ZWE:[-19.0154,29.1549],
  ARM:[40.0691,45.0382],
  IRN:[32.4279,53.6880],
  JOR:[30.5852,36.2384],
  LBN:[33.8547,35.8623],
  PSE:[31.9522,35.2332],
  SYR:[34.8021,38.9968],
  YEM:[15.5527,48.5164],
  PNG:[-6.3140,143.9555],
  SLB:[-9.6457,160.1562],
  TLS:[-8.8742,125.7275]
};

let pickedISO3 = [];
let currentItems = []; // unified items (reports + acled events)
let selectedISO3 = ""; // click-filter country
let selectedPartner = ""; // dropdown filter

/* =============================
   HDP binary
============================= */
const HDP_DICT = {
  H:['emergency','relief','response','humanitarian','displacement','refugee','cholera','outbreak','famine','flood','earthquake','evacuation','cash assistance','wash cluster','rapid'],
  D:['development','infrastructure','education','school','clinic','health system','primary care','livelihoods','capacity building','policy','programme','investment','training','supply chain','renewable','solar','water supply','monitoring','m&e'],
  P:['peace','cohesion','conflict','mediation','grievance','inclusive','social contract','community committee','youth','women participation','accountability','complaints','do no harm']
};

function hdpScore(text){
  const T = (text || '').toLowerCase();
  const anyHit = arr => arr.some(w => T.includes(w)) ? "yes" : "no";
  const H = anyHit(HDP_DICT.H);
  const D = anyHit(HDP_DICT.D);
  const P = anyHit(HDP_DICT.P);
  return { H, D, P, label:`H:${H} / D:${D} / P:${P}` };
}
function hbarHTML(score){
  if(!score) return '';
  const hx = score.H === "yes" ? `<span class="hdp-badge hdp-H">H</span>` : `<span class="hdp-badge hdp-off">H</span>`;
  const dx = score.D === "yes" ? `<span class="hdp-badge hdp-D">D</span>` : `<span class="hdp-badge hdp-off">D</span>`;
  const px = score.P === "yes" ? `<span class="hdp-badge hdp-P">P</span>` : `<span class="hdp-badge hdp-off">P</span>`;
  return `<div>${hx}${dx}${px}</div>`;
}

/* =============================
   TF-IDF 요약
============================= */
function summarizeText(text,maxSentences){
  maxSentences = maxSentences || 5;
  if(!text) return '';
  let sents = text
    .split(/(?<=[.!?。！？])\s+|[\r\n]{2,}/)
    .map(s=>s.trim())
    .filter(s=>s.length>20);
  if(!sents.length) return '';
  if(sents.length<=maxSentences) return sents.join(' ');

  function tokenize(s){
    return s.toLowerCase()
      .replace(/[^a-z0-9가-힣\s]/g,' ')
      .split(/\s+/).filter(Boolean);
  }

  const stop = new Set([
    'the','and','for','with','that','this','from','are','was','were',
    'have','has','had','of','in','to','on','by','as','is','be','or',
    'at','an','a','it','its','their','our','we','you','they','into',
    'over','under','between','within','through','about','after','before',
    'during','against','among','per','및','그리고','그러나','또는','에서',
    '으로','에는','에','를','을','이','가','은','는','와','과','하다',
    '했다','대한','위한'
  ]);

  const tf={},df={},sentTokens=[];
  sents.forEach((s,i)=>{
    const ws = tokenize(s).filter(w=>!stop.has(w));
    sentTokens[i]=ws;
    const seen={};
    ws.forEach(w=>{
      tf[w]=(tf[w]||0)+1;
      if(!seen[w]){ df[w]=(df[w]||0)+1; seen[w]=1; }
    });
  });

  const N=sents.length;
  const scored=sents.map((s,i)=>{
    let sc=0;
    sentTokens[i].forEach(w=>{
      const idf=Math.log((N+1)/((df[w]||1)+1));
      sc += (tf[w]||0)*idf;
    });
    const len=s.length;
    const lenAdj=(len<40?0.85:(len>300?0.9:1));
    return {i,score:sc*lenAdj};
  });
  scored.sort((a,b)=>b.score-a.score);
  scored.splice(maxSentences);
  scored.sort((a,b)=>a.i-b.i);
  return scored.map(x=>sents[x.i]).join(' ');
}

/* =============================
  Risk / Conflict / Policy
============================= */
const RISK_DICT = {
  security: [
    'security incident','armed group','militia','attack','shelling','airstrike','kidnapping',
    'detention','harassment','checkpoint','intimidation','armed clashes','violence','threat'
  ],
  access: [
    'access constraint','access restriction','movement restriction','road closure',
    'inaccessible','denied access','limited access','suspension of operations','evacuation of staff'
  ],
  political: [
    'coup','political crisis','election violence','crackdown','state of emergency',
    'martial law','sanctions','diplomatic tension'
  ],
  logistics: [
    'supply disruption','pipeline break','stockout','shortage of supplies',
    'transport disruption','logistical challenge','import restriction'
  ],
  climate: [
    'flood','drought','cyclone','typhoon','landslide','storm surge','heatwave',
    'climate shock','extreme weather'
  ],
  partner: [
    'governance issue','mismanagement','corruption','fraud','misprocurement',
    'partner capacity gap','weak management'
  ]
};
const POLICY_TERMS = [
  'new regulation','regulation change','policy revision','policy change',
  'government decree','government directive','ministerial order','new law',
  'legislation','suspension order','ban on','prohibited','visa restriction','border closure'
];
const CONFLICT_TERMS = [
  'armed clashes','clashes','fighting','battle','frontline','shelling','airstrike',
  'armed group','militia','non-state armed','violence','attack','ambush','raid',
  'displacement due to conflict','conflict-affected','hostilities'
];

function analyzeRiskAndConflict(text){
  const T = (text || '').toLowerCase();
  let rawScore = 0;
  const tags = [];

  const countHits = (arr, weight, tagName) => {
    let cnt = 0;
    arr.forEach(term=>{
      const t = term.toLowerCase();
      if(!t) return;
      const re = new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
      const m = T.match(re);
      if(m && m.length) cnt += m.length;
    });
    if(cnt>0){
      rawScore += cnt * weight;
      tags.push(tagName + '('+cnt+')');
    }
  };

  countHits(RISK_DICT.security, 3, 'security');
  countHits(RISK_DICT.access,   2.5,'access');
  countHits(RISK_DICT.political,2.5,'political');
  countHits(RISK_DICT.logistics,2,  'logistics');
  countHits(RISK_DICT.climate,  2,  'climate');
  countHits(RISK_DICT.partner,  2,  'partner');

  let level = 'low';
  if(rawScore >= 18) level = 'high';
  else if(rawScore >= 8) level = 'med';

  // conflict heat 1~5 (텍스트 기반)
  let conflictScore = 0;
  CONFLICT_TERMS.forEach(term=>{
    const re = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
    const m = T.match(re);
    if(m && m.length) conflictScore += m.length;
  });
  let conflictIndex = 1;
  if(conflictScore >= 8) conflictIndex = 5;
  else if(conflictScore >= 4) conflictIndex = 4;
  else if(conflictScore >= 2) conflictIndex = 3;
  else if(conflictScore >= 1) conflictIndex = 2;

  // policy flag
  let policy = false;
  POLICY_TERMS.forEach(term=>{ if(T.includes(term.toLowerCase())) policy = true; });

  return { riskScore: rawScore, riskLevel: level, riskTags: tags, conflictIndex, policyFlag: policy };
}

function renderRiskBadge(r){
  if(!r) return '';
  const txt = r.riskLevel === 'high' ? 'high' : r.riskLevel === 'med' ? 'med' : 'low';
  const cls = r.riskLevel === 'high' ? 'risk-high' : r.riskLevel === 'med' ? 'risk-med' : 'risk-low';
  const policy = r.policyFlag ? `<span class="policy-flag">policy</span>` : '';
  return `<span class="risk-badge ${cls}">${txt}</span>${policy}`;
}
function renderConflictBadge(idx){
  if(!idx) idx = 1;
  let cls='conf-low';
  if(idx<=2) cls='conf-low';
  else if(idx<=4) cls='conf-med';
  else cls='conf-high';
  return `<span class="conf-badge ${cls}">heat ${idx}</span>`;
}

/* =============================
  c1~c15 분류(상위 3)
============================= */
const CODES = {
  C1:{name:'사업·프로젝트 개요 & 배경',core:['background','project overview','context analysis','needs assessment','맥락','배경'],related:['objective','goal','목표'],ref:['overview']},
  C2:{name:'이해관계자 분석',core:['stakeholder analysis','actor mapping','이해관계자'],related:['partner','community'],ref:['coordination']},
  C3:{name:'논리모형 & 성과경로',core:['theory of change','logic model','results chain','논리모형'],related:['outcome','impact','assumption'],ref:['logframe']},
  C4:{name:'실행 및 운영관리',core:['implementation plan','operational plan','운영 계획'],related:['workplan','sop'],ref:['project management']},
  C5:{name:'모니터링 & 평가',core:['monitoring and evaluation','m&e system','indicator framework','평가 계획'],related:['baseline','endline','data quality'],ref:['reporting']},
  C6:{name:'성과(산출/성과)',core:['outputs achieved','output','deliverable'],related:['beneficiaries reached','coverage','training','workshop'],ref:['result']},
  C7:{name:'영향(impact)',core:['impact evaluation','long-term impact','제도적 변화'],related:['behaviour change','policy change'],ref:['impact']},
  C8:{name:'지속가능성',core:['sustainability plan','exit strategy','지속가능성'],related:['scaling','handover'],ref:['continuity']},
  C9:{name:'비용효율성',core:['cost-effectiveness','value for money','비용 효과성'],related:['unit cost','budget'],ref:['financial']},
  C10:{name:'리스크 & 적응성',core:['risk analysis','risk mitigation','contingency','리스크'],related:['adaptive management'],ref:['constraint']},
  C11:{name:'젠더/포용',core:['gender analysis','psea','젠더'],related:['inclusion','disability'],ref:['leave no one behind']},
  C12:{name:'거버넌스/책임성',core:['accountability','complaints mechanism','grievance'],related:['transparency'],ref:['governance']},
  C13:{name:'환경/기후',core:['climate risk assessment','environmental impact','기후 위험'],related:['drr','resilience'],ref:['climate']},
  C14:{name:'교훈/확산',core:['lessons learned','good practices','교훈'],related:['case study','innovation'],ref:['takeaways']},
  C15:{name:'한계/권고',core:['limitations','recommendations','권고'],related:['bottlenecks','constraints'],ref:['way forward']}
};

function classifyC15(text, topN){
  topN = topN || 3;
  if(!text) return [];
  const T = text.toLowerCase();
  const words = T.split(/[^a-z0-9가-힣]+/).filter(Boolean);
  const wordCount = words.length || 1;
  const results = [];

  for(const code in CODES){
    const cfg=CODES[code];
    let score=0;
    const addHits=(list,w)=>{
      (list||[]).forEach(term=>{
        const t=term.toLowerCase();
        const re=new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
        const m=T.match(re);
        if(m&&m.length) score+=w*m.length;
      });
    };
    addHits(cfg.core,3); addHits(cfg.related,2); addHits(cfg.ref,1);
    const norm=score/(1+Math.log(wordCount));
    if(norm>0) results.push({code,name:cfg.name,s:norm});
  }
  results.sort((a,b)=>b.s-a.s);
  return results.slice(0,topN);
}
function renderC15Badges(arr){
  if(!arr || !arr.length) return '<span class="small" style="color:#8698b0">—</span>';
  return arr.map(x=>`<span class="badge" title="${escapeAttr(x.name)}">${escapeHTML(x.code)}</span>`).join(' ');
}

/* =============================
   UI: 국가 필터 모달(가져오기 대상)
============================= */
const countryModal = document.getElementById('country-modal');
document.getElementById('btn-country').onclick = () => {
  const grid = document.getElementById('c-grid');
  grid.innerHTML = RECAP_MAP.map(d=>{
    const checked = pickedISO3.includes(d.iso3) ? 'checked' : '';
    return `
      <label style="display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(15,22,32,.25)">
        <input type="checkbox" value="${d.iso3}" ${checked}>
        <span>${escapeHTML(d.name)} <span class="badge">${escapeHTML(d.iso3)}</span></span>
      </label>`;
  }).join('');
  countryModal.style.display='flex';
};
document.getElementById('c-close').onclick = ()=> countryModal.style.display='none';
document.getElementById('c-clear').onclick = ()=>{
  pickedISO3 = [];
  document.getElementById('country-chip').textContent = '전체 20개국';
  countryModal.style.display='none';
};
document.getElementById('c-apply').onclick = ()=>{
  const boxes = document.querySelectorAll('#c-grid input:checked');
  pickedISO3 = Array.from(boxes).map(b=>b.value);
  document.getElementById('country-chip').textContent = pickedISO3.length ? (pickedISO3.length+'개국 선택') : '전체 20개국';
  countryModal.style.display='none';
};
countryModal.onclick = (e)=>{ if(e.target.id==='country-modal') countryModal.style.display='none'; };

/* =============================
   모달(요약)
============================= */
const modal = document.getElementById('modal');
document.getElementById('m-close').onclick = ()=> modal.style.display='none';
modal.onclick = (e)=>{ if(e.target.id==='modal') modal.style.display='none'; };

/* esc */
window.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    modal.style.display='none';
    countryModal.style.display='none';
  }
});

/* =============================
   소스 선택 UI
============================= */
const srcModeEl = document.getElementById('src-mode');
const acledRow = document.getElementById('acled-key-row');
function syncSourceUI(){
  const mode = srcModeEl.value;
  acledRow.style.display = (mode==='acled' || mode==='both') ? 'flex' : 'none';
}
srcModeEl.onchange = syncSourceUI;
syncSourceUI();

/* =============================
   Map (Leaflet)
============================= */
const map = L.map('map', { zoomControl:true, preferCanvas:true }).setView([15, 20], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 10,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// layers
let countryLayer = L.layerGroup().addTo(map);
let acledLayer = L.layerGroup().addTo(map);

/* 최근 24개월 */
function getWindowedItems24m(items){
  const now = Date.now();
  const since = now - 730*86400000;
  return (items||[]).filter(it=>{
    const t = Date.parse(it.created);
    return isNaN(t) ? true : (t>=since);
  });
}

/* 국가 집계 */
function aggregateByCountry(items, metric, agg){
  const buckets = {};
  items.forEach(it=>{
    if(!it.iso3) return;
    if(it.sourceType==='acled') return; // 국가 집계는 report 중심(원하면 event 포함 가능)
    const v = (metric==='conflictIndex') ? it.conflictIndex : it.riskScore;
    if(v==null || !isFinite(v)) return;
    if(!buckets[it.iso3]) buckets[it.iso3]=[];
    buckets[it.iso3].push(Number(v));
  });

  const iso3s = (pickedISO3.length ? pickedISO3.slice() : RECAP_ISO3.slice());
  return iso3s.map(iso3=>{
    const arr=buckets[iso3]||[];
    let value=null;
    if(arr.length){
      value = (agg==='max') ? Math.max(...arr) : (arr.reduce((a,b)=>a+b,0)/arr.length);
    }
    return { iso3, value, n: arr.length };
  });
}

function colorByValue(v, metric){
  if(v==null) return '#6b7b90';
  if(metric==='conflictIndex'){
    if(v>=4.5) return '#ff5c5c';
    if(v>=3.0) return '#f2b45a';
    return '#43c174';
  }else{
    if(v>=18) return '#ff5c5c';
    if(v>=8) return '#f2b45a';
    return '#43c174';
  }
}

/* ACLED 이벤트 포인트 스타일(사망자수 기반) */
function acledStyleFromFatalities(f){
  const fat = Number(f||0);
  const radius = clamp(3 + Math.sqrt(Math.max(0,fat))*1.2, 3, 14);
  let color = '#43c174';
  if(fat>=10) color = '#ff5c5c';
  else if(fat>=1) color = '#f2b45a';
  return {radius, color};
}

/* 지도 렌더 */
function renderMap(){
  countryLayer.clearLayers();
  acledLayer.clearLayers();

  if(!currentItems.length) return;

  const mode = document.getElementById('src-mode').value;
  const layerMode = document.getElementById('map-layer').value;
  const effective = (layerMode==='auto') ? (mode==='both'?'both':mode) : layerMode;

  // country aggregates
  if(effective==='country' || effective==='both' || (effective==='reliefweb')){
    const metric = document.getElementById('map-metric').value;
    const agg = document.getElementById('map-agg').value;
    const items24 = getWindowedItems24m(currentItems);
    const rows = aggregateByCountry(items24, metric, agg);
    rows.forEach(r=>{
      const ll = COUNTRY_CENTROIDS[r.iso3];
      if(!ll) return;
      const color = colorByValue(r.value, metric);
      const radius = 10 + clamp(r.n, 0, 40) * 0.45;
      const name = (RECAP_MAP.find(x=>x.iso3===r.iso3)||{}).name || r.iso3;
      const vtxt = (r.value==null) ? '—' : (Math.round(r.value*10)/10);
      const label = metric==='conflictIndex' ? 'heat' : 'risk';

      const circle = L.circleMarker(ll,{
        radius, color, weight:2, fillColor:color, fillOpacity:.35
      });

      circle.bindPopup(`
        <div style="font-family:system-ui; font-size:13px;">
          <div style="font-weight:900;margin-bottom:6px;">${escapeHTML(name)} <span style="opacity:.8">(${escapeHTML(r.iso3)})</span></div>
          <div>${escapeHTML(label)} (${escapeHTML(agg)}): <b>${escapeHTML(String(vtxt))}</b></div>
          <div style="margin-top:4px; color:#8aa0bb;">n (24개월 reports): ${escapeHTML(String(r.n))}</div>
          <div style="margin-top:6px; color:#9bd0ff;">click → filter items</div>
        </div>
      `);

      // 국가 클릭 -> 해당 국가 필터
      circle.on('click', ()=>{
        setCountryFilter(r.iso3);
      });

      circle.addTo(countryLayer);
    });
  }

  // acled points
  if(effective==='acled' || effective==='both'){
    const acledEvents = currentItems.filter(it=>it.sourceType==='acled' && it.lat!=null && it.lon!=null);
    // 과도한 점 방지: 화면에는 상위 N개만(최신순) 표시
    const maxPts = 1500;
    const pts = acledEvents.slice(0, maxPts);

    pts.forEach(ev=>{
      const {radius, color} = acledStyleFromFatalities(ev.fatalities);
      const m = L.circleMarker([ev.lat, ev.lon],{
        radius,
        color,
        weight:1.5,
        fillColor: color,
        fillOpacity: .55
      });

      const when = String(ev.created||'').slice(0,10);
      const name = (RECAP_MAP.find(x=>x.iso3===ev.iso3)||{}).name || ev.iso3 || '';
      const title = ev.title || 'ACLED event';
      const loc = [ev.location, ev.admin1].filter(Boolean).join(', ');
      const et = [ev.event_type, ev.sub_event_type].filter(Boolean).join(' / ');
      const fat = (ev.fatalities!=null) ? String(ev.fatalities) : '0';

      m.bindPopup(`
        <div style="font-family:system-ui; font-size:13px; line-height:1.35">
          <div style="font-weight:900;margin-bottom:6px;">${escapeHTML(title)}</div>
          <div style="color:#8aa0bb">${escapeHTML(when)} · ${escapeHTML(name)} (${escapeHTML(ev.iso3||'')})</div>
          <div style="margin-top:6px">${escapeHTML(et)}</div>
          <div style="margin-top:4px">${escapeHTML(loc)} · fatalities: <b>${escapeHTML(fat)}</b></div>
          <div style="margin-top:6px; color:#9bd0ff;">click → filter items</div>
        </div>
      `);

      // 이벤트 클릭 -> 해당 국가 필터
      m.on('click', ()=>{
        if(ev.iso3) setCountryFilter(ev.iso3);
      });

      m.addTo(acledLayer);
    });
  }
}

document.getElementById('map-refresh').onclick = renderMap;

/* =============================
   Filters (country click + partner dropdown)
============================= */
function iso3ForQuery(){
  return pickedISO3.length ? pickedISO3 : RECAP_ISO3;
}

function setCountryFilter(iso3){
  selectedISO3 = iso3 || "";
  // 드롭다운 동기화
  document.getElementById('filter-country').value = selectedISO3;
  applyFiltersAndRender();
}

function setPartnerFilter(p){
  selectedPartner = p || "";
  document.getElementById('filter-partner').value = selectedPartner;
  applyFiltersAndRender();
}

document.getElementById('filter-country').onchange = (e)=>{
  selectedISO3 = e.target.value || "";
  applyFiltersAndRender();
};
document.getElementById('filter-partner').onchange = (e)=>{
  selectedPartner = e.target.value || "";
  applyFiltersAndRender();
};
document.getElementById('btn-clear-filters').onclick = ()=>{
  selectedISO3 = "";
  selectedPartner = "";
  document.getElementById('filter-country').value = "";
  document.getElementById('filter-partner').value = "";
  applyFiltersAndRender();
};

function itemMatchesPartner(it, partner){
  if(!partner) return true;
  // reliefweb: source 문자열에 포함
  const s = (it.source||'').toLowerCase();
  const p = partner.toLowerCase();
  return s.includes(p);
}

function applyFilters(items){
  let out = (items||[]).slice();

  if(selectedISO3){
    out = out.filter(it => String(it.iso3||'') === String(selectedISO3));
  }
  if(selectedPartner){
    out = out.filter(it => it.sourceType !== 'acled' && itemMatchesPartner(it, selectedPartner));
  }
  return out;
}

/* =============================
   partner dropdown 구성
============================= */
const DEFAULT_PARTNERS = [
  'UNDP','UNICEF','WFP','UNHCR','IOM','WHO','FAO','UNFPA','UN Women','OCHA'
];

function normalizePartnerName(x){
  return String(x||'').trim();
}

function parsePartnersFromSourceField(sourceStr){
  // ReliefWeb source는 "UNDP, UNICEF, ..." 형태일 수 있음
  // 쉼표 기반 분해 + trim
  return String(sourceStr||'')
    .split(',')
    .map(s=>normalizePartnerName(s))
    .filter(Boolean);
}

function buildPartnerOptions(items){
  const set = new Set();
  DEFAULT_PARTNERS.forEach(p=>set.add(p));

  items.forEach(it=>{
    if(it.sourceType!=='reliefweb') return;
    parsePartnersFromSourceField(it.source).forEach(p=>set.add(p));
  });

  const arr = Array.from(set).filter(Boolean);
  arr.sort((a,b)=>a.localeCompare(b));
  return arr;
}

function renderPartnerDropdown(items){
  const sel = document.getElementById('filter-partner');
  const opts = buildPartnerOptions(items);

  const current = selectedPartner || "";
  sel.innerHTML = `<option value="">all</option>` + opts.map(p=>`<option value="${escapeAttr(p)}">${escapeHTML(p)}</option>`).join('');
  sel.value = current;
}

/* country dropdown은 20개국 고정 */
function renderCountryDropdown(){
  const sel = document.getElementById('filter-country');
  const current = selectedISO3 || "";
  sel.innerHTML =
    `<option value="">all</option>` +
    RECAP_MAP.map(d=>`<option value="${escapeAttr(d.iso3)}">${escapeHTML(d.name)} (${escapeHTML(d.iso3)})</option>`).join('');
  sel.value = current;
}
renderCountryDropdown();

/* =============================
   데이터 fetch (ReliefWeb / ACLED)
============================= */
async function fetchReliefWeb(daySpan, limit){
  const url = 'https://api.reliefweb.int/v1/reports?appname=' + encodeURIComponent(APPNAME);

  const body = {
    limit: limit,
    offset: 0,
    filter:{
      operator:'AND',
      conditions:[
        {field:'country.iso3', value: iso3ForQuery()}
      ]
    },
    fields:{
      include:[
        'id','title','url','body','body-html','country',
        'source','theme','disaster_type','date.created'
      ]
    },
    sort:['date.created:desc']
  };

  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });

  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error('ReliefWeb HTTP '+res.status+' :: '+t.slice(0,220));
  }

  const json = await res.json();
  const data = json.data || [];

  const sinceMillis = Date.now() - daySpan*86400000;

  const items = data.map(r=>{
    const f=r.fields||{};
    const rawHtml=(f['body-html']||'')
      .replace(/<style[\s\S]*?<\/style>/gi,' ')
      .replace(/<[^>]+>/g,' ');
    const bodyText=(f.body && String(f.body).trim().length>0) ? f.body : rawHtml;

    const countryArr = (f.country||[]);
    const iso3 = countryArr.length ? (countryArr[0].iso3 || '') : '';

    const metaTxt = [
      f.title||'',
      (f.theme||[]).map(t=>t.name).join(', '),
      (f.disaster_type||[]).map(d=>d.name).join(', '),
      (f.source||[]).map(s=>s.name).join(', '),
      countryArr.map(c=>c.name).join(', ')
    ].join(' | ');

    const baseText = metaTxt + ' ' + bodyText;
    const hdp = hdpScore(baseText);
    const c15 = classifyC15(baseText,3);
    const risk = analyzeRiskAndConflict(baseText);

    return {
      id: 'rw-'+r.id,
      sourceType: 'reliefweb',
      title: f.title||'(untitled)',
      url: f.url||'',
      created: f['date.created']||'',
      country: countryArr.map(c=>c.name).join(', '),
      iso3: iso3,
      source: (f.source||[]).map(s=>s.name).join(', '),
      theme: (f.theme||[]).map(t=>t.name).join(', '),
      type: (f.disaster_type||[]).map(d=>d.name).join(', '),
      body: bodyText,
      hdp, c15,
      risk,
      riskScore: risk.riskScore,
      conflictIndex: risk.conflictIndex
    };
  }).filter(it=>{
    const t = Date.parse(it.created);
    return isNaN(t) ? true : (t>=sinceMillis);
  });

  return items;
}

/* ACLED: 이벤트를 좌표 포인트로 가져오기 */
async function fetchACLED(daySpan, totalLimit){
  const key = (document.getElementById('acled-key').value||'').trim();
  const email = (document.getElementById('acled-email').value||'').trim();
  if(!key || !email){
    return [];
  }

  const iso3s = iso3ForQuery();
  const since = new Date(Date.now() - daySpan*86400000);
  const sinceStr = since.toISOString().slice(0,10);

  // 전체 포인트 과도 방지: totalLimit과 별개로 ACLED 포인트 상한
  const hardMax = Math.min(Math.max(200, totalLimit), 2000);
  const out = [];

  // 국가별로 조금씩 가져오되, 전체 상한 도달하면 중지
  for(const iso3 of iso3s){
    if(out.length >= hardMax) break;

    // 국가별 limit: 남은 만큼
    const per = Math.min(500, hardMax - out.length);

    const url = new URL('https://api.acleddata.com/acled/read');
    url.searchParams.set('key', key);
    url.searchParams.set('email', email);
    url.searchParams.set('iso', iso3);
    // from date (형식: YYYY-MM-DD|)
    url.searchParams.set('event_date', sinceStr + '|');
    url.searchParams.set('limit', String(per));
    // 가능하면 최신순 (API 응답이 계정/버전에 따라 다를 수 있어도 안전)
    url.searchParams.set('sort', 'event_date:desc');

    const res = await fetch(url.toString());
    if(!res.ok){
      const t = await res.text().catch(()=> '');
      throw new Error('ACLED HTTP '+res.status+' ('+iso3+') :: '+t.slice(0,220));
    }
    const json = await res.json();
    const events = (json.data || []);

    events.forEach(e=>{
      if(out.length >= hardMax) return;

      const lat = (e.latitude!=null) ? Number(e.latitude) : null;
      const lon = (e.longitude!=null) ? Number(e.longitude) : null;
      if(!(isFinite(lat) && isFinite(lon))) return;

      const name = (RECAP_MAP.find(x=>x.iso3===iso3)||{}).name || iso3;

      const title = `${e.event_type || 'event'}${e.sub_event_type ? ' · '+e.sub_event_type : ''}`;
      const when = e.event_date || '';
      const loc = [e.location, e.admin1].filter(Boolean).join(', ');

      const fat = (e.fatalities!=null) ? Number(e.fatalities) : 0;

      // 텍스트 기반 risk도 계산하되, ACLED는 event_type/actor 기반 텍스트 생성
      const baseText = [
        'ACLED',
        name, iso3,
        e.event_type||'',
        e.sub_event_type||'',
        e.actor1||'', e.actor2||'',
        e.notes||'',
        'fatalities '+fat
      ].join(' | ');

      const hdp = hdpScore(baseText);
      const c15 = classifyC15(baseText,3);
      const risk = analyzeRiskAndConflict(baseText);

      // ACLED의 conflictIndex는 사망자수 기반으로 약간 보강(텍스트만으로는 약함)
      let heat = 1;
      if(fat>=10) heat=5;
      else if(fat>=3) heat=4;
      else if(fat>=1) heat=3;
      else heat=2;
      risk.conflictIndex = Math.max(risk.conflictIndex||1, heat);

      out.push({
        id: 'acled-'+(e.event_id || (iso3+'-'+when+'-'+Math.random().toString(16).slice(2))),
        sourceType: 'acled',
        title: `ACLED · ${title}`,
        url: 'https://acleddata.com', // 공개 링크(세부 event url은 계정에 따라 다름)
        created: when || new Date().toISOString(),
        country: name,
        iso3: iso3,
        source: 'ACLED',
        theme: 'conflict & security',
        type: 'event',
        body: `date: ${when}\nlocation: ${loc}\nactors: ${(e.actor1||'')}${(e.actor2?(' vs '+e.actor2):'')}\nnotes: ${(e.notes||'')}\nfatalities: ${fat}`,
        hdp, c15,
        risk,
        riskScore: risk.riskScore,
        conflictIndex: risk.conflictIndex,
        lat, lon,
        fatalities: fat,
        event_type: e.event_type || '',
        sub_event_type: e.sub_event_type || '',
        location: e.location || '',
        admin1: e.admin1 || ''
      });
    });
  }

  // 최신순 정렬(문자열 날짜일 수도 있으니 parse)
  out.sort((a,b)=> (Date.parse(b.created)||0) - (Date.parse(a.created)||0));
  return out.slice(0, hardMax);
}

/* =============================
   렌더: 테이블 + 모달
============================= */
function openSummary(it){
  const meta = [
    it.country,
    it.iso3 ? ('('+it.iso3+')') : '',
    it.source,
    it.theme,
    it.type,
    it.sourceType ? ('sourceType='+it.sourceType) : ''
  ].filter(Boolean).join(' · ');

  const sum = summarizeText(it.body, 6) || summarizeText([it.title, meta].join(' '), 3) || '(요약 불가)';

  document.getElementById('m-title').textContent = it.title;
  document.getElementById('m-meta').textContent = meta;

  document.getElementById('m-badges').innerHTML = `
    ${renderRiskBadge(it.risk)} ${renderConflictBadge(it.conflictIndex)}
    <span style="margin-left:10px">${hbarHTML(it.hdp)}</span>
    <span style="margin-left:10px">${renderC15Badges(it.c15)}</span>
  `;

  document.getElementById('m-sum').textContent = sum;
  const link = document.getElementById('m-link');
  link.href = it.url || '#';

  modal.style.display='flex';
}

function renderTable(items){
  const box = document.getElementById('results');
  if(!items.length){
    box.innerHTML = '<div class="small">조건에 맞는 데이터가 없습니다.</div>';
    return;
  }

  const rows = items.map((it,i)=>`
    <tr>
      <td>${escapeHTML(String(it.created||'').slice(0,10))}</td>
      <td class="title-cell" data-i="${i}">${escapeHTML(it.title)}</td>
      <td>${escapeHTML(it.country||'')}</td>
      <td>${escapeHTML(it.source||'')}</td>
      <td>${renderRiskBadge(it.risk)}</td>
      <td>${renderConflictBadge(it.conflictIndex)}</td>
      <td>${hbarHTML(it.hdp)}</td>
      <td>${renderC15Badges(it.c15)}</td>
      <td>${it.url?`<a href="${escapeAttr(it.url)}" target="_blank" rel="noopener">link</a>`:''}</td>
    </tr>
  `).join('');

  box.innerHTML = `
    <div class="small" style="margin-bottom:10px">
      표시 ${items.length}개 (필터 적용됨). 제목 클릭 → 요약.
      ${selectedISO3 ? ` <span class="badge">country: ${escapeHTML(selectedISO3)}</span>` : ''}
      ${selectedPartner ? ` <span class="badge">partner: ${escapeHTML(selectedPartner)}</span>` : ''}
    </div>
    <div style="max-height:52vh; overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table>
        <thead>
          <tr>
            <th style="width:92px">date</th>
            <th>title</th>
            <th style="width:170px">country</th>
            <th style="width:160px">source</th>
            <th style="width:90px">risk</th>
            <th style="width:110px">conflict</th>
            <th style="width:90px">hdp</th>
            <th style="width:120px">c1~c15</th>
            <th style="width:70px">url</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  box.querySelectorAll('.title-cell').forEach(td=>{
    td.onclick = ()=>{
      const idx = Number(td.dataset.i);
      const it = items[idx];
      if(it) openSummary(it);
    };
  });
}

/* 최종: 필터 + 렌더 */
function applyFiltersAndRender(){
  const filtered = applyFilters(currentItems);
  renderTable(filtered);
  renderMap(); // 지도는 그대로 두고, 클릭하면 필터 반영되는 UX
}

/* =============================
   가져오기
============================= */
async function runFetch(){
  const status = document.getElementById('status');
  const mode = document.getElementById('src-mode').value;
  const daySpan = Number(document.getElementById('days').value || 365);
  const limit = Math.min(Number(document.getElementById('limit').value || 300), 1500);

  status.textContent = 'fetching…';
  status.className = 'small';

  try{
    let all = [];

    if(mode==='reliefweb' || mode==='both'){
      const rw = await fetchReliefWeb(daySpan, limit);
      all = all.concat(rw);
    }

    if(mode==='acled' || mode==='both'){
      const a = await fetchACLED(daySpan, limit);
      all = all.concat(a);
    }

    // 최신순 정렬
    all.sort((a,b)=> (Date.parse(b.created)||0) - (Date.parse(a.created)||0));

    // 최종 limit 컷(전체)
    if(all.length > limit) all = all.slice(0, limit);

    currentItems = all;

    // partner dropdown 갱신(보고서 소스 기반)
    renderPartnerDropdown(currentItems);

    // 기존 필터 유지되도록
    document.getElementById('filter-country').value = selectedISO3 || "";
    document.getElementById('filter-partner').value = selectedPartner || "";

    status.textContent = `done · ${currentItems.length} items`;
    applyFiltersAndRender();

  }catch(e){
    status.textContent = 'error';
    status.className = 'small err';
    document.getElementById('results').innerHTML = `<div class="small err">${escapeHTML(e.message || String(e))}</div>`;
    countryLayer.clearLayers();
    acledLayer.clearLayers();
  }
}

document.getElementById('fetch').onclick = runFetch;

/* 초기 지도 */
renderMap();
</script>
</body>
</html>
