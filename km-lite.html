<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>km-lite — RECAP 20개국 + TF-IDF 요약 + HDP% + C1~C15 분류</title>

<style>
:root{--bg:#0b0f14;--fg:#e6eef8;--mut:#8aa0bb;--line:#253245}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:16px}
h2{margin:0 0 12px}
textarea,input,button{border-radius:8px;padding:.45rem .6rem;font-size:14px;border:1px solid var(--line);background:#0f1620;color:var(--fg)}
button{cursor:pointer}
.small{color:var(--mut);font-size:12px}
.mono{font-family:ui-monospace,Consolas,Menlo,monospace}
.err{color:#ffb4b4}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.card{border:1px solid var(--line);border-radius:8px;padding:8px;margin-bottom:8px}
#rw-results{margin-top:12px;max-height:60vh;overflow:auto;border:1px solid var(--line);padding:.6rem;border-radius:8px}
table{border-collapse:collapse;width:100%;font-size:13px}
td,th{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.stickybar{position:sticky;top:8px;z-index:5;background:var(--bg);border:1px solid var(--line);border-radius:10px;padding:8px;margin:10px 0}
.badge{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:var(--mut);margin-right:4px;margin-bottom:2px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;align-items:center;justify-content:center}
.modal>div{background:var(--bg);color:var(--fg);border:1px solid var(--line);border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.5)}
#summary-box{width:80%;max-width:720px;max-height:80%;overflow:auto;padding:20px}
#country-box{width:min(780px,92vw);max-height:80%;overflow:auto;padding:16px}
.country-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-top:8px}
.hbar{height:8px;border-radius:4px;background:#142030;overflow:hidden}
.hbar>span{display:block;height:100%}
.hcol-H{background:#3aa3ff}.hcol-D{background:#61d661}.hcol-P{background:#f2b45a}
</style>
</head>

<body>
<h2>RECAP 경량 지식관리체계 (20개국 자동수집 · TF-IDF 요약 · HDP% · C1~C15)</h2>
<p class="small">
  로컬 서버에서 여세요(예: <span class="mono">py -m http.server 8000</span> 또는 <span class="mono">python -m http.server 8000</span>).<br/>
  저장 시 요약·HDP·분류(C1~C15)가 <span class="mono">localStorage</span>에 저장됩니다.
</p>

<label class="small">대상국(참고용)</label><br/>
<textarea rows="3" style="width:100%" readonly>
Burundi, Central African Republic, Comoros, Guinea, Kenya, Mali, Sao Tome and Principe, Somalia, South Sudan, Zimbabwe, Armenia, Iran, Jordan, Lebanon, Palestine, Syria, Yemen, Papua New Guinea, Solomon Islands, Timor-Leste
</textarea>
<br/><br/>

<div class="flex">
  <label>최근 일수</label><input id="rw-days" type="number" value="365" style="width:100px"/>
  <label>최대 개수</label><input id="rw-limit" type="number" value="300" style="width:100px"/>
  <button id="open-country" title="국가 필터">국가 필터</button>
  <span id="country-chip" class="badge">전체 20개국</span>
  <button id="rw-fetch">가져오기</button>
  <span id="rw-status" class="small"></span>
</div>

<div id="savebar" class="stickybar flex" style="justify-content:space-between">
  <div class="small">체크 후 저장하면 하단 패널에 누적됩니다.</div>
  <div><button id="rw-to-notes">선택 항목 노트로 저장(요약 포함)</button></div>
</div>

<div id="rw-results"></div>

<hr/>
<div id="notes-panel">
  <div class="flex">
    <strong>저장된 노트/요약</strong>
    <input id="notes-q" placeholder="검색(제목·요약·국가·분류코드)" style="flex:1;min-width:180px"/>
    <button id="notes-refresh">새로고침</button>
    <button id="notes-clear" title="모든 노트 삭제">전체삭제</button>
  </div>
  <div id="notes-list" class="small" style="margin-top:8px"></div>
</div>

<!-- 요약 모달 -->
<div id="summary-modal" class="modal">
  <div id="summary-box">
    <div id="summary-title" style="font-weight:bold;font-size:18px;margin-bottom:12px;"></div>
    <div class="small" id="summary-meta" style="margin-bottom:6px"></div>
    <div id="summary-hdp" style="margin:8px 0"></div>
    <div id="summary-content" style="font-size:14px;line-height:1.6;"></div>
    <div style="margin-top:16px;text-align:right"><button id="summary-close">닫기</button></div>
  </div>
</div>

<!-- 국가 모달 -->
<div id="country-modal" class="modal">
  <div id="country-box">
    <div class="flex" style="justify-content:space-between">
      <strong>국가 필터 선택 (다중)</strong>
      <div class="small">체크 후 적용 → 가져오기</div>
    </div>
    <div class="country-grid" id="country-grid"></div>
    <div class="flex" style="justify-content:flex-end;margin-top:10px">
      <button id="country-clear">초기화</button>
      <button id="country-apply">적용</button>
      <button id="country-close">닫기</button>
    </div>
  </div>
</div>

<script>
// ---------------- 상수 ----------------
const APPNAME   = "HyunKim+recap_km_lite+a5Ttg7U8";
const DB_KEY    = "km-lite-db";

const RECAP_NAMES = [
  'Burundi','Central African Republic','Comoros','Guinea','Kenya','Mali',
  'Sao Tome and Principe','Somalia','South Sudan','Zimbabwe',
  'Armenia','Iran','Jordan','Lebanon','Palestine','Syria','Yemen',
  'Papua New Guinea','Solomon Islands','Timor-Leste'
];
const RECAP_ISO3 = [
  'BDI','CAF','COM','GIN','KEN','MLI',
  'STP','SOM','SSD','ZWE',
  'ARM','IRN','JOR','LBN','PSE','SYR','YEM',
  'PNG','SLB','TLS'
];
const RECAP_MAP = RECAP_NAMES.map((n,i)=>({name:n,iso3:RECAP_ISO3[i]}));

let pickedISO3 = [];
let currentItems = [];

// ---------------- 국가 모달 ----------------
function openCountryModal(){
  const grid = document.getElementById('country-grid');
  let html = '';
  RECAP_MAP.forEach(d=>{
    const checked = pickedISO3.indexOf(d.iso3) >= 0 ? 'checked' : '';
    html += `
      <label style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:8px;padding:6px 8px">
        <input type="checkbox" value="${d.iso3}" ${checked}>
        <span>${d.name} <span class="badge">${d.iso3}</span></span>
      </label>`;
  });
  grid.innerHTML = html;
  document.getElementById('country-modal').style.display = 'flex';
}
function closeCountryModal(){
  document.getElementById('country-modal').style.display = 'none';
}
document.getElementById('open-country').onclick = openCountryModal;
document.getElementById('country-close').onclick = closeCountryModal;
document.getElementById('country-clear').onclick = function(){
  pickedISO3 = [];
  document.getElementById('country-chip').textContent = '전체 20개국';
  closeCountryModal();
};
document.getElementById('country-apply').onclick = function(){
  const boxes = document.querySelectorAll('#country-grid input:checked');
  pickedISO3 = Array.prototype.map.call(boxes,b=>b.value);
  document.getElementById('country-chip').textContent =
    pickedISO3.length ? (pickedISO3.length+'개국 선택') : '전체 20개국';
  closeCountryModal();
};

// ---------------- TF-IDF 요약 ----------------
function summarizeText(text,maxSentences){
  maxSentences = maxSentences || 5;
  if(!text) return '';
  let sents = text
    .split(/(?<=[.!?。！？])\s+|[\r\n]{2,}/)
    .map(s=>s.trim())
    .filter(s=>s.length>20);
  if(!sents.length) return '';
  if(sents.length<=maxSentences) return sents.join(' ');

  function tokenize(s){
    return s.toLowerCase()
      .replace(/[^a-z0-9가-힣\s]/g,' ')
      .split(/\s+/).filter(Boolean);
  }

  const stop = new Set([
    'the','and','for','with','that','this','from','are','was','were','have',
    'has','had','of','in','to','on','by','as','is','be','or','at','an','a','it',
    'its','their','our','we','you','they','into','over','under','between','within',
    'through','about','after','before','during','against','among','per',
    '및','그리고','그러나','또는','에서','으로','에는','에','를','을','이','가','은','는','와','과','하다','했다','대한','위한'
  ]);

  const tf = {}, df = {}, sentTokens = [];
  sents.forEach((s,i)=>{
    const ws = tokenize(s).filter(w=>!stop.has(w));
    sentTokens[i] = ws;
    const seen = {};
    ws.forEach(w=>{
      tf[w] = (tf[w]||0)+1;
      if(!seen[w]){ df[w] = (df[w]||0)+1; seen[w]=1; }
    });
  });

  const N = sents.length;
  const scored = sents.map((s,i)=>{
    let sc = 0;
    sentTokens[i].forEach(w=>{
      const idf = Math.log((N+1)/((df[w]||1)+1));
      sc += (tf[w]||0)*idf;
    });
    const len = s.length;
    const lenAdj = (len<40?0.85:(len>300?0.9:1));
    return {i,score:sc*lenAdj};
  });

  scored.sort((a,b)=>b.score-a.score);
  scored.splice(maxSentences);
  scored.sort((a,b)=>a.i-b.i);
  return scored.map(x=>sents[x.i]).join(' ');
}

// ---------------- HDP 점수 ----------------
const HDP_DICT = {
  H:['emergency','relief','response','humanitarian','displacement','refugee','cholera','outbreak','famine','flood','earthquake','evacuation','cash assistance','wash cluster','rapid'],
  D:['development','infrastructure','education','school','clinic','health system','primary care','livelihoods','capacity building','policy','programme','investment','training','supply chain','renewable','solar','water supply','monitoring','m&e'],
  P:['peace','cohesion','conflict','mediation','grievance','inclusive','social contract','community committee','youth','women participation','accountability','complaints','do no harm']
};
function hdpScore(text){
  const T = (text||'').toLowerCase();
  function hit(arr){let s=0; arr.forEach(w=>{ if(T.indexOf(w)>=0) s++; }); return s;}
  let H = hit(HDP_DICT.H), D = hit(HDP_DICT.D), P = hit(HDP_DICT.P);
  if(H+D+P===0) return {H:0,D:100,P:0,label:'D 100%'};
  const sum = H+D+P;
  H = Math.round(H/sum*100);
  D = Math.round(D/sum*100);
  P = 100-H-D;
  return {H,D,P,label:`H ${H}% / D ${D}% / P ${P}%`};
}
function hbarHTML(score){
  const s = (score && typeof score==='object')
    ? score : {H:0,D:100,P:0,label:'D 100%'};
  const H = Math.max(0,Math.min(100,s.H||0));
  const D = Math.max(0,Math.min(100,s.D||0));
  const P = Math.max(0,Math.min(100,s.P||0));
  const label = s.label || `H ${H}% / D ${D}% / P ${P}%`;
  return `
    <div class="hbar">
      <span class="hcol-H" style="width:${H}%;"></span>
      <span class="hcol-D" style="width:${D}%;"></span>
      <span class="hcol-P" style="width:${P}%;"></span>
    </div>
    <div class="small">${label}</div>`;
}

// ---------------- C1~C15 분류 ----------------
const CODES = {
  C1:{name:'사업·프로젝트 개요 & 배경',kw:['background','context','objective','overview','rationale','fragile','fcv','situation analysis','needs assessment','배경','목표','맥락','현황']},
  C2:{name:'이해관계자 분석',kw:['stakeholder','beneficiary','local government','ngo','civil society','private sector','partner','coordination','거버넌스','수혜자','참여기관']},
  C3:{name:'논리모형 & 성과경로 (ToC)',kw:['theory of change','results chain','logic model','inputs','outputs','outcomes','impact pathway','성과경로','논리모형']},
  C4:{name:'실행 및 운영관리',kw:['implementation','operations','workplan','sop','risk management','procurement','governance structure','현장 관리','운영','집행']},
  C5:{name:'모니터링 & 평가 체계',kw:['monitoring','evaluation','m&e','indicator','baseline','midterm','final evaluation','데이터 수집','지표','평가']},
  C6:{name:'성과 (Outputs & Outcomes)',kw:['output','deliverable','milestone','outcome','result','성과','산출']},
  C7:{name:'영향 (Impact)',kw:['impact','long-term change','institutional change','지속적 변화','제도 변화','장기 효과']},
  C8:{name:'지속가능성 & 확산 가능성',kw:['sustainability','scalability','institutionalization','handover','exit strategy','지속가능성','확산']},
  C9:{name:'비용효율성 & 자원투입',kw:['cost-effectiveness','efficiency','value for money','budget','resource allocation','비용','예산','자원배분']},
  C10:{name:'리스크 & 적응성',kw:['risk','mitigation','contingency','adaptation','pivot','conflict sensitivity','리스크','적응']},
  C11:{name:'젠더 / 나이 / 포용성',kw:['gender','women','girl','youth','elderly','disability','inclusion','gbv','성평등','포용']},
  C12:{name:'거버넌스 / 책임성 / 투명성',kw:['governance','accountability','transparency','complaints','grm','participatory','책임성','투명성']},
  C13:{name:'환경 및 기후 민감성',kw:['climate','environment','adaptation','mitigation','resilience','emission','기후','환경']},
  C14:{name:'교훈 & 확산 가능한 모형',kw:['lesson learned','lessons learned','good practice','case study','replication','scaling','교훈','우수사례']},
  C15:{name:'한계 및 권고사항',kw:['limitation','constraint','challenge','recommendation','policy recommendation','한계','권고']}
};
function classifyC15(text,topN){
  topN = topN || 3;
  const T = (text||'').toLowerCase();
  const ranked = [];
  for(const k in CODES){
    const cfg = CODES[k];
    let s = 0;
    cfg.kw.forEach(w=>{
      if(T.indexOf(w.toLowerCase())>=0) s++;
    });
    if(s>0) ranked.push({code:k,name:cfg.name,s});
  }
  ranked.sort((a,b)=>b.s-a.s);
  return ranked.slice(0,topN);
}
function renderC15Badges(arr){
  if(!arr || !arr.length)
    return '<span class="small" style="color:#8698b0">—</span>';
  return arr.map(x=>
    `<span class="badge" title="${x.name}">${x.code}</span>`
  ).join(' ');
}

// ---------------- DB / 노트 ----------------
function getDB(){
  try{
    return JSON.parse(localStorage.getItem(DB_KEY)||'{"notes":[]}');
  }catch(e){
    return {notes:[]};
  }
}
function setDB(db){
  localStorage.setItem(DB_KEY,JSON.stringify(db));
}
function migrateNotesIfNeeded(){
  try{
    const db = getDB();
    let changed = false;
    db.notes = (db.notes||[]).map(n=>{
      if(!n.hdp || !isFinite(n.hdp && n.hdp.H)){
        const t = [n.title,n.summary,n.body].filter(Boolean).join(' ');
        const sc = hdpScore(t); n.hdp = sc; n.hdpLabel = sc.label; changed = true;
      }
      if(!n.hdpLabel){
        n.hdpLabel = `H ${n.hdp.H}% / D ${n.hdp.D}% / P ${n.hdp.P}%`; changed = true;
      }
      if(!n.c15 || !n.c15.length){
        const t2 = [n.title,n.summary,n.body].filter(Boolean).join(' ');
        n.c15 = classifyC15(t2,3); changed = true;
      }
      return n;
    });
    if(changed) setDB(db);
  }catch(e){ console.warn('migrateNotesIfNeeded failed',e); }
}
function renderNotes(filter){
  filter = (filter||'').toLowerCase();
  const box = document.getElementById('notes-list');
  const db  = getDB();
  if(!db.notes.length){
    box.innerHTML = '<div class="small">저장된 노트가 없습니다.</div>';
    return;
  }
  let html = '';
  db.notes.forEach(n=>{
    const hay = [n.title,n.summary,n.country,n.hdpLabel]
      .concat((n.c15||[]).map(x=>x.code+' '+x.name))
      .join(' ').toLowerCase();
    if(filter && hay.indexOf(filter)<0) return;
    html += `
      <div class="card">
        <div class="flex" style="justify-content:space-between">
          <div><strong>${n.title}</strong></div>
          <div class="small mono">${new Date(n.created).toISOString().slice(0,10)}</div>
        </div>
        <div class="small" style="margin:6px 0"><em>${n.country||''}</em> · <span class="badge">${n.hdpLabel||''}</span></div>
        <div style="margin:6px 0">${hbarHTML(n.hdp)}</div>
        <div class="small" style="margin:4px 0">${renderC15Badges(n.c15)}</div>
        <div>${n.summary || '<span class="small">요약 없음</span>'}</div>
        <div class="flex" style="margin-top:6px;gap:8px">
          ${n.url?`<a href="${n.url}" target="_blank" rel="noopener">원문 링크</a>`:''}
          <button data-id="${n.id}" class="btn-del small">삭제</button>
        </div>
      </div>`;
  });
  box.innerHTML = html;
  Array.prototype.forEach.call(
    box.querySelectorAll('.btn-del'),
    b=>{
      b.onclick = function(){
        const id = b.getAttribute('data-id');
        const db2 = getDB();
        db2.notes = (db2.notes||[]).filter(x=>x.id!==id);
        setDB(db2);
        renderNotes(filter);
      };
    }
  );
}

// ---------------- ReliefWeb fetch (날짜는 로컬에서 필터) ----------------
async function rwFetch(){
  const out = document.getElementById('rw-results');
  const st  = document.getElementById('rw-status');
  out.innerHTML = '';
  st.textContent = '요청 중…';

  const daySpan = Number(document.getElementById('rw-days').value || 365);
  const limit   = Math.min(Number(document.getElementById('rw-limit').value || 300),1000);
  const sinceDate = new Date(Date.now() - daySpan*86400000);
  const sinceMillis = sinceDate.getTime();

  const iso3ForQuery = pickedISO3.length ? pickedISO3 : RECAP_ISO3;

  const url = 'https://api.reliefweb.int/v1/reports?appname='+
              encodeURIComponent(APPNAME);

  const body = {
    limit:  limit,
    offset: 0,
    filter:{
      operator:'AND',
      conditions:[
        { field:'country.iso3', value: iso3ForQuery }
      ]
    },
    fields:{
      include:[
        'id','title','url','body','body-html','country',
        'source','theme','disaster_type','date.created'
      ]
    },
    sort:['date.created:desc']
  };

  try{
    const res = await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>String(res.status));
      st.textContent = '불러오기 실패('+res.status+')';
      out.innerHTML  = '<div class="small err">HTTP '+res.status+' — '+txt+'</div>';
      return;
    }

    const json = await res.json();
    const data = (json && json.data) ? json.data : [];

    currentItems = data.map(r=>{
      const f = r.fields || {};
      const rawHtml = (f['body-html']||'')
        .replace(/<style[\s\S]*?<\/style>/gi,' ')
        .replace(/<[^>]+>/g,' ');
      const bodyText = (f.body && String(f.body).trim().length>0) ? f.body : rawHtml;
      const metaTxt = [
        f.title || '',
        (f.theme||[]).map(t=>t.name).join(', '),
        (f.disaster_type||[]).map(d=>d.name).join(', '),
        (f.source||[]).map(s=>s.name).join(', '),
        (f.country||[]).map(c=>c.name).join(', ')
      ].join(' | ');
      const hdp = hdpScore(metaTxt+' '+bodyText);
      const c15 = classifyC15(metaTxt+' '+bodyText,3);
      return {
        id: r.id,
        title:   f.title || '',
        url:     f.url  || '',
        created: f['date.created'] || '',
        country:(f.country||[]).map(c=>c.name).join(', '),
        source: (f.source||[]).map(s=>s.name).join(', '),
        theme:  (f.theme||[]).map(t=>t.name).join(', '),
        type:   (f.disaster_type||[]).map(d=>d.name).join(', '),
        body: bodyText,
        hdp, c15
      };
    });

    // 최근 일수 기준 로컬 필터링
    currentItems = currentItems.filter(it=>{
      const t = Date.parse(it.created);
      return isNaN(t) ? true : (t >= sinceMillis);
    });

    if(!currentItems.length){
      st.textContent = '완료 (0개, 조건에 맞는 문서 없음)';
      out.innerHTML  = '<div class="small">조건에 맞는 문서가 없습니다.</div>';
      return;
    }

    st.textContent = '완료 ('+currentItems.length+'개)';

    // 테이블 렌더
    let rows = '';
    currentItems.forEach((it,i)=>{
      rows += `
        <tr>
          <td><input type="checkbox" class="rw-check" data-i="${i}"></td>
          <td class="title-cell" style="cursor:pointer;text-decoration:underline">${it.title}</td>
          <td>${it.country}</td>
          <td>${it.source}</td>
          <td>${hbarHTML(it.hdp)}</td>
          <td>${renderC15Badges(it.c15)}</td>
          <td><a href="${it.url}" target="_blank" rel="noopener">링크</a></td>
        </tr>`;
    });

    out.innerHTML = `
      <table>
        <thead>
          <tr>
            <th></th><th>제목</th><th>국가</th><th>출처</th><th>HDP%</th><th>분류(C1~C15)</th><th>URL</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;

    // 제목 클릭 → 요약 모달
    Array.prototype.forEach.call(
      out.querySelectorAll('tbody .title-cell'),
      (td,idx)=>{
        td.onclick = function(){
          const it = currentItems[idx];
          const meta = [it.country,it.source,it.theme,it.type]
            .filter(Boolean).join(' · ');
          const sumTxt = summarizeText(it.body || '',5) ||
                         summarizeText(it.title+' '+meta,3) ||
                         '요약을 생성할 수 없습니다.';
          document.getElementById('summary-title').textContent = it.title;
          document.getElementById('summary-meta').textContent  = meta;
          document.getElementById('summary-hdp').innerHTML =
            hbarHTML(it.hdp) +
            (it.c15 && it.c15.length
              ? `<div class="small" style="margin-top:6px">${renderC15Badges(it.c15)}</div>`
              : '');
          document.getElementById('summary-content').innerHTML =
            `<p>${sumTxt}</p><hr/><p><a href="${it.url}" target="_blank" rel="noopener">원문 보기</a></p>`;
          document.getElementById('summary-modal').style.display = 'flex';
        };
      }
    );

  }catch(e){
    st.textContent = '불러오기 실패(fetch)';
    out.innerHTML  = '<div class="small err">'+e.message+'</div>';
  }
}

// ---------------- 모달 닫기 ----------------
document.getElementById('summary-close').onclick = function(){
  document.getElementById('summary-modal').style.display = 'none';
};
document.getElementById('summary-modal').onclick = function(e){
  if(e.target.id === 'summary-modal')
    e.currentTarget.style.display = 'none';
};
window.addEventListener('keydown',e=>{
  if(e.key === 'Escape'){
    document.getElementById('summary-modal').style.display = 'none';
    document.getElementById('country-modal').style.display  = 'none';
  }
});

// ---------------- 선택 항목 노트 저장 ----------------
document.getElementById('rw-to-notes').onclick = function(){
  const checks = Array.prototype.filter.call(
    document.querySelectorAll('.rw-check'),
    cb=>cb.checked
  );
  if(!checks.length){
    alert('저장할 항목을 선택하세요.');
    return;
  }
  if(!currentItems || !currentItems.length){
    alert('먼저 가져오기를 실행하세요.');
    return;
  }

  const db = getDB();
  const now = Date.now();
  let added = 0;

  checks.forEach(cb=>{
    const idx = Number(cb.dataset.i);
    const it  = currentItems[idx];
    if(!it) return;

    const meta = [it.title,it.country,it.source].join(' | ');
    const summary = summarizeText(it.body || meta,3) || meta;
    const id = 'rw-'+it.id;

    if(db.notes.some(n=>n.id===id)) return;

    db.notes.unshift({
      id,
      title: it.title,
      body:  it.body,
      country: it.country,
      source:  it.source,
      url: it.url,
      created: now,
      summary,
      hdp: it.hdp,
      hdpLabel: it.hdp.label,
      c15: it.c15
    });
    added++;
  });

  setDB(db);
  renderNotes();
  const st = document.getElementById('rw-status');
  st.textContent = added+'개 노트 저장 완료';
};

// ---------------- 초기화 ----------------
migrateNotesIfNeeded();
renderNotes();

document.getElementById('rw-fetch').addEventListener('click', rwFetch);
document.getElementById('notes-refresh').onclick = function(){
  renderNotes(document.getElementById('notes-q').value);
};
document.getElementById('notes-clear').onclick = function(){
  if(!confirm('모든 노트를 삭제합니다. 계속할까요?')) return;
  setDB({notes:[]});
  renderNotes('');
};
document.getElementById('notes-q').addEventListener('input', function(e){
  renderNotes(e.target.value);
});
</script>
</body>
</html>
