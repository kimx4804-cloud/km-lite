<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>km-lite â€” RECAP 20ê°œêµ­ + TF-IDF ìš”ì•½ + HDP% + C1~C15 ë¶„ë¥˜</title>
<style>
:root{--bg:#0b0f14;--fg:#e6eef8;--mut:#8aa0bb;--line:#253245}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:16px}
h2{margin:0 0 12px}
textarea,input,button{border-radius:8px;padding:.45rem .6rem;font-size:14px;border:1px solid var(--line);background:#0f1620;color:var(--fg)}
button{cursor:pointer}
.small{color:var(--mut);font-size:12px}
.mono{font-family:ui-monospace,Consolas,Menlo,monospace}
.err{color:#ffb4b4}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{border:1px solid var(--line);border-radius:8px;padding:10px;margin-top:8px;background:#101826}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--line);margin-right:4px;margin-bottom:2px}
.badge-H{background:rgba(255,99,132,0.1);border-color:rgba(255,99,132,0.6)}
.badge-D{background:rgba(54,162,235,0.1);border-color:rgba(54,162,235,0.6)}
.badge-P{background:rgba(255,206,86,0.1);border-color:rgba(255,206,86,0.6)}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid var(--line);padding:6px 8px;font-size:13px}
th{background:#111a28}
input::placeholder,textarea::placeholder{color:#4d5a6d}
#rw-table-wrapper{max-height:400px;overflow:auto;margin-top:8px;border:1px solid var(--line);border-radius:8px}
#notes-panel{margin-top:16px}
#summary-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:20}
#summary-box{background:#101826;border-radius:10px;max-width:800px;width:90%;max-height:80vh;overflow:auto;padding:16px;border:1px solid var(--line)}
#summary-close{float:right;cursor:pointer}
#hdp-chart-wrap{margin-top:16px;border:1px solid var(--line);border-radius:8px;padding:8px}
canvas{max-width:100%}
</style>
</head>
<body>
<h2>RECAP ê²½ëŸ‰ ì§€ì‹ê´€ë¦¬ì²´ê³„ (20ê°œêµ­ ìë™ìˆ˜ì§‘ Â· TF-IDF ìš”ì•½ Â· HDP% Â· C1~C15)</h2>
<div class="small">
  ë¡œì»¬ ì„œë²„ì—ì„œ ì—¬ì„¸ìš”(ì˜ˆ: <span class="mono">python -m http.server 8000</span>), ì €ì¥ëœ ìš”ì•½Â·HDPÂ·ë¶„ë¥˜(C1~C15)ê°€ localStorageì— ì €ì¥ë©ë‹ˆë‹¤.
</div>

<hr/>

<div class="small" style="margin-bottom:4px">ëŒ€ìƒêµ­(ì°¸ê³ ìš©)</div>
<div class="small">
Burundi, Central African Republic, Comoros, Guinea, Kenya, Mali, Sao Tome and Principe, Somalia, South Sudan, Zimbabwe, Armenia, Iran, Jordan, Lebanon, Palestine, Syria, Yemen, Papua New Guinea, Solomon Islands, Timor-Leste
</div>

<hr/>

<div class="flex small">
  <div>
    <label for="rw-days">ìµœê·¼ ì¼ìˆ˜</label><br/>
    <input id="rw-days" type="number" value="365" min="1" style="width:80px"/>
  </div>
  <div>
    <label for="rw-limit">ìµœëŒ€ ê°œìˆ˜</label><br/>
    <input id="rw-limit" type="number" value="300" min="1" style="width:80px"/>
  </div>
  <div>
    <label for="rw-country">êµ­ê°€ í•„í„°</label><br/>
    <input id="rw-country" placeholder="ì˜ˆ: Jordan; Lebanon" style="min-width:220px"/>
  </div>
  <div style="align-self:flex-end">
    <button id="rw-fetch">ê°€ì ¸ì˜¤ê¸°</button>
  </div>
  <div id="rw-status" class="small" style="min-width:160px"></div>
</div>

<div id="rw-table-wrapper">
  <div id="rw-out" class="small">ì•„ì§ ë¶ˆëŸ¬ì˜¨ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<div class="small" style="margin-top:4px">
  ì²´í¬ í›„ ì €ì¥í•˜ë©´ í•˜ë‹¨ íŒ¨ë„ì— ëˆ„ì ë©ë‹ˆë‹¤.
</div>

<div style="margin-top:8px">
  <button id="rw-save-selected">ì„ íƒ í•­ëª© ë…¸íŠ¸ë¡œ ì €ì¥(ìš”ì•½ í¬í•¨)</button>
</div>

<hr/>

<div id="notes-panel">
  <div class="flex">
    <strong>ì €ì¥ëœ ë…¸íŠ¸/ìš”ì•½</strong>
    <input id="notes-q" placeholder="ê²€ìƒ‰(ì œëª©Â·ìš”ì•½Â·êµ­ê°€Â·ë¶„ë¥˜ì½”ë“œ)" style="flex:1;min-width:180px"/>
    <button id="notes-refresh">ìƒˆë¡œê³ ì¹¨</button>
    <button id="notes-clear" title="ëª¨ë“  ë…¸íŠ¸ ì‚­ì œ">ì „ì²´ì‚­ì œ</button>
  </div>
  <div id="notes-list" class="small" style="margin-top:8px"></div>
</div>

<!-- ìš”ì•½ ëª¨ë‹¬ -->
<div id="summary-modal" class="modal">
  <div id="summary-box">
    <span id="summary-close">âœ•</span>
    <div id="summary-title" style="font-weight:bold;font-size:18px;margin-bottom:12px;"></div>
    <div class="small" id="summary-meta" style="margin-bottom:8px;"></div>
    <div id="summary-body" style="white-space:pre-wrap;font-size:13px;"></div>
  </div>
</div>

<!-- HDP & C1â€“C15 ëŒ€ì‹œë³´ë“œ -->
<div id="hdp-chart-wrap">
  <div class="flex" style="justify-content:space-between;align-items:center">
    <strong>ğŸ“Š HDP & C1â€“C15 Dashboard</strong>
    <span class="small">ì €ì¥ëœ ë…¸íŠ¸ ê¸°ì¤€</span>
  </div>
  <div class="flex" style="margin-top:8px">
    <canvas id="hdp-chart" height="120"></canvas>
    <canvas id="c15-chart" height="120"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ---------------------- ìœ í‹¸ ----------------------
function getDB(){
  try{
    var raw=localStorage.getItem('km-lite-db');
    if(!raw) return {notes:[]};
    var parsed=JSON.parse(raw);
    if(!parsed.notes) parsed.notes=[];
    return parsed;
  }catch(e){
    console.warn('DB parse ì‹¤íŒ¨',e);
    return {notes:[]};
  }
}
function setDB(db){
  localStorage.setItem('km-lite-db', JSON.stringify(db||{notes:[]}));
}

// ê°„ë‹¨ HDP ìŠ¤ì½”ì–´ë§ (0~100)
var HDP_KEYWORDS={
  H:['humanitarian','relief','emergency','food assistance','refugee','idp','crisis','aid','flood','drought','cholera','epidemic','earthquake','cyclone','conflict-affected'],
  D:['development','education','school','livelihood','income','value chain','infrastructure','capacity building','training','enterprise','job','market','productivity','policy','governance'],
  P:['peace','peacebuilding','social cohesion','reconciliation','mediation','dialogue','conflict prevention','stabilization','trust building','violence reduction','tension','clan','tribal','tribe']
};
function hdpScore(text){
  var t=(text||'').toLowerCase();
  var counts={H:0,D:0,P:0};
  Object.keys(HDP_KEYWORDS).forEach(function(k){
    HDP_KEYWORDS[k].forEach(function(w){
      if(t.indexOf(w)>=0) counts[k]+=1;
    });
  });
  var maxCnt=Math.max(counts.H,counts.D,counts.P,1);
  var H=Math.round(counts.H/maxCnt*100);
  var D=Math.round(counts.D/maxCnt*100);
  var P=Math.round(counts.P/maxCnt*100);
  var label='H '+H+'% / D '+D+'% / P '+P+'%';
  return {H:H,D:D,P:P,label:label};
}

// C1~C15 ë”ë¯¸ ë¶„ë¥˜ê¸° (ë‹¨ìˆœ í‚¤ì›Œë“œ ì˜ˆì‹œ)
var C15_RULES=[
  {code:'C1',name:'ì‚¬ì—…Â·í”„ë¡œì íŠ¸ ê°œìš” & ë°°ê²½',kw:['project','programme','overview','background','context']},
  {code:'C2',name:'ì´í•´ê´€ê³„ì ë¶„ì„',kw:['stakeholder','community','beneficiary','partner','ngo']},
  {code:'C3',name:'ëª©í‘œÂ·ì„±ê³¼ì§€í‘œ(Logframe)',kw:['objective','outcome','output','indicator','logframe']},
  {code:'C4',name:'í™œë™(Activity) ì„¸ë¶€ ë‚´ìš©',kw:['activity','training','workshop','distribution','construction']},
  {code:'C5',name:'ì„±ê³¼ê´€ë¦¬(M&E)Â·ë°ì´í„°',kw:['monitoring','evaluation','baseline','survey','indicator','logframe']},
  {code:'C6',name:'ì¬ì •Â·ì˜ˆì‚°ì§‘í–‰',kw:['budget','finance','funding','expenditure','cost']},
  {code:'C7',name:'ìœ„í—˜Â·ë¦¬ìŠ¤í¬Â·ì œí•œì‚¬í•­',kw:['risk','challenge','constraint','limitation','barrier']},
  {code:'C8',name:'ì§€ì†ê°€ëŠ¥ì„±Â·ì „ëµì  ì—°ê³„',kw:['sustainability','exit strategy','transition','ownership']},
  {code:'C9',name:'ì  ë”Â·ì‚¬íšŒì  ë³´í˜¸',kw:['gender','women','girl','protection','gender-based']},
  {code:'C10',name:'ì¸ë„ì£¼ì˜-ê°œë°œ-í‰í™” ë„¥ì„œìŠ¤',kw:['nexus','triple nexus','humanitarian','development','peace']},
  {code:'C11',name:'ê¸°í›„ë³€í™”Â·í™˜ê²½',kw:['climate','environment','resilience','disaster risk reduction']},
  {code:'C12',name:'ë³´ê±´Â·WASHÂ·ì˜ì–‘',kw:['health','clinic','hospital','wash','water','sanitation','nutrition']},
  {code:'C13',name:'êµìœ¡Â·ìƒê³„Â·ê²½ì œ',kw:['education','school','teacher','livelihood','job','income']},
  {code:'C14',name:'ê±°ë²„ë„ŒìŠ¤Â·ì œë„Â·ì •ì±…',kw:['policy','governance','institution','law','regulation']},
  {code:'C15',name:'ê¸°íƒ€(ë§¥ë½Â·ë¶„ìŸÂ·í‰í™” ë“±)',kw:['conflict','peace','migration','refugee','idp']}
];
function classifyC15(text,maxCount){
  var t=(text||'').toLowerCase();
  var scores=[];
  C15_RULES.forEach(function(r){
    var s=0;
    r.kw.forEach(function(w){ if(t.indexOf(w)>=0) s++; });
    if(s>0) scores.push({code:r.code,name:r.name,score:s});
  });
  scores.sort(function(a,b){return b.score-a.score;});
  if(maxCount) scores=scores.slice(0,maxCount);
  return scores;
}

function renderC15Badges(list){
  if(!list||!list.length) return '';
  return list.map(function(x){
    return '<span class="badge">'+x.code+'</span>';
  }).join(' ');
}

function hbarHTML(hdp){
  if(!hdp) return '';
  var H=hdp.H||0,D=hdp.D||0,P=hdp.P||0;
  var total=Math.max(H+D+P,1);
  var hPct=Math.round(H/total*100);
  var dPct=Math.round(D/total*100);
  var pPct=100-hPct-dPct;
  return '<div style="display:flex;height:10px;border-radius:999px;overflow:hidden;border:1px solid #243149">'+
           '<div style="flex:'+H+';background:rgba(255,99,132,0.7)" title="H '+H+'%"></div>'+
           '<div style="flex:'+D+';background:rgba(54,162,235,0.7)" title="D '+D+'%"></div>'+
           '<div style="flex:'+P+';background:rgba(255,206,86,0.7)" title="P '+P+'%"></div>'+
         '</div>';
}

// ---------- TF-IDF ìš”ì•½ ----------
function tfidfSummary(text,maxSentences){
  maxSentences=maxSentences||3;
  var sents=text.split(/(?<=[\.!?])\s+/);
  if(sents.length<=maxSentences) return text;
  function tokenize(s){return s.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,' ').split(/\s+/).filter(Boolean);}
  var stop=new Set(['the','and','for','with','that','this','from','into','about','there','their','have','has','been','will','would','should','could','shall','ë˜ëŠ”','ê·¸ë¦¬ê³ ','í•˜ì§€ë§Œ','ë•Œë¬¸ì—','ìœ„í•´','ëŒ€í•œ','ì—ì„œ','ìœ¼ë¡œ','ì—ê²Œ','ê¹Œì§€','ë¶€í„°','ì—ì„œëŠ”','ì—ëŠ”','ì—','ë¥¼','ì„','ì´','ê°€','ì€','ëŠ”','ì™€','ê³¼','í•˜ë‹¤','í–ˆë‹¤','ëŒ€í•œ','ìœ„í•œ']);
  var tf={},df={},sentTokens=[];
  for(var i=0;i<sents.length;i++){
    var ws=tokenize(sents[i]).filter(function(w){return !stop.has(w);});
    sentTokens.push(ws);
    var seen={};
    for(var j=0;j<ws.length;j++){
      var w=ws[j]; tf[w]=(tf[w]||0)+1; if(!seen[w]){df[w]=(df[w]||0)+1; seen[w]=1;}
    }
  }
  var N=sents.length;
  var scored=[];
  for(var k=0;k<sents.length;k++){
    var sc=0, ws2=sentTokens[k];
    for(var j2=0;j2<ws2.length;j2++){
      var ww=ws2[j2];
      var idf=Math.log((N+1)/((df[ww]||1)+1));
      sc+=(tf[ww]||0)*idf;
    }
    var len=sents[k].length; var lenAdj=(len<40?0.85:(len>300?0.9:1));
    scored.push({i:k,score:sc*lenAdj});
  }
  scored.sort(function(a,b){return b.score-a.score;});
  scored=scored.slice(0,maxSentences).sort(function(a,b){return a.i-b.i;});
  return scored.map(function(x){return sents[x.i];}).join(' ');
}

// HDP ì ìˆ˜ + C1~C15 ìš”ì•½ ì¹´ë“œ
function buildNoteFromItem(it){
  var text=[it.body||'',it.title||'',it.country||'',it.source||'',it.theme||'',it.type||''].join(' ');
  var hdp=hdpScore(text);
  var c15=classifyC15(text,3);
  var summary=tfidfSummary(it.body||'',3);
  return {
    id:it.id,
    title:it.title||'(ì œëª© ì—†ìŒ)',
    url:it.url||'',
    created:it.created||new Date().toISOString(),
    country:it.country||'',
    source:it.source||'',
    theme:it.theme||'',
    type:it.type||'',
    summary:summary,
    hdp:hdp,
    hdpLabel:hdp.label,
    c15:c15
  };
}

// DB ë§ˆì´ê·¸ë ˆì´ì…˜ (ì˜ˆì „ êµ¬ì¡° -> í˜„ì¬ êµ¬ì¡°)
function migrateNotesIfNeeded(){
  try{
    var db=getDB();
    if(!db.notes||!db.notes.length) return;
    var changed=false;
    db.notes=db.notes.map(function(n){
      if(!n.hdp||!isFinite(n.hdp&&n.hdp.H)){
        var t=[n.title,n.summary,n.body].filter(Boolean).join(' ');
        var sc=hdpScore(t); n.hdp=sc; n.hdpLabel=sc.label; changed=true;
      }
      if(!n.hdpLabel){ n.hdpLabel='H '+n.hdp.H+'% / D '+n.hdp.D+'% / P '+n.hdp.P+'%'; changed=true; }
      if(!n.c15||!n.c15.length){
        var t2=[n.title,n.summary,n.body].filter(Boolean).join(' ');
        n.c15=classifyC15(t2,3); changed=true;
      }
      return n;
    });
    if(changed) setDB(db);
  }catch(e){ console.warn('migrateNotesIfNeeded failed:',e); }
}

function renderNotes(filter){
  filter=(filter||'').toLowerCase();
  var box=document.getElementById('notes-list');
  var db=getDB();
  if(!db.notes.length){ box.innerHTML='<div class="small">ì €ì¥ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  var html='';
  db.notes.forEach(function(n){
    var hay=[n.title,n.summary,n.country,n.hdpLabel].concat((n.c15||[]).map(function(x){return x.code+' '+x.name;})).join(' ').toLowerCase();
    if(filter && hay.indexOf(filter)<0) return;
    html+= '<div class="card">'
         +   '<div class="flex" style="justify-content:space-between">'
         +     '<div><strong>'+n.title+'</strong></div>'
         +     '<div class="small mono">'+new Date(n.created).toISOString().slice(0,10)+'</div>'
         +   '</div>'
         +   '<div class="small" style="margin:6px 0"><em>'+n.country+' Â· '+n.source+' Â· '+n.type+'</em> Â· <span class="badge">'+(n.hdpLabel||'')+'</span></div>'
         +   '<div style="margin:6px 0">'+hbarHTML(n.hdp)+'</div>'
         +   '<div class="small" style="margin:4px 0">'+renderC15Badges(n.c15)+'</div>'
         +   '<div class="small" style="margin-top:4px;max-height:5.5em;overflow:hidden;text-overflow:ellipsis;">'+(n.summary||'')+'</div>'
         +   '<div class="small" style="margin-top:6px">'
         +     (n.url?('<a href="'+n.url+'" target="_blank" rel="noopener">ì›ë¬¸ ë§í¬</a> Â· '):'')
         +     '<a href="#" data-id="'+n.id+'" class="summary-link">ìš”ì•½ ì „ì²´ ë³´ê¸°</a>'
         +   '</div>'
         + '</div>';
  });
  box.innerHTML=html||'<div class="small">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';

  // ëª¨ë‹¬ ë§í¬ ë°”ì¸ë”©
  Array.prototype.forEach.call(box.querySelectorAll('.summary-link'), function(a){
    a.onclick=function(e){
      e.preventDefault();
      var id=this.getAttribute('data-id');
      var db=getDB();
      var note=db.notes.find(function(n){return String(n.id)===String(id);});
      if(!note) return;
      var modal=document.getElementById('summary-modal');
      document.getElementById('summary-title').textContent=note.title;
      document.getElementById('summary-meta').textContent=[note.country,note.source,note.type].filter(Boolean).join(' Â· ');
      document.getElementById('summary-body').textContent=note.summary||'';
      modal.style.display='flex';
    };
  });
}

// ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('summary-close').onclick=function(){
  document.getElementById('summary-modal').style.display='none';
};
document.getElementById('summary-modal').onclick=function(e){
  if(e.target.id==='summary-modal') this.style.display='none';
};

// ---------- ReliefWeb API í˜¸ì¶œ ----------
async function tryFetchBodies(baseUrl,bodies){
  var log=[];
  for(var i=0;i<bodies.length;i++){
    try{
      var res=await fetch(baseUrl,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(bodies[i])
      });
      if(!res.ok){
        var txt=await res.text();
        log.push('HTTP '+res.status+' â€” '+txt);
        continue;
      }
      var json=await res.json();
      return {ok:true,json:json,log:log};
    }catch(e){
      log.push('fetch error: '+e.message);
    }
  }
  return {ok:false,log:log};
}

async function rwFetch(){
  var daySpan=parseInt(document.getElementById('rw-days').value||'365',10);
  var limit=parseInt(document.getElementById('rw-limit').value||'300',10);
  var countryRaw=document.getElementById('rw-country').value||'';
  var countries=countryRaw.split(';').map(function(s){return s.trim();}).filter(Boolean);

  var out=document.getElementById('rw-out');
  var st=document.getElementById('rw-status');
  if(st) st.textContent='ìš”ì²­ ì¤‘...';

  var url='https://api.reliefweb.int/v1/reports?appname=km-lite';
  // ë‚ ì§œ: ISO 8601 ì „ì²´ ë¬¸ìì—´ ì‚¬ìš© (ì˜ˆ: 2025-11-12T00:00:00.000Z)
  var sinceISO=new Date(Date.now()-daySpan*86400000).toISOString();

  var fields={include:['id','title','url','body','body-html','country','source','theme','disaster_type','date.created']};
  var sort=["date.created:desc"];
  var conditionsBase=[
    {field:'date.created',value:{from:sinceISO}},
  ];
  if(countries.length){
    conditionsBase.push({field:'country',value:countries});
  }

  // ë‹¤ì–‘í•œ ì‹œë„(ìŠ¤í‚¤ë§ˆ ë²„ì „ ì°¨ì´ ëŒ€ì‘)
  var bodies=[
    {limit:limit,offset:0,filter:{operator:'AND',conditions:conditionsBase},fields:fields,sort:sort},
    {limit:limit,offset:0,filter:{operator:'AND',conditions:[
      {field:'date.created',range:{from:sinceISO}}
    ]},fields:fields,sort:sort},
    {limit:limit,offset:0,filter:{operator:'AND',conditions:[
      {field:'date.created',operator:">=",value:sinceISO}
    ]},fields:fields,sort:sort}
  ];

  var result=await tryFetchBodies(url,bodies);
  if(!result.ok){
    if(st) st.textContent='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
    out.innerHTML='<div class="small err">'+result.log.map(function(e){return 'â€¢ '+e;}).join('<br/>')+'</div>';
    console.error('ReliefWeb ìš”ì²­ ì‹¤íŒ¨ ë¡œê·¸:', result.log);
    return;
  }
  if(st) st.textContent='ì™„ë£Œ ('+new Date().toLocaleTimeString()+')';

  var data=result.json.data||[];
  if(!data.length){
    out.innerHTML='<div class="small">ì¡°ê±´ì— ë§ëŠ” ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  var items=data.map(function(r){
    var f=r.fields||{};
    var body=(f['body-html']||f.body||'');
    var metaTxt=[f.title||'',(f.country||[]).map(function(c){return c.name;}).join(', '),f.source||''].join(' ');
    var hdp=hdpScore(metaTxt+' '+body);
    var c15=classifyC15(metaTxt+' '+body,3);
    return {
      id:r.id,title:f.title||'',url:f.url||'',created:f['date.created']||'',
      country:(f.country||[]).map(function(c){return c.name;}).join(', '),
      source:(f.source||[]).map(function(s){return s.name||s;}).join(', '),
      theme:(f.theme||[]).map(function(t){return t.name;}).join(', '),
      type:(f.disaster_type||[]).map(function(d){return d.name;}).join(', '),
      body:body, hdp:hdp, c15:c15
    };
  });

  var rows='';
  for(var i=0;i<items.length;i++){
    var it=items[i];
    rows+= '<tr>'
         +   '<td><input type="checkbox" class="rw-check" data-i="'+i+'"></td>'
         +   '<td class="title-cell" style="cursor:pointer;text-decoration:underline">'+it.title+'</td>'
         +   '<td>'+it.country+'</td>'
         +   '<td>'+it.source+'</td>'
         +   '<td>'+hbarHTML(it.hdp)+'</td>'
         +   '<td>'+renderC15Badges(it.c15)+'</td>'
         +   '<td><a href="'+it.url+'" target="_blank" rel="noopener">ë§í¬</a></td>'
         + '</tr>';
  }
  out.innerHTML=
    '<table>'+
      '<thead><tr><th></th><th>ì œëª©</th><th>êµ­ê°€</th><th>ì¶œì²˜</th><th>HDP%</th><th>ë¶„ë¥˜(C1~C15)</th><th>URL</th></tr></thead>'+
      '<tbody>'+rows+'</tbody>'+
    '</table>';

  // ì œëª© í´ë¦­ ì‹œ ì „ì²´ ë³¸ë¬¸ ë³´ê¸° (ê°„ë‹¨ ì•Œë¦¼)
  Array.prototype.forEach.call(out.querySelectorAll('.title-cell'), function(td){
    td.onclick=function(){
      var idx=parseInt(this.parentNode.querySelector('.rw-check').getAttribute('data-i'),10);
      var it=items[idx];
      alert((it.title||'')+'\n\n'+(it.body||''));
    };
  });
}

// ì„ íƒ í•­ëª© ë…¸íŠ¸ë¡œ ì €ì¥
document.getElementById('rw-save-selected').onclick=function(){
  var out=document.getElementById('rw-out');
  var checks=out.querySelectorAll('.rw-check');
  if(!checks.length){ alert('ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸° í›„ ì²´í¬í•˜ì„¸ìš”.'); return; }
  var db=getDB();
  var added=0;
  Array.prototype.forEach.call(checks,function(ch){
    if(!ch.checked) return;
    var idx=parseInt(ch.getAttribute('data-i'),10);
    var row=out.querySelectorAll('tbody tr')[idx];
    if(!row) return;
    var title=row.children[1].textContent;
    var country=row.children[2].textContent;
    var source=row.children[3].textContent;
    var hdpBar=row.children[4].textContent;
    // raw item ì •ë³´ëŠ” rwFetch ì•ˆì—ì„œë§Œ ìˆì—ˆìœ¼ë¯€ë¡œ, ë‹¤ì‹œ fetchí•˜ì§€ ì•Šê³  ìµœì†Œ ì •ë³´ë§Œ ì €ì¥
    var note={
      id:Date.now()+'-'+idx,
      title:title,
      url:row.children[6].querySelector('a').getAttribute('href'),
      created:new Date().toISOString(),
      country:country,
      source:source,
      type:'',
      summary:'',
      body:'',
      hdp:{H:0,D:0,P:0,label:hdpBar},
      hdpLabel:hdpBar,
      c15:[]
    };
    db.notes.push(note);
    added++;
  });
  setDB(db);
  renderNotes(document.getElementById('notes-q').value);
  alert(added+'ê°œ ë…¸íŠ¸ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
};

// ëŒ€ì‹œë³´ë“œ ë Œë”ë§
var hdpChart,c15Chart;
function renderDashboard(){
  var db=getDB();
  var notes=db.notes||[];
  var hCnt=0,dCnt=0,pCnt=0;
  var cAgg={};
  notes.forEach(function(n){
    if(n.hdp&&n.hdp.H>0) hCnt++;
    if(n.hdp&&n.hdp.D>0) dCnt++;
    if(n.hdp&&n.hdp.P>0) pCnt++;
    (n.c15||[]).forEach(function(c){ cAgg[c.code]=(cAgg[c.code]||0)+1; });
  });

  var ctx1=document.getElementById('hdp-chart').getContext('2d');
  var ctx2=document.getElementById('c15-chart').getContext('2d');
  if(hdpChart) hdpChart.destroy();
  if(c15Chart) c15Chart.destroy();

  hdpChart=new Chart(ctx1,{
    type:'doughnut',
    data:{labels:['H','D','P'],datasets:[{data:[hCnt,dCnt,pCnt]}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  var labels=Object.keys(cAgg);
  var vals=labels.map(function(k){return cAgg[k];});
  c15Chart=new Chart(ctx2,{
    type:'bar',
    data:{labels:labels,datasets:[{data:vals}]},
    options:{indexAxis:'y',plugins:{legend:{display:false}}}
  });
}

// ì´ˆê¸° ë Œë”/ë°”ì¸ë”©
migrateNotesIfNeeded();
renderNotes();
renderDashboard();

document.addEventListener('DOMContentLoaded', function(){
  var btn=document.getElementById('rw-fetch'); if(btn) btn.addEventListener('click', async function(){
    await rwFetch();
    renderDashboard();
  });
  document.getElementById('notes-refresh').onclick=function(){
    renderNotes(document.getElementById('notes-q').value);
    renderDashboard();
  };
  document.getElementById('notes-clear').onclick=function(){
    if(!confirm('ëª¨ë“  ì €ì¥ëœ ë…¸íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) return;
    setDB({notes:[]}); renderNotes(''); renderDashboard();
  };
  document.getElementById('notes-q').addEventListener('input', function(e){
    renderNotes(e.target.value); renderDashboard();
  });
});
</script>
</body>
</html>
