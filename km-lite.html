<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RECAP ì§€ì‹ê´€ë¦¬ì²´ê³„ </title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;background:#0f1620;color:#e6eef8;margin:0;padding:16px}
    textarea,input,button{border-radius:6px;padding:8px;border:1px solid #353245;background:#182030;color:#e6eef8}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #444;padding:8px;text-align:left}
    th{background:#1f2838}
    canvas{max-width:600px}
  </style>
</head>
<body>
  <h2>RECAP ì§€ì‹ê´€ë¦¬ì²´ê³„ </h2>
  <p>ReliefWeb AppName: <strong>HyunKim+recap_km_lite+a5Ttg7U8</strong></p>
  <textarea id="inputText" placeholder="í…ìŠ¤íŠ¸ ë˜ëŠ” ìš”ì•½ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
  <button onclick="classifyText()">ë¶„ë¥˜í•˜ê¸°</button>
  <button onclick="fetchReliefWeb()">ê°€ì ¸ì˜¤ê¸°</button>

  <table id="resultTable">
    <thead><tr><th>ID</th><th>H</th><th>D</th><th>P</th><th>Nexus</th><th>C1~C15</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>ğŸ“Š HDP & C1â€“C15 Dashboard</h3>
  <canvas id="hdpChart"></canvas>
  <canvas id="c15Chart"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  (function(){

  const HDP_DICT = {
    H:['humanitarian','emergency','disaster','crisis','refugee','relief','aid'],
    D:['development','education','livelihood','infrastructure','policy','training','investment'],
    P:['peace','conflict','stability','governance','reconciliation','social cohesion']
  };
  const CODES=['C1','C2','C3','C4','C5','C6','C7','C8','C9','C10','C11','C12','C13','C14','C15'];

  function hdpFlags(text){
    const T=text.toLowerCase();
    function hit(arr){return arr.some(w=>T.includes(w));}
    const H=hit(HDP_DICT.H), D=hit(HDP_DICT.D), P=hit(HDP_DICT.P);
    const nexus=(H&&D)||(H&&D&&P);
    return {H:H?'H':'',D:D?'D':'',P:P?'P':'',nexus:nexus?'Y':'N'};
  }

  function classifyC15(text){
    // placeholder: random for demo
    return CODES.filter(()=>Math.random()>0.9);
  }

  function classifyText(){
    const txt=document.getElementById("inputText").value.trim();
    if(!txt){alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");return;}
    const id=Date.now();
    const hdp=hdpFlags(txt);
    const c15=classifyC15(txt);
    const stored=JSON.parse(localStorage.getItem("kmLiteData")||"[]");
    stored.push({id,hdp,c15});
    localStorage.setItem("kmLiteData",JSON.stringify(stored));
    renderTable(stored);renderDashboard(stored);
  }

  function renderTable(data){
    const tbody=document.querySelector("#resultTable tbody");
    tbody.innerHTML='';
    data.forEach(d=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${d.id}</td><td>${d.hdp.H}</td><td>${d.hdp.D}</td>
                    <td>${d.hdp.P}</td><td>${d.hdp.nexus}</td><td>${d.c15.join(', ')}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderDashboard(data){
    if(!data.length)return;
    const h=data.filter(d=>d.hdp.H).length;
    const d=data.filter(d=>d.hdp.D).length;
    const p=data.filter(d=>d.hdp.P).length;
    const n=data.filter(d=>d.hdp.nexus==='Y').length;
    const hdpCtx=document.getElementById('hdpChart').getContext('2d');
    new Chart(hdpCtx,{type:'doughnut',
      data:{labels:['H','D','P','Nexus(Y)'],datasets:[{data:[h,d,p,n]}]},
      options:{plugins:{legend:{position:'bottom'}}}});
    const cStats={};
    data.forEach(d=>(d.c15||[]).forEach(c=>cStats[c]=(cStats[c]||0)+1));
    const c15Ctx=document.getElementById('c15Chart').getContext('2d');
    new Chart(c15Ctx,{type:'bar',
      data:{labels:Object.keys(cStats),datasets:[{data:Object.values(cStats)}]},
      options:{indexAxis:'y',plugins:{legend:{display:false}}}});
  }

  // ReliefWeb fetch test
  function fetchReliefWeb(){
    const proxy="https://api.allorigins.win/raw?url=";
    const url="https://api.reliefweb.int/v1/disasters?appname=HyunKim+recap_km_lite+a5Ttg7U8";
    fetch(proxy+encodeURIComponent(url))
      .then(r=>r.json())
      .then(j=>{
        console.log("âœ… ReliefWeb data:",j);
        alert("ReliefWeb ë°ì´í„° "+(j.data?.length||0)+"ê±´ ë¡œë“œë¨ (ì½˜ì†” ì°¸ì¡°)");
      })
      .catch(e=>console.error("âŒ Fetch error:",e));
  }

  // ì´ˆê¸° ë¡œë“œ
  const saved=JSON.parse(localStorage.getItem("kmLiteData")||"[]");
  renderTable(saved);renderDashboard(saved);

  })();
  </script>
</body>
</html>
