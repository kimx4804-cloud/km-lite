<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>km-lite â€” RECAP 20ê°œêµ­ + TF-IDF ìš”ì•½ + HDP% + C1~C15 ë¶„ë¥˜</title>

<style>
:root{--bg:#0b0f14;--fg:#e6eef8;--mut:#8aa0bb;--line:#253245}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:16px}
h2{margin:0 0 12px}
textarea,input,button{border-radius:8px;padding:.45rem .6rem;font-size:14px;border:1px solid var(--line);background:#0f1620;color:var(--fg)}
button{cursor:pointer}
.small{color:var(--mut);font-size:12px}
.mono{font-family:ui-monospace,Consolas,Menlo,monospace}
.err{color:#ffb4b4}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{border:1px solid var(--line);border-radius:8px;padding:10px;margin-top:8px;background:#101826}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--line);margin-right:4px;margin-bottom:2px}
.badge-H{background:rgba(255,99,132,0.1);border-color:rgba(255,99,132,0.6)}
.badge-D{background:rgba(54,162,235,0.1);border-color:rgba(54,162,235,0.6)}
.badge-P{background:rgba(255,206,86,0.1);border-color:rgba(255,206,86,0.6)}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid var(--line);padding:6px 8px;font-size:13px}
th{background:#111a28}
input::placeholder,textarea::placeholder{color:#4d5a6d}
#rw-table-wrapper{max-height:400px;overflow:auto;margin-top:8px;border:1px solid var(--line);border-radius:8px}
#notes-panel{margin-top:16px}
#summary-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:20}
#summary-box{background:#101826;border-radius:10px;max-width:800px;width:90%;max-height:80vh;overflow:auto;padding:16px;border:1px solid var(--line)}
#summary-close{float:right;cursor:pointer}
#hdp-chart-wrap{margin-top:16px;border:1px solid var(--line);border-radius:8px;padding:8px}
canvas{max-width:100%}
</style>
</head>

<body>
<h2>RECAP ê²½ëŸ‰ ì§€ì‹ê´€ë¦¬ì²´ê³„ (20ê°œêµ­ ìë™ìˆ˜ì§‘ Â· TF-IDF ìš”ì•½ Â· HDP% Â· C1~C15)</h2>

<div class="small">
  ë¡œì»¬ ì„œë²„ì—ì„œ ì—¬ì„¸ìš”(ì˜ˆ: <span class="mono">python -m http.server 8000</span>). ëª¨ë“  ë°ì´í„°ëŠ” localStorageì— ì €ì¥ë©ë‹ˆë‹¤.
</div>

<hr/>

<div class="small" style="margin-bottom:4px">ëŒ€ìƒêµ­(ì°¸ê³ ìš©)</div>
<div class="small">
Burundi, Central African Republic, Comoros, Guinea, Kenya, Mali,
Sao Tome and Principe, Somalia, South Sudan, Zimbabwe, Armenia,
Iran, Jordan, Lebanon, Palestine, Syria, Yemen,
Papua New Guinea, Solomon Islands, Timor-Leste
</div>

<hr/>

<!-- ì…ë ¥í¼ -->
<div class="flex small">
  <div>
    <label for="rw-days">ìµœê·¼ ì¼ìˆ˜</label><br/>
    <input id="rw-days" type="number" value="365" min="1" style="width:80px"/>
  </div>
  <div>
    <label for="rw-limit">ìµœëŒ€ ê°œìˆ˜</label><br/>
    <input id="rw-limit" type="number" value="300" min="1" style="width:80px"/>
  </div>
  <div style="position:relative;flex:1;min-width:220px">
    <label for="rw-country">êµ­ê°€ í•„í„° (ì´ë¦„ ë˜ëŠ” ISO3; ì„¸ë¯¸ì½œë¡  êµ¬ë¶„)</label><br/>
    <input id="rw-country" placeholder="ì˜ˆ: Jordan; JOR; Lebanon; LBN" style="width:100%"/>
  </div>
  <div style="align-self:flex-end">
    <button id="rw-fetch" type="button">ê°€ì ¸ì˜¤ê¸°</button>
  </div>
  <div id="rw-status" class="small" style="min-width:160px"></div>
</div>

<!-- ê²°ê³¼ í‘œì‹œ -->
<div id="rw-table-wrapper">
  <div id="rw-out" class="small">ì•„ì§ ë¶ˆëŸ¬ì˜¨ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<div class="small" style="margin-top:4px">
  ì²´í¬ í›„ ì €ì¥í•˜ë©´ í•˜ë‹¨ íŒ¨ë„ì— ëˆ„ì ë©ë‹ˆë‹¤.
</div>

<button id="rw-save-selected" style="margin-top:8px">ì„ íƒ í•­ëª© ë…¸íŠ¸ë¡œ ì €ì¥(ìš”ì•½ í¬í•¨)</button>

<div id="rw-log" class="small" style="margin-top:4px;color:#ffb4b4;"></div>

<hr/>

<!-- ì €ì¥ëœ ë…¸íŠ¸ -->
<div id="notes-panel">
  <div class="flex">
    <strong>ì €ì¥ëœ ë…¸íŠ¸/ìš”ì•½</strong>
    <input id="notes-q" placeholder="ê²€ìƒ‰(ì œëª©Â·ìš”ì•½Â·êµ­ê°€Â·ë¶„ë¥˜ì½”ë“œ)" style="flex:1;min-width:180px"/>
    <button id="notes-refresh">ìƒˆë¡œê³ ì¹¨</button>
    <button id="notes-export">Excel ë‹¤ìš´ë¡œë“œ(CSV)</button>
    <button id="notes-clear">ì „ì²´ì‚­ì œ</button>
  </div>
  <div id="notes-list" class="small" style="margin-top:8px"></div>
</div>

<!-- ìš”ì•½ ëª¨ë‹¬ -->
<div id="summary-modal">
  <div id="summary-box">
    <span id="summary-close">âœ•</span>
    <div id="summary-title" style="font-weight:bold;font-size:18px;margin-bottom:12px;"></div>
    <div class="small" id="summary-meta" style="margin-bottom:8px;"></div>
    <div id="summary-body" style="white-space:pre-wrap;font-size:13px;"></div>
  </div>
</div>

<!-- HDP & C1â€“C15 Dashboard -->
<div id="hdp-chart-wrap">
  <div class="flex" style="justify-content:space-between;align-items:center">
    <strong>ğŸ“Š HDP & C1â€“C15 Dashboard</strong>
    <span class="small">ì €ì¥ëœ ë…¸íŠ¸ ê¸°ì¤€</span>
  </div>
  <div class="flex" style="margin-top:8px">
    <canvas id="hdp-chart" height="120"></canvas>
    <canvas id="c15-chart" height="120"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ============================================================
   ìƒìˆ˜
============================================================ */
const APPNAME = "HyunKim+recap_km_lite+a5Ttg7U8dlsep";

/* ëŒ€ìƒ 20ê°œêµ­ ìë™ì™„ì„±ìš© */
const COUNTRY_LIST = [
  "Burundi","Central African Republic","Comoros","Guinea","Kenya","Mali",
  "Sao Tome and Principe","Somalia","South Sudan","Zimbabwe",
  "Armenia","Iran","Jordan","Lebanon","Palestine","Syria","Yemen",
  "Papua New Guinea","Solomon Islands","Timor-Leste"
];

/* ISO3 â†’ ì´ë¦„ ë§¤í•‘ (í•„ìš”ì‹œ ì¶”ê°€) */
const COUNTRY_MAP = {
  "BDI":"Burundi",
  "CAF":"Central African Republic",
  "COM":"Comoros",
  "GIN":"Guinea",
  "KEN":"Kenya",
  "MLI":"Mali",
  "STP":"Sao Tome and Principe",
  "SOM":"Somalia",
  "SSD":"South Sudan",
  "ZWE":"Zimbabwe",
  "ARM":"Armenia",
  "IRN":"Iran",
  "JOR":"Jordan",
  "LBN":"Lebanon",
  "PSE":"Palestine",
  "SYR":"Syria",
  "YEM":"Yemen",
  "PNG":"Papua New Guinea",
  "SLB":"Solomon Islands",
  "TLS":"Timor-Leste"
};


/* ============================================================
   localStorage DB
============================================================ */
function getDB(){
  try{
    const raw = localStorage.getItem('km-lite-db');
    if(!raw) return {notes:[]};
    const parsed = JSON.parse(raw);
    if(!parsed.notes) parsed.notes = [];
    return parsed;
  }catch(e){
    return {notes:[]};
  }
}
function setDB(db){
  localStorage.setItem('km-lite-db', JSON.stringify(db || {notes:[]}));
}


/* ============================================================
   HDP ìŠ¤ì½”ì–´ë§
============================================================ */
const HDP_KEYWORDS = {
  H:['humanitarian','relief','emergency','food assistance','refugee','idp','crisis','aid','flood','drought','cholera','epidemic','earthquake','cyclone','conflict-affected'],
  D:['development','education','school','livelihood','income','value chain','infrastructure','capacity building','training','enterprise','job','market','productivity','policy','governance'],
  P:['peace','peacebuilding','social cohesion','reconciliation','mediation','dialogue','conflict prevention','stabilization','trust building','violence reduction','tension','clan','tribal','tribe']
};

function hdpScore(text){
  const t = (text || '').toLowerCase();
  const counts = {H:0,D:0,P:0};
  Object.keys(HDP_KEYWORDS).forEach(k=>{
    HDP_KEYWORDS[k].forEach(w=>{
      if(t.includes(w)) counts[k]++;
    });
  });
  const maxCnt = Math.max(counts.H,counts.D,counts.P,1);
  const H = Math.round(counts.H/maxCnt*100);
  const D = Math.round(counts.D/maxCnt*100);
  const P = Math.round(counts.P/maxCnt*100);
  return {H,D,P,label:`H ${H}% / D ${D}% / P ${P}%`};
}

function hdpBar(hdp){
  if(!hdp) return '';
  const total = Math.max(hdp.H+hdp.D+hdp.P,1);
  const hPct = Math.round(hdp.H/total*100);
  const dPct = Math.round(hdp.D/total*100);
  const pPct = 100 - hPct - dPct;
  return `
    <div style="display:flex;height:10px;border-radius:999px;overflow:hidden;border:1px solid #243149">
      <div style="flex:${hPct};background:rgba(255,99,132,0.8)" title="H ${hdp.H}%"></div>
      <div style="flex:${dPct};background:rgba(54,162,235,0.8)" title="D ${hdp.D}%"></div>
      <div style="flex:${pPct};background:rgba(255,206,86,0.8)" title="P ${hdp.P}%"></div>
    </div>`;
}


/* ============================================================
   C1~C15 ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜
============================================================ */
const C15_RULES = [
  {code:'C1', name:'ì‚¬ì—…Â·í”„ë¡œì íŠ¸ ê°œìš” & ë°°ê²½', kw:['project','programme','overview','background','context']},
  {code:'C2', name:'ì´í•´ê´€ê³„ì ë¶„ì„', kw:['stakeholder','community','beneficiary','partner','ngo']},
  {code:'C3', name:'ëª©í‘œÂ·ì„±ê³¼ì§€í‘œ(Logframe)', kw:['objective','outcome','output','indicator','logframe']},
  {code:'C4', name:'í™œë™(Activity) ì„¸ë¶€ ë‚´ìš©', kw:['activity','training','workshop','distribution','construction']},
  {code:'C5', name:'ì„±ê³¼ê´€ë¦¬(M&E)Â·ë°ì´í„°', kw:['monitoring','evaluation','baseline','survey','indicator','logframe']},
  {code:'C6', name:'ì¬ì •Â·ì˜ˆì‚°ì§‘í–‰', kw:['budget','finance','funding','expenditure','cost']},
  {code:'C7', name:'ìœ„í—˜Â·ë¦¬ìŠ¤í¬Â·ì œí•œì‚¬í•­', kw:['risk','challenge','constraint','limitation','barrier']},
  {code:'C8', name:'ì§€ì†ê°€ëŠ¥ì„±Â·ì „ëµì  ì—°ê³„', kw:['sustainability','exit strategy','transition','ownership']},
  {code:'C9', name:'ì  ë”Â·ì‚¬íšŒì  ë³´í˜¸', kw:['gender','women','girl','protection','gender-based']},
  {code:'C10', name:'ì¸ë„ì£¼ì˜-ê°œë°œ-í‰í™” ë„¥ì„œìŠ¤', kw:['nexus','triple nexus','humanitarian','development','peace']},
  {code:'C11', name:'ê¸°í›„ë³€í™”Â·í™˜ê²½', kw:['climate','environment','resilience','disaster risk reduction']},
  {code:'C12', name:'ë³´ê±´Â·WASHÂ·ì˜ì–‘', kw:['health','clinic','hospital','wash','water','sanitation','nutrition']},
  {code:'C13', name:'êµìœ¡Â·ìƒê³„Â·ê²½ì œ', kw:['education','school','teacher','livelihood','job','income']},
  {code:'C14', name:'ê±°ë²„ë„ŒìŠ¤Â·ì œë„Â·ì •ì±…', kw:['policy','governance','institution','law','regulation']},
  {code:'C15', name:'ê¸°íƒ€(ë§¥ë½Â·ë¶„ìŸÂ·í‰í™” ë“±)', kw:['conflict','peace','migration','refugee','idp']}
];

function classifyC15(text,maxCount){
  const t = (text || '').toLowerCase();
  let scores = [];
  C15_RULES.forEach(r=>{
    let s=0;
    r.kw.forEach(w=>{ if(t.includes(w)) s++; });
    if(s>0) scores.push({code:r.code,name:r.name,score:s});
  });
  scores.sort((a,b)=>b.score-a.score);
  if(maxCount) scores = scores.slice(0,maxCount);
  return scores;
}

function c15Badges(list){
  if(!list || !list.length) return '';
  return list.map(x=>`<span class="badge">${x.code}</span>`).join(' ');
}


/* ============================================================
   TF-IDF ìš”ì•½ (ê°„ë‹¨ ë²„ì „)
============================================================ */
function tfidfSummary(text,maxSentences){
  maxSentences = maxSentences || 3;
  const sents = text.split(/(?<=[\.!?])\s+/);
  if(sents.length <= maxSentences) return text;

  function tokenize(s){
    return s.toLowerCase()
      .replace(/[^a-z0-9ê°€-í£\s]/g,' ')
      .split(/\s+/).filter(Boolean);
  }

  const stop = new Set(['the','and','for','with','that','this','from','into','about','there','their','have','has','been','will','would','should','could','ë˜ëŠ”','ê·¸ë¦¬ê³ ','í•˜ì§€ë§Œ','ìœ„í•´','ëŒ€í•œ','ì—ì„œ','ìœ¼ë¡œ','ì—ê²Œ','ê¹Œì§€']);

  const tf={}, df={}, sentTokens=[];
  for(let i=0;i<sents.length;i++){
    const ws = tokenize(sents[i]).filter(w=>!stop.has(w));
    sentTokens.push(ws);
    const seen={};
    ws.forEach(w=>{
      tf[w]=(tf[w]||0)+1;
      if(!seen[w]){ df[w]=(df[w]||0)+1; seen[w]=1; }
    });
  }

  const N = sents.length;
  let scored=[];
  for(let i=0;i<sents.length;i++){
    let sc=0;
    sentTokens[i].forEach(w=>{
      const idf = Math.log((N+1)/((df[w]||1)+1));
      sc += (tf[w]||0)*idf;
    });
    scored.push({i,score:sc});
  }

  scored.sort((a,b)=>b.score-a.score);
  scored = scored.slice(0,maxSentences).sort((a,b)=>a.i-b.i);
  return scored.map(x=>sents[x.i]).join(' ');
}


/* ============================================================
   êµ­ê°€ ì…ë ¥: ì´ë¦„ + ISO3 ì •ê·œí™”
============================================================ */
function normalizeCountries(rawList){
  const outName = [];
  const outIso  = [];

  rawList.forEach(item=>{
    const key = item.trim();
    if(!key) return;

    const upper = key.toUpperCase();

    // ISO3 ì½”ë“œë¡œ ì¸ì‹ë˜ëŠ” ê²½ìš°
    if(COUNTRY_MAP[upper]){
      outName.push(COUNTRY_MAP[upper]);
      outIso.push(upper);
      return;
    }

    // ì´ë¦„ ê·¸ëŒ€ë¡œ ë„£ê¸°
    outName.push(key);
  });

  return {outName, outIso};
}


/* ============================================================
   ReliefWeb API ë¶ˆëŸ¬ì˜¤ê¸°
============================================================ */
async function rwFetch(){
  const daySpan   = parseInt(document.getElementById('rw-days').value || '365',10);
  const limit     = parseInt(document.getElementById('rw-limit').value || '300',10);
  const countryRaw= document.getElementById('rw-country').value || '';

  const out = document.getElementById('rw-out');
  const st  = document.getElementById('rw-status');
  const log = document.getElementById('rw-log');

  st.textContent = 'ìš”ì²­ ì¤‘...';
  log.textContent = '';

  /* ReliefWebì€ YYYY-MM-DD í˜•ì‹ ê¶Œì¥ */
  const sinceISO = new Date(Date.now()-daySpan*86400000)
                     .toISOString()
                     .slice(0,10);

  const url = 'https://api.reliefweb.int/v1/reports?appname=' + encodeURIComponent(APPNAME);

  const rawList = countryRaw.split(';').map(s=>s.trim()).filter(Boolean);
  const {outName, outIso} = normalizeCountries(rawList);

  const conditions = [
    {field:'date.created',operator:'gte',value:sinceISO}
  ];

  if(outName.length && outIso.length){
    conditions.push({
      operator:'OR',
      conditions:[
        {field:'country', value:outName},
        {field:'country.iso3', value:outIso}
      ]
    });
  }else if(outName.length){
    conditions.push({field:'country', value:outName});
  }else if(outIso.length){
    conditions.push({field:'country.iso3', value:outIso});
  }

  const body = {
    limit:limit,
    offset:0,
    filter:{operator:'AND',conditions:conditions},
    fields:{include:[
      'id','title','url','body','body-html','country','source',
      'theme','disaster_type','date.created'
    ]},
    sort:['date.created:desc']
  };

  try{
    const res = await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });

    if(!res.ok){
      const txt = await res.text();
      st.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨('+res.status+')';
      log.textContent = 'HTTP '+res.status+' â€” '+txt;
      return;
    }

    const json = await res.json();
    const data = json.data || [];

    st.textContent = 'ì™„ë£Œ ('+data.length+'ê°œ)';

    if(!data.length){
      out.innerHTML = '<div class="small">ì¡°ê±´ì— ë§ëŠ” ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      window._rwItems = [];
      return;
    }

    window._rwItems = data.map(r=>{
      const f = r.fields || {};
      const rawHtml = f['body-html'] || '';
      const cleanBody = (f.body || rawHtml.replace(/<[^>]+>/g,' '));
      const meta = [
        f.title || '',
        (f.country||[]).map(c=>c.name).join(', '),
        (f.source||[]).map(s=>s.name).join(', ')
      ].join(' ');
      const hdp = hdpScore(meta + ' ' + cleanBody);
      const c15 = classifyC15(meta + ' ' + cleanBody,3);
      return {
        id:r.id,
        title:f.title || '',
        url:f.url || '',
        created:f['date.created'] || '',
        country:(f.country||[]).map(c=>c.name).join(', '),
        source:(f.source||[]).map(s=>s.name).join(', '),
        type:(f.disaster_type||[]).map(d=>d.name).join(', '),
        body:cleanBody,
        hdp:hdp,
        c15:c15
      };
    });

    let rows = '';
    window._rwItems.forEach((it,i)=>{
      rows += `
        <tr>
          <td><input type="checkbox" class="rw-check" data-i="${i}"></td>
          <td class="title-cell" style="cursor:pointer;text-decoration:underline">
            ${it.title}
          </td>
          <td>${it.country}</td>
          <td>${it.source}</td>
          <td>${hdpBar(it.hdp)}</td>
          <td>${c15Badges(it.c15)}</td>
          <td><a href="${it.url}" target="_blank" rel="noopener">ë§í¬</a></td>
        </tr>`;
    });

    out.innerHTML = `
      <table>
        <thead>
          <tr>
            <th></th><th>ì œëª©</th><th>êµ­ê°€</th><th>ì¶œì²˜</th>
            <th>HDP%</th><th>C1~C15</th><th>URL</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;

    // ì œëª© í´ë¦­ ì‹œ ì›ë¬¸ í…ìŠ¤íŠ¸ alert
    out.querySelectorAll('.title-cell').forEach(td=>{
      td.onclick = function(){
        const idx = this.parentNode.querySelector('.rw-check').dataset.i;
        const it = window._rwItems[idx];
        alert(it.title + '\n\n' + it.body);
      };
    });

  }catch(e){
    st.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨(fetch)';
    log.textContent = e.message;
  }
}


/* ============================================================
   ë…¸íŠ¸ ì €ì¥
============================================================ */
function saveSelectedNotes(){
  if(!window._rwItems || !window._rwItems.length){
    alert('ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
    return;
  }
  const checks = document.querySelectorAll('.rw-check');
  const db = getDB();
  let added = 0;

  checks.forEach(ch=>{
    if(!ch.checked) return;
    const idx = parseInt(ch.dataset.i,10);
    const it = window._rwItems[idx];
    const note = {
      id:Date.now() + '-' + idx,
      title:it.title,
      url:it.url,
      created:new Date().toISOString(),
      country:it.country,
      source:it.source,
      type:it.type,
      body:it.body,
      summary:tfidfSummary(it.body,3),
      hdp:it.hdp,
      hdpLabel:it.hdp.label,
      c15:it.c15
    };
    db.notes.push(note);
    added++;
  });

  setDB(db);
  renderNotes();
  renderDashboard();
  alert(added + 'ê°œ ë…¸íŠ¸ ì €ì¥ë¨');
}


/* ============================================================
   ëŒ€ì‹œë³´ë“œ (Chart.js)
============================================================ */
let hdpChart, c15Chart;

function renderDashboard(){
  const db = getDB();
  const notes = db.notes || [];

  let Hcnt=0,Dcnt=0,Pcnt=0;
  const agg={};

  notes.forEach(n=>{
    if(n.hdp && n.hdp.H>0) Hcnt++;
    if(n.hdp && n.hdp.D>0) Dcnt++;
    if(n.hdp && n.hdp.P>0) Pcnt++;
    (n.c15||[]).forEach(c=>{ agg[c.code]=(agg[c.code]||0)+1; });
  });

  // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
  if(hdpChart) hdpChart.destroy();
  if(c15Chart) c15Chart.destroy();

  const ctx1 = document.getElementById('hdp-chart').getContext('2d');
  hdpChart = new Chart(ctx1,{
    type:'doughnut',
    data:{labels:['H','D','P'],datasets:[{data:[Hcnt,Dcnt,Pcnt]}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  const labels = Object.keys(agg);
  const vals   = labels.map(k=>agg[k]);

  const ctx2 = document.getElementById('c15-chart').getContext('2d');
  c15Chart = new Chart(ctx2,{
    type:'bar',
    data:{labels:labels,datasets:[{data:vals}]},
    options:{indexAxis:'y',plugins:{legend:{display:false}}}
  });
}


/* ============================================================
   ë…¸íŠ¸ ë¦¬ìŠ¤íŠ¸ ë Œë”
============================================================ */
function renderNotes(filter){
  filter = (filter || '').toLowerCase();
  const box = document.getElementById('notes-list');
  const db = getDB();
  const notes = db.notes || [];

  if(!notes.length){
    box.innerHTML = '<div class="small">ì €ì¥ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  let html='';
  notes.forEach(n=>{
    const hay = [
      n.title,n.summary,n.country,
      n.hdpLabel,(n.c15||[]).map(x=>x.code).join(' ')
    ].join(' ').toLowerCase();
    if(filter && !hay.includes(filter)) return;

    html += `
      <div class="card">
        <div class="flex" style="justify-content:space-between">
          <div><strong>${n.title}</strong></div>
          <div class="small mono">${n.created.slice(0,10)}</div>
        </div>
        <div class="small" style="margin:6px 0">
          <em>${n.country} Â· ${n.source} Â· ${n.type}</em> Â· ${n.hdpLabel}
        </div>
        <div class="small" style="margin:4px 0">${c15Badges(n.c15)}</div>
        <div class="small" style="max-height:5.5em;overflow:hidden;text-overflow:ellipsis;margin-top:4px">
          ${n.summary}
        </div>
        <div class="small" style="margin-top:6px">
          ${n.url?`<a href="${n.url}" target="_blank" rel="noopener">ì›ë¬¸ ë§í¬</a> Â· `:''}
          <a href="#" class="summary-link" data-id="${n.id}">ìš”ì•½ ì „ì²´ ë³´ê¸°</a>
        </div>
      </div>`;
  });

  box.innerHTML = html || '<div class="small">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';

  // ëª¨ë‹¬ ì—´ê¸°
  box.querySelectorAll('.summary-link').forEach(a=>{
    a.onclick = function(e){
      e.preventDefault();
      const id = this.dataset.id;
      const db = getDB();
      const note = db.notes.find(n=>String(n.id)===String(id));
      if(!note) return;
      document.getElementById('summary-title').textContent = note.title;
      document.getElementById('summary-meta').textContent =
        [note.country,note.source,note.type].filter(Boolean).join(' Â· ');
      document.getElementById('summary-body').textContent = note.body || '';
      document.getElementById('summary-modal').style.display = 'flex';
    };
  });
}


/* ============================================================
   ëª¨ë‹¬ ë‹«ê¸°
============================================================ */
function initModal(){
  const modal = document.getElementById('summary-modal');
  const closeBtn = document.getElementById('summary-close');
  closeBtn.onclick = ()=>{ modal.style.display='none'; };
  modal.onclick = e=>{ if(e.target===modal) modal.style.display='none'; };
}


/* ============================================================
   êµ­ê°€ ìë™ì™„ì„± (20ê°œêµ­)
============================================================ */
let suggestBox;  // ì „ì—­ ì°¸ì¡°

function initCountrySuggest(){
  const input = document.getElementById('rw-country');
  suggestBox = document.createElement('div');
  suggestBox.style.position = 'absolute';
  suggestBox.style.background = '#101826';
  suggestBox.style.border = '1px solid #253245';
  suggestBox.style.zIndex = '30';
  suggestBox.style.display = 'none';
  suggestBox.style.maxHeight = '140px';
  suggestBox.style.overflowY = 'auto';
  suggestBox.style.padding = '4px';
  document.body.appendChild(suggestBox);

  function positionSuggestBox(){
    const r = input.getBoundingClientRect();
    suggestBox.style.left = r.left + window.scrollX + 'px';
    suggestBox.style.top  = r.bottom + window.scrollY + 'px';
    suggestBox.style.width= r.width + 'px';
  }

  input.addEventListener('input', function(){
    const v = this.value.split(';').pop().trim();
    if(v.length < 2){
      suggestBox.style.display = 'none';
      return;
    }
    const matches = COUNTRY_LIST
      .filter(c => c.toLowerCase().includes(v.toLowerCase()))
      .slice(0,10);

    if(!matches.length){
      suggestBox.style.display = 'none';
      return;
    }

    suggestBox.innerHTML = matches.map(c=>
      `<div class="small" style="padding:4px;cursor:pointer">${c}</div>`
    ).join('');

    positionSuggestBox();
    suggestBox.style.display = 'block';

    Array.from(suggestBox.children).forEach(item=>{
      item.onclick = ()=>{
        const parts = input.value.split(';').map(s=>s.trim()).filter(Boolean);
        parts[parts.length-1] = item.textContent;
        input.value = parts.join('; ') + '; ';
        suggestBox.style.display = 'none';
      };
    });
  });

  document.addEventListener('click', e=>{
    if(e.target!==input) suggestBox.style.display = 'none';
  });
}


/* ============================================================
   ë…¸íŠ¸ CSV(Excel) ë‹¤ìš´ë¡œë“œ
============================================================ */
function exportNotesCSV(){
  const db = getDB();
  const notes = db.notes || [];
  if(!notes.length){
    alert('ì €ì¥ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  let csv = "Title,Country,Source,HDP_H,HDP_D,HDP_P,C15,Summary,URL,Created\n";
  notes.forEach(n=>{
    csv += [
      `"${(n.title||'').replace(/"/g,'""')}"`,
      `"${(n.country||'').replace(/"/g,'""')}"`,
      `"${(n.source||'').replace(/"/g,'""')}"`,
      n.hdp ? n.hdp.H : '',
      n.hdp ? n.hdp.D : '',
      n.hdp ? n.hdp.P : '',
      `"${(n.c15||[]).map(c=>c.code).join('; ').replace(/"/g,'""')}"`,
      `"${(n.summary||'').replace(/"/g,'""')}"`,
      `"${(n.url||'').replace(/"/g,'""')}"`,
      `"${(n.created||'').slice(0,10)}"`
    ].join(',') + "\n";
  });

  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'km-lite-notes.csv';
  a.click();
  URL.revokeObjectURL(url);
}


/* ============================================================
   ì´ˆê¸°í™”
============================================================ */
window.onload = function(){
  document.getElementById('rw-fetch').onclick = rwFetch;
  document.getElementById('rw-save-selected').onclick = saveSelectedNotes;
  document.getElementById('notes-refresh').onclick = function(){
    renderNotes(document.getElementById('notes-q').value);
    renderDashboard();
  };
  document.getElementById('notes-clear').onclick = function(){
    if(!confirm('ëª¨ë“  ì €ì¥ëœ ë…¸íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) return;
    setDB({notes:[]});
    renderNotes('');
    renderDashboard();
  };
  document.getElementById('notes-q').oninput = function(e){
    renderNotes(e.target.value);
  };
  document.getElementById('notes-export').onclick = exportNotesCSV;

  initModal();
  initCountrySuggest();
  renderNotes('');
  renderDashboard();
};
</script>
</body>
</html>
